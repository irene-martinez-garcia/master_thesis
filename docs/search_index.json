[["index.html", "AlberdiLab | Comparative metagenomics MSc project Chapter 1 Introduction 1.1 Prepare the R environment", " AlberdiLab | Comparative metagenomics MSc project Irene Martínez, M Thomas P Gilbert, Antton Alberdi1 Last update: 2026-01-28 Chapter 1 Introduction This webbook contains all the code used for data analysis for the comparative metagenomics analysis of gut microbiome bacterial species in several vertebrates. 1.1 Prepare the R environment 1.1.1 Environment To reproduce all the analyses locally, clone this repository in your computer using: RStudio &gt; New Project &gt; Version Control &gt; Git And indicating the following git repository: https://github.com/irene-martinez-garcia/master_thesis.git Once the R project has been created, follow the instructions and code chunks shown in this webbook. 1.1.2 Libraries The following R packages are required for the data analysis. # Base library(R.utils) library(knitr) library(tidyverse) #library(devtools) library(tinytable) library(rairtable) library(janitor) library(broom) # For tree handling library(ape) library(phyloseq) library(phytools) # For plotting library(ggplot2) library(ggrepel) library(ggpubr) library(ggnewscale) library(gridExtra) library(ggtreeExtra) library(ggtree) library(ggh4x) library(UpSetR) library(viridis) # For statistics library(spaa) library(vegan) library(Rtsne) library(geiger) library(distillR) library(ANCOMBC) library(lme4) library(nlme) library(pairwiseAdonis) library(emmeans) library(pheatmap) library(rstatix) library(uwot) University of Copenhagen, antton.alberdi@sund.ku.dk↩︎ "],["data-preparation-human.html", "Chapter 2 Data preparation (HUMAN) 2.1 Searching for the MAGs 2.2 Downloading the MAGs and generating data 2.3 R Studio- Data Analysis 2.4 Wrap working objects", " Chapter 2 Data preparation (HUMAN) MAKING SURE THAT THE MAGS FROM GTDB ARE HUMAN 2.1 Searching for the MAGs Choose the MAGs In this case, we will be working with Parabacteroides distasonis and Phocaeicola vulgatus. In the EHI database, select the MAGs with &gt; 90% completeness and &lt; 2.5 contamination. Do the same in the GTDB, but also filter for isolation source CONTAINS human. 2.2 Downloading the MAGs and generating data Download genome indices and metadata Download the EHI_MAG index for each species (in /data/mags_metadata folder) and the curl file and search metadata tsv from the GTDB and place in each species directory in Mjolnir. 2.5) Extract genome metadata - Use the GTDB search tsv to run this script to obtain more metadata. (modify script a bit to make it scalable). python scripts/extract_gtdb_metadata.py Create the master index Run the create_index.R script to create an index of all the MAGs and the download paths (needs a list of species as input and right now it is hardcoded in the script) conda activate mags_r_env Rscript scripts/create_index.R Run the downloading_mags.smk to download all the genomes snakemake -s snakefiles/downloading_mags.smk \\ --executor slurm \\ --jobs 50 \\ --rerun-incomplete \\ --keep-going #testing with the HUMAN_EHI snakemake -s snakefiles/downloading_and_unzipping.smk \\ --executor slurm \\ --jobs 50 \\ --rerun-incomplete \\ --keep-going Unzip all the MAGs and make sure they are in the same folder: run (maybe add this to the downloading_mags.smk) bash scripts/unzip_mags.sh parabacteroides_distasonis bash scripts/unzip_mags.sh phocaeicola_vulgatus Make a screen session for each species. screen -S parabacteroides_distasonis Run drakkar annotating_function.smk to re-annotate all the MAGs: drakkar annotating -b /maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis/mags/unzipped -o /maps/projects/alberdilab/people/pjq449/comparative_metagenomics --env_path /projects/alberdilab/data/environments/drakkar --annotation-type function Annotate with prokka and make phylogenetic tree with getphylo snakemake -s snakefiles/prokka_and_pangenome.smk --profile snakefiles/slurm_profile Run genome_mapping.sh to map the mag ids to the corresponding names bash scripts/genome_mapping.sh #dont think we need this now Run drep sbatch scripts/drep_compare.slurm Run create_pangolin_input.R to create the input file ppanggolin needs conda activate mags_r_env Rscript scripts/create_pangolin_input.R #or if we want to use the annotation files by prokka: Rscript scripts/create_pangolin_input_gff.R Pangenome analysis with ppanggolin conda activate ppanggolin ppanggolin all --fasta /maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis_HUMAN_EHI/ppanggolin_input.tsv 2.3 R Studio- Data Analysis 2.3.1 EHI MAGs ehi_mags &lt;- read_csv(&quot;data/ehi_mags.csv&quot;) Rows: 8846 Columns: 52 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, c... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, c... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.3.2 Prepare color scheme AlberdiLab projects use unified color schemes developed for the Earth Hologenome Initiative, to facilitate figure interpretation. ehi_mags_p &lt;- ehi_mags %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(ehi_mags_p, by=join_by(phylum == phylum)) %&gt;% dplyr::select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% pull(colors, name=phylum) #source_colors &lt;- c(EHI = &quot;#8BC63F&quot;, GTDB = &quot;#2D522D&quot;) source_colors_human &lt;- c(EHI = &quot;#8BC63F&quot;, GTDB = &quot;#A90D00&quot;) 2.3.3 Sample metadata gtdb_search_metadata &lt;- read_tsv(&quot;data/human/gtdb_search_results.tsv&quot;) Warning: One or more parsing issues, call `problems()` on your data frame for details, e.g.: dat &lt;- vroom(...) problems(dat) Rows: 47 Columns: 10 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (7): Accession, Organism Name, NCBI Taxonomy, GTDB Taxonomy, GTDB Type Material, Isolation Source, Isolat... dbl (2): CheckM2 Completeness, CheckM Contamination lgl (1): GTDB Representative of Species ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. colnames(gtdb_search_metadata) [1] &quot;Accession&quot; &quot;Organism Name&quot; &quot;NCBI Taxonomy&quot; [4] &quot;GTDB Taxonomy&quot; &quot;GTDB Representative of Species&quot; &quot;GTDB Type Material&quot; [7] &quot;CheckM2 Completeness&quot; &quot;CheckM Contamination&quot; &quot;Isolation Source&quot; [10] &quot;Isolation Source_2&quot; gtdb_accession_metadata&lt;- read_tsv(&quot;data/human/parabacteroides_distasonis_human_GTDB_accession_metadata.tsv&quot;) Rows: 47 Columns: 115 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (69): accession, checkm2_model, checkm_marker_lineage, gtdb_genome_representative, gtdb_taxonomy, gtdb_t... dbl (39): ambiguous_bases, checkm2_completeness, checkm2_contamination, checkm_completeness, checkm_contamin... lgl (5): gtdb_representative, gtdb_type_species_of_genus, mimag_high_quality, mimag_low_quality, mimag_medi... date (2): ncbi_date, ncbi_seq_rel_date ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. ehi_metadata &lt;- read_tsv(&quot;data/mags_metadata/parabacteroides_distasonis_metadata.tsv&quot;) %&gt;% mutate(GC = as.numeric(str_remove(GC, &quot;%&quot;))) Rows: 25 Columns: 54 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (38): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, c... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, c... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.3.4 Load genome mapping # Prepare EHI metadata with standardized column names ehi_clean &lt;- ehi_metadata %&gt;% dplyr::select( ID, species, completeness, contamination, genome_size = size, GC, N50, contigs, host_species, host_order, host_class, assembly_type, isolation_source= sample_type, mag_name, eha_number ) %&gt;% mutate(source = &quot;EHI&quot;) # Prepare GTDB metadata # Join search and accession metadata gtdb_metadata &lt;- full_join(gtdb_accession_metadata, gtdb_search_metadata, by = c(&quot;search_accession&quot; = &quot;Accession&quot;) ) # Prepare GTDB metadata gtdb_clean &lt;- gtdb_metadata %&gt;% dplyr::select( ID = search_accession, completeness = &quot;checkm2_completeness&quot;, contamination = &quot;checkm2_contamination&quot;, gtdb_taxonomy = &quot;GTDB Taxonomy&quot;, isolation_source = &quot;Isolation Source&quot;, genome_size, GC = gc_percentage, N50 = n50_contigs, contigs = contig_count, ncbi_country, mimag_high_quality, mimag_medium_quality, gtdb_representative, mag_name = search_accession )%&gt;% mutate(source = &quot;GTDB&quot;) #Join genome_metadata &lt;- bind_rows(ehi_clean, gtdb_clean) # Read master index master_index &lt;- read_tsv(&quot;data/human/master_mag_index_2.tsv&quot;) %&gt;% filter(species == &quot;parabacteroides_distasonis&quot;) %&gt;% mutate( # Extract the actual genome identifier from out_path genome_identifier = case_when( # For EHI: extract EHA00531_bin.1 from the filename str_detect(out_path, &quot;EHA&quot;) ~ str_extract(out_path, &quot;EHA[0-9]+_bin\\\\.[0-9]+&quot;), # For NCBI: use the ID as is (GCA/GCF number) TRUE ~ ID ) ) Rows: 72 Columns: 4 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (4): species, ID, MAG_url, out_path ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. # Check the mapping print(&quot;Master index mapping:&quot;) [1] &quot;Master index mapping:&quot; master_index %&gt;% dplyr::select(ID, genome_identifier, out_path) %&gt;% head(10) %&gt;% print() # A tibble: 0 × 3 # ℹ 3 variables: ID &lt;chr&gt;, genome_identifier &lt;chr&gt;, out_path &lt;chr&gt; # Read contig-to-genome mapping contig_to_genome &lt;- read_tsv(&quot;data/human/contig_to_mag.tsv&quot;, col_names = c(&quot;contig&quot;, &quot;genome_filename&quot;)) Rows: 10094 Columns: 2 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (2): contig, genome_filename ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.3.5 Genome annotations genome_annotations &lt;-read_tsv(&quot;data/human/gene_annotations_human.tsv.xz&quot;) Warning: One or more parsing issues, call `problems()` on your data frame for details, e.g.: dat &lt;- vroom(...) problems(dat) Rows: 275277 Columns: 13 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (11): gene, strand, kegg, ec, pfam, cazy, resistance_type, resistance_target, vf, vf_type, signalp dbl (2): start, end ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. # Read annotations and add IDs genome_annotations &lt;- read_tsv(&quot;data/human/gene_annotations_human.tsv.xz&quot;) %&gt;% mutate(contig = sub(&quot;_[^_]*$&quot;, &quot;&quot;, gene)) %&gt;% left_join(contig_to_genome, by = &quot;contig&quot;) %&gt;% mutate(genome= genome_filename)%&gt;% filter(!is.na(genome)) Warning: One or more parsing issues, call `problems()` on your data frame for details, e.g.: dat &lt;- vroom(...) problems(dat) Rows: 275277 Columns: 13 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (11): gene, strand, kegg, ec, pfam, cazy, resistance_type, resistance_target, vf, vf_type, signalp dbl (2): start, end ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.3.6 Distill annotations into GIFTs genome_gifts &lt;- distill(genome_annotations,GIFT_db,genomecol= 15, annotcol=c(5,6,7,8), verbosity = T) 2.3.7 Load trees genome_metadata$mag_name &lt;- sub(&quot;\\\\.fa$&quot;, &quot;&quot;, genome_metadata$mag_name)#remove .fa from the mag names so that they match the tree ids getphylo_tree &lt;- read_tree(&quot;data/combined_alignment.tree&quot;) getphylo_tree$tip.label &lt;- gsub(&quot;&#39;&quot;, &quot;&quot;, getphylo_tree$tip.label) tip_df &lt;- data.frame(label = getphylo_tree$tip.label) %&gt;% left_join(genome_metadata, by = c(&quot;label&quot; = &quot;mag_name&quot;)) #replace long mag names with IDs getphylo_tree$tip.label &lt;- tip_df$ID 2.4 Wrap working objects All working objects are wrapped into a single Rdata object to facilitate downstream usage. save(ehi_mags, phylum_colors, genome_annotations, genome_gifts, contig_to_genome, gtdb_metadata, ehi_metadata, master_index, genome_metadata, source_colors, getphylo_tree, file = &quot;data/human/data.Rdata&quot;) "],["ehi-mags-exploration.html", "Chapter 3 EHI MAGs exploration", " Chapter 3 EHI MAGs exploration 3.0.1 EHI MAGs load(&quot;data/data.Rdata&quot;) ehi_mags &lt;- read_csv(&quot;data/ehi_metadata_location.csv&quot;) Rows: 8857 Columns: 54 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (38): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, c... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, c... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. colnames(ehi_mags) [1] &quot;ID&quot; &quot;mag_name&quot; &quot;link_to_assembly&quot; [4] &quot;AB_batch&quot; &quot;eha_number&quot; &quot;GTDB_version&quot; [7] &quot;GTDB_release&quot; &quot;domain&quot; &quot;phylum&quot; [10] &quot;class&quot; &quot;order&quot; &quot;family&quot; [13] &quot;genus&quot; &quot;species&quot; &quot;fastani_ani&quot; [16] &quot;closest_placement_ani&quot; &quot;closest_placement_af&quot; &quot;completeness&quot; [19] &quot;contamination&quot; &quot;size&quot; &quot;GC&quot; [22] &quot;N50&quot; &quot;coding_density&quot; &quot;contigs&quot; [25] &quot;number_genes&quot; &quot;number_unannotated_genes&quot; &quot;DM_batch&quot; [28] &quot;host_species&quot; &quot;host_order&quot; &quot;host_class&quot; [31] &quot;locality&quot; &quot;country&quot; &quot;MAG_url&quot; [34] &quot;anno_url&quot; &quot;kegg_url&quot; &quot;annotated&quot; [37] &quot;taxonomy_level&quot; &quot;assembly_type&quot; &quot;sample_type&quot; [40] &quot;gbk_url&quot; &quot;kegg_hits&quot; &quot;Capture ID&quot; [43] &quot;percent_unannotated_genes&quot; &quot;percent_unannotated_kegg&quot; &quot;dereplicated&quot; [46] &quot;metagenomic source&quot; &quot;completeness software&quot; &quot;binning software&quot; [49] &quot;assembly quality&quot; &quot;binning parameters&quot; &quot;taxonomic identity marker&quot; [52] &quot;isolation_source&quot; &quot;assembly software&quot; &quot;Submission&quot; Check contamination and completeness genome_biplot &lt;- ehi_mags %&gt;% dplyr::select(c(phylum,completeness,contamination,size)) %&gt;% ggplot(aes(x=completeness,y=contamination,size=size,color=phylum)) + geom_point(alpha=0.7) + xlim(c(70,100)) + ylim(c(10,0)) + scale_color_manual(values=phylum_colors) + labs(y= &quot;Contamination&quot;, x = &quot;Completeness&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;) #Generate contamination boxplot genome_contamination &lt;- ehi_mags %&gt;% ggplot(aes(y=contamination)) + ylim(c(10,0)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0.40, 0),&quot;inches&quot;)) #add bottom-margin (top, right, bottom, left) genome_completeness &lt;- ehi_mags %&gt;% ggplot(aes(x=completeness)) + xlim(c(70,100)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0, 0.50),&quot;inches&quot;)) #add left-margin (top, right, bottom, left) #Render composite figure #pdf(&quot;figures/completeness_contamination.pdf&quot;,width=10, height=5) grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination), layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3))) Warning: Removed 1725 rows containing non-finite outside the scale range (`stat_boxplot()`). Warning: No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. Warning: Removed 1725 rows containing missing values or values outside the scale range (`geom_point()`). Warning: Removed 1 row containing non-finite outside the scale range (`stat_boxplot()`). Filter by completeness and contamination ehi_mags_filtered &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5) 3.0.2 Host classes species_hostclass_counts &lt;- ehi_mags_filtered %&gt;% filter(!is.na(species), species != &quot;&quot;) %&gt;% filter(!is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_mags = n(), n_host_classes = n_distinct(host_class), n_host_species = n_distinct(host_species), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), host_species = paste(sort(unique(host_species)), collapse = &quot;, &quot;), phylum = paste(unique(phylum), collapse = &quot;, &quot;) ) %&gt;% arrange(desc(n_host_classes)) species_selection_3 &lt;- species_hostclass_counts %&gt;% filter(n_host_classes &gt;= 3) species_selection_2 &lt;- species_hostclass_counts %&gt;% filter(n_host_classes &gt;= 2) species_selection_3 %&gt;% arrange(-n_mags) # A tibble: 14 × 7 species n_mags n_host_classes n_host_species host_classes host_species phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Escherichia coli 64 3 20 Aves, Mammalia, Reptil… Apodemus fl… p__Ps… 2 s__Pseudomonas aeruginosa 55 4 25 Amphibia, Aves, Mammal… Chloroceryl… p__Ps… 3 s__Lactococcus lactis 38 3 13 Aves, Mammalia, Reptil… Barbastella… p__Ba… 4 s__Hafnia paralvei 25 3 10 Amphibia, Mammalia, Re… Anguis frag… p__Ps… 5 s__Parabacteroides distasonis 25 3 10 Aves, Mammalia, Reptil… Canis famil… p__Ba… 6 s__Enterococcus faecalis 21 3 11 Aves, Mammalia, Reptil… Dasyurus ge… p__Ba… 7 s__Bacteroides uniformis 19 3 5 Aves, Mammalia, Reptil… Canis famil… p__Ba… 8 s__Phocaeicola vulgatus 19 3 7 Aves, Mammalia, Reptil… Canis famil… p__Ba… 9 s__Citrobacter braakii 16 3 9 Amphibia, Mammalia, Re… Chalcides s… p__Ps… 10 s__Moellerella wisconsensis 13 3 5 Amphibia, Aves, Mammal… Geospizopsi… p__Ps… 11 s__Enterococcus_B pernyi 8 3 5 Aves, Mammalia, Reptil… Miniopterus… p__Ba… 12 s__Buttiauxella gaviniae 7 3 3 Amphibia, Mammalia, Re… Lissotriton… p__Ps… 13 s__Morganella morganii_A 7 3 4 Amphibia, Mammalia, Re… Dasyurus ge… p__Ps… 14 s__Aeromonas encheleia 4 3 3 Amphibia, Mammalia, Re… Lissotriton… p__Ps… species_selection_2 %&gt;% arrange(-n_mags) # A tibble: 63 × 7 species n_mags n_host_classes n_host_species host_classes host_species phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Escherichia coli 64 3 20 Aves, Mammalia, Repti… Apodemus fl… p__Ps… 2 s__Pseudomonas aeruginosa 55 4 25 Amphibia, Aves, Mamma… Chloroceryl… p__Ps… 3 s__Helicobacter_C marmotae 48 2 3 Aves, Mammalia Falco eleon… p__Ca… 4 s__Lactococcus lactis 38 3 13 Aves, Mammalia, Repti… Barbastella… p__Ba… 5 s__Hafnia paralvei 25 3 10 Amphibia, Mammalia, R… Anguis frag… p__Ps… 6 s__Parabacteroides distasonis 25 3 10 Aves, Mammalia, Repti… Canis famil… p__Ba… 7 s__Enterococcus faecalis 21 3 11 Aves, Mammalia, Repti… Dasyurus ge… p__Ba… 8 s__Bacteroides uniformis 19 3 5 Aves, Mammalia, Repti… Canis famil… p__Ba… 9 s__Phocaeicola vulgatus 19 3 7 Aves, Mammalia, Repti… Canis famil… p__Ba… 10 s__Parabacteroides goldsteinii 17 2 8 Mammalia, Reptilia Lepus europ… p__Ba… # ℹ 53 more rows species_selection_2 %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 7 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 13 2 p__Bacillota_A 8 3 p__Bacteroidota 14 4 p__Campylobacterota 1 5 p__Fusobacteriota 1 6 p__Pseudomonadota 25 7 p__Verrucomicrobiota 1 species_selection_3 %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 3 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 3 2 p__Bacteroidota 3 3 p__Pseudomonadota 8 3.0.3 Host classes- after filtering species_selection_f &lt;- species_selection_2 %&gt;% dplyr::filter(n_mags &gt; 10) %&gt;% arrange(desc(n_mags)) species_selection_f # A tibble: 22 × 7 species n_mags n_host_classes n_host_species host_classes host_species phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Escherichia coli 64 3 20 Aves, Mammalia, Repti… Apodemus fl… p__Ps… 2 s__Pseudomonas aeruginosa 55 4 25 Amphibia, Aves, Mamma… Chloroceryl… p__Ps… 3 s__Helicobacter_C marmotae 48 2 3 Aves, Mammalia Falco eleon… p__Ca… 4 s__Lactococcus lactis 38 3 13 Aves, Mammalia, Repti… Barbastella… p__Ba… 5 s__Hafnia paralvei 25 3 10 Amphibia, Mammalia, R… Anguis frag… p__Ps… 6 s__Parabacteroides distasonis 25 3 10 Aves, Mammalia, Repti… Canis famil… p__Ba… 7 s__Enterococcus faecalis 21 3 11 Aves, Mammalia, Repti… Dasyurus ge… p__Ba… 8 s__Bacteroides uniformis 19 3 5 Aves, Mammalia, Repti… Canis famil… p__Ba… 9 s__Phocaeicola vulgatus 19 3 7 Aves, Mammalia, Repti… Canis famil… p__Ba… 10 s__Parabacteroides goldsteinii 17 2 8 Mammalia, Reptilia Lepus europ… p__Ba… # ℹ 12 more rows species_selection_list&lt;- species_selection_f %&gt;% pull(species) species_selection_f %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 7 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 4 2 p__Bacillota_A 2 3 p__Bacteroidota 4 4 p__Campylobacterota 1 5 p__Fusobacteriota 1 6 p__Pseudomonadota 9 7 p__Verrucomicrobiota 1 3.0.4 Count host classes per species counts_species_per_class&lt;- species_selection_f %&gt;% group_by(n_host_classes)%&gt;% summarize(n_species = n()) ggplot(counts_species_per_class, aes(x = n_host_classes, y = n_species)) + geom_col() + geom_text( aes(label = n_species), vjust = -0.3, size = 4 ) + labs( title = &quot;Number of Species per Number of Host Classes&quot;, x = &quot;Number of Host Classes&quot;, y = &quot;Number of Species&quot; ) + theme_bw() mags_with_counts &lt;- ehi_mags_filtered %&gt;% left_join(species_hostclass_counts, by = &quot;species&quot;) #filter for mags with &gt;1 host class mags_host2 &lt;- mags_with_counts %&gt;% dplyr::filter(n_host_classes &gt;= 2) n_mags &lt;- mags_host2 %&gt;% group_by(species) %&gt;% summarise(n_mags = n(), .groups = &quot;drop&quot;) We have several MAGs per species, so here we select the “best MAG” (highest completeness and lowest contamination), to have statistics based on the best of each. best_mag_per_species &lt;- mags_host2 %&gt;% group_by(species) %&gt;% arrange(desc(completeness), contamination) %&gt;% slice_head(n = 1) %&gt;% ungroup() %&gt;% transmute( species, best_mag_name = mag_name, best_MAG_link = link_to_assembly, best_genome_size = size, best_completeness = completeness, best_contamination = contamination, best_N50 = N50, best_host_classes = host_class, best_assembly_type = assembly_type, best_phylum =str_remove_all(phylum.x, &quot;p__&quot;)) ggplot(best_mag_per_species, aes(x= species, y = best_genome_size, fill = best_phylum))+ scale_color_manual(values=phylum_colors) + scale_fill_manual(values=phylum_colors) + geom_col()+ theme_bw()+ theme(axis.text.x = element_text(angle = 90)) Warning: No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. Filtering for Parabacteroides distasonis (make into a loop for all the relevant species later) p_dist &lt;- ehi_mags %&gt;% filter(completeness &gt;90, contamination &lt; 2.5, species == &quot;s__Parabacteroides distasonis&quot;) write_tsv(p_dist, &quot;data/mags_metadata/parabacteroides_distasonis_metadata.tsv&quot;) p_dist_index &lt;- p_dist %&gt;% dplyr::select(ID, MAG_url) write_tsv(p_dist_index, &quot;data/mags_metadata/parabacteroides_distasonis_index.tsv&quot;) #Loop through each species in species_selection list for (i in 1:nrow(species_selection_f)) { current_species &lt;- species_selection_f$species[i] #Filter for completeness and contamination #get metadata species_data &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5, species == current_species) #get index species_index &lt;- species_data %&gt;% dplyr::select(ID, MAG_url) #Filename from species name filename &lt;- current_species %&gt;% str_replace(&quot;s__&quot;, &quot;&quot;) %&gt;% str_replace_all(&quot; &quot;, &quot;_&quot;) %&gt;% tolower() #export to tsv write_tsv(species_data, paste0(&quot;data/mags_metadata/&quot;, filename, &quot;_metadata.tsv&quot;)) write_tsv(species_index, paste0(&quot;data/mags_metadata/&quot;, filename, &quot;_index.tsv&quot;)) } ### First only with two: all_mags &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5, species %in% c(&quot;s__Parabacteroides distasonis&quot;, &quot;s__Phocaeicola vulgatus&quot;)) %&gt;% mutate(species = str_remove(species, &quot;^s__&quot;) %&gt;% str_to_lower() %&gt;% str_replace(&quot; &quot;, &quot;_&quot;), out_path = paste0(&quot;data/&quot;, species, &quot;/mags/&quot;, basename(MAG_url)) ) %&gt;% dplyr::select(species, ID, MAG_url, out_path) write_tsv(all_mags, &quot;all_mags_index.tsv&quot;) "],["ncbi-mags-exploration.html", "Chapter 4 NCBI MAGs exploration 4.1 NCBI MAGs metadata 4.2 Downloading the MAGs after filtering", " Chapter 4 NCBI MAGs exploration 4.1 NCBI MAGs metadata Download metadata for each taxa # Trying to download ncbi metadata for mags conda activate drakkar_env conda install -c conda-forge ncbi-datasets-cli ## CITROBACTER BRAAKII datasets summary genome taxon 57706 \\ --as-json-lines &gt; genomes.jsonl #filtering by contamination and completeness jq -c &#39; select( .checkm_info.completeness &gt;= 90 and .checkm_info.contamination &lt;= 2.5 ) &#39; genomes.jsonl &gt; high_quality_genomes.jsonl #put metadata in tsv jq -r &#39; .accession as $asm | .assembly_info.biosample.attributes[]? | [$asm, .name, .value] | @tsv &#39; high_quality_genomes.jsonl &gt; biosample_attributes.tsv 4.1.1 Citrobacter braakii c_braki_metadata &lt;- read_tsv(&quot;data/ncbi/c_braakii_biosample_attributes.tsv&quot;, col_names = c(&quot;assembly&quot;, &quot;attribute&quot;, &quot;value&quot;)) Rows: 1496 Columns: 3 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (3): assembly, attribute, value ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. metadata_wide &lt;- c_braki_metadata %&gt;% pivot_wider( id_cols = assembly, names_from = attribute, values_from = value, values_fn = function(x) x[1] ) source_counts &lt;- metadata_wide %&gt;% filter(!is.na(isolation_source)) %&gt;% dplyr::count(isolation_source, sort = TRUE) source_counts # A tibble: 29 × 2 isolation_source n &lt;chr&gt; &lt;int&gt; 1 food 24 2 rectal swab 14 3 blood 12 4 urine 10 5 Pooled sediment sample collected from floor of pig farm 8 6 Popliteal lymph node of steer 8 7 faecal 8 8 Pooled sediment sample collected from floor of cattle farm 6 9 missing 6 10 sputum 6 # ℹ 19 more rows host_counts &lt;- metadata_wide %&gt;% filter(!is.na(host)) %&gt;% dplyr::count(host, sort = TRUE) host_counts # A tibble: 12 × 2 host n &lt;chr&gt; &lt;int&gt; 1 Homo sapiens 64 2 cow 8 3 Bos taurus 4 4 Sus scrofa cristatus 4 5 Canis lupus familiaris 2 6 Curlew Sandpiper 2 7 European rook 2 8 Milvus milvus 2 9 environmental 2 10 missing 2 11 not available 2 12 pig 2 metadata_wide %&gt;% filter(host == &quot;Homo sapiens&quot;) # A tibble: 64 × 56 assembly isolation_source `ontological term` ifsac_category source_type collected_by collection_date &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 GCF_001062165.1 missing &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; UW clinical la… Unknown 2 GCF_002073755.2 blood &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; George Washing… 2014-10-24 3 GCF_012952645.1 urine &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; University of … 2017 4 GCF_013267145.1 clinical isolate &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; University of … Unknown 5 GCF_016501405.1 sputum &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; University of … 2019 6 GCF_016501525.1 urine &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; University of … 2019 7 GCF_016501755.1 tissue &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; University of … 2019 8 GCF_016501785.1 urine &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; University of … 2018 9 GCF_016501885.1 sputum &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; University of … 2019 10 GCF_016501905.1 blood &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; University of … 2018 # ℹ 54 more rows # ℹ 49 more variables: geo_loc_name &lt;chr&gt;, isolate_name_alias &lt;chr&gt;, lat_lon &lt;chr&gt;, strain &lt;chr&gt;, # PublicAccession &lt;chr&gt;, Species &lt;chr&gt;, Genus &lt;chr&gt;, project_name &lt;chr&gt;, sequenced_by &lt;chr&gt;, # sample_type &lt;chr&gt;, host &lt;chr&gt;, host_disease &lt;chr&gt;, note &lt;chr&gt;, `identification method` &lt;chr&gt;, # host_sex &lt;chr&gt;, host_age &lt;chr&gt;, culture_collection &lt;chr&gt;, isolate &lt;chr&gt;, host_disease_outcome &lt;chr&gt;, # host_health_state &lt;chr&gt;, host_description &lt;chr&gt;, host_disease_stage &lt;chr&gt;, study_id &lt;chr&gt;, # biomaterial_provider &lt;chr&gt;, env_broad_scale &lt;chr&gt;, `Tax ID` &lt;chr&gt;, host_tissue_sampled &lt;chr&gt;, temp &lt;chr&gt;, … 4.1.2 Lactococcus lactis ## LACTOCOCCUS LACTIS datasets summary genome taxon 1358 \\ --as-json-lines &gt; lactococcus_genomes.jsonl #filtering by contamination and completeness jq -c &#39; select( .checkm_info.completeness &gt;= 90 and .checkm_info.contamination &lt;= 2.5 ) &#39; lactococcus_genomes.jsonl &gt; lactococcus_high_quality_genomes.jsonl #put metadata in tsv jq -r &#39; .accession as $asm | .assembly_info.biosample.attributes[]? | [$asm, .name, .value] | @tsv &#39; lactococcus_high_quality_genomes.jsonl &gt; lactococcus_biosample_attributes.tsv lactococcus_metadata &lt;- read_tsv(&quot;data/ncbi/lactococcus_biosample_attributes.tsv&quot;, col_names = c(&quot;assembly&quot;, &quot;attribute&quot;, &quot;value&quot;)) metadata_wide &lt;- lactococcus_metadata %&gt;% pivot_wider( id_cols = assembly, names_from = attribute, values_from = value, values_fn = function(x) x[1] ) source_counts &lt;- metadata_wide %&gt;% filter(!is.na(isolation_source)) %&gt;% dplyr::count(isolation_source, sort = TRUE) source_counts host_counts &lt;- metadata_wide %&gt;% filter(!is.na(host)) %&gt;% dplyr::count(host, sort = TRUE) host_counts metadata_wide %&gt;% filter(host == &quot;Homo sapiens&quot; | str_detect(isolation_source, &quot;human&quot;)) 4.1.3 Hafnia paralvei ## HAFNIA PARALVEI datasets summary genome taxon 546367 \\ --as-json-lines &gt; hafnia_genomes.jsonl #filtering by contamination and completeness jq -c &#39; select( .checkm_info.completeness &gt;= 90 and .checkm_info.contamination &lt;= 2.5 ) &#39; hafnia_genomes.jsonl &gt; hafnia_high_quality_genomes.jsonl #put metadata in tsv jq -r &#39; .accession as $asm | .assembly_info.biosample.attributes[]? | [$asm, .name, .value] | @tsv &#39; hafnia_high_quality_genomes.jsonl &gt; hafnia_biosample_attributes.tsv hafnia_metadata &lt;- read_tsv(&quot;data/ncbi/hafnia_biosample_attributes.tsv&quot;, col_names = c(&quot;assembly&quot;, &quot;attribute&quot;, &quot;value&quot;)) Rows: 1454 Columns: 3 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (3): assembly, attribute, value ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. metadata_wide &lt;- hafnia_metadata %&gt;% pivot_wider( id_cols = assembly, names_from = attribute, values_from = value, values_fn = function(x) x[1] ) source_counts &lt;- metadata_wide %&gt;% filter(!is.na(isolation_source)) %&gt;% dplyr::count(isolation_source, sort = TRUE) source_counts # A tibble: 27 × 2 isolation_source n &lt;chr&gt; &lt;int&gt; 1 missing 22 2 pitcher plants 12 3 fish 10 4 human feces metagenome 8 5 bacterial strain isolated from fresh salmon 6 6 urine 6 7 Phyllosphere 4 8 feces 4 9 not applicable 4 10 Cheese after GESM assay 2 # ℹ 17 more rows host_counts &lt;- metadata_wide %&gt;% filter(!is.na(host)) %&gt;% dplyr::count(host, sort = TRUE) host_counts # A tibble: 10 × 2 host n &lt;chr&gt; &lt;int&gt; 1 Homo sapiens 24 2 Sarracenia 12 3 Bovine 2 4 Brassica rapa var. parachinensis 2 5 Cyprinus carpio 2 6 Gallus gallus 2 7 Mammuthus primigenius 2 8 Scophthalmus maximus 2 9 missing 2 10 wild bird 2 metadata_wide %&gt;% filter(host == &quot;Homo sapiens&quot; | str_detect(isolation_source, &quot;human&quot;)) # A tibble: 34 × 97 assembly strain isolation_source collection_date geo_loc_name sample_type lat_lon collected_by host_disease &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 GCF_001061… 1133_… missing Unknown USA: WA &lt;NA&gt; missing UW clinical… missing 2 GCF_001559… FDAAR… stool 2014-05-12 USA:DC &lt;NA&gt; Not Ap… Children&#39;s … Colonizatio… 3 GCF_002313… FDAAR… endotracheal as… 2014-07-09 USA:DC &lt;NA&gt; Not Ap… Children&#39;s … Colonization 4 GCF_018606… &lt;NA&gt; urine 2017-11 USA: Clevel… metagenomi… &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 5 GCF_023698… Stebr… urine 2021-08-18 Germany &lt;NA&gt; 50.92 … &lt;NA&gt; &lt;NA&gt; 6 GCF_030843… &lt;NA&gt; feces missing USA metagenomi… missing &lt;NA&gt; &lt;NA&gt; 7 GCF_033899… CIM-C… not applicable unknown Germany &lt;NA&gt; 50.917… Hamprecht g… unknown 8 GCF_033899… CIM-C… not applicable unknown Germany &lt;NA&gt; 50.917… Hamprecht g… unknown 9 GCF_043828… KE9839 &lt;NA&gt; 2020 Germany isolated c… &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 10 GCF_049544… CRS24… bile 2024-04-29 South Korea… &lt;NA&gt; 37.410… Bundang CHA… Hilar chola… # ℹ 24 more rows # ℹ 88 more variables: host &lt;chr&gt;, note &lt;chr&gt;, isolate_name_alias &lt;chr&gt;, `identification method` &lt;chr&gt;, # host_sex &lt;chr&gt;, host_age &lt;chr&gt;, culture_collection &lt;chr&gt;, isolate &lt;chr&gt;, host_disease_outcome &lt;chr&gt;, # host_health_state &lt;chr&gt;, host_description &lt;chr&gt;, host_disease_stage &lt;chr&gt;, subsrc_note &lt;chr&gt;, # assembly_method &lt;chr&gt;, assembly_method_version &lt;chr&gt;, completeness_estimated &lt;chr&gt;, # contamination_estimated &lt;chr&gt;, environmental_sample &lt;chr&gt;, genome_coverage &lt;chr&gt;, mapping_method &lt;chr&gt;, # mapping_method_version &lt;chr&gt;, metagenome_source &lt;chr&gt;, metagenomic &lt;chr&gt;, quality_assessment_method &lt;chr&gt;, … 4.1.4 Enterococcus faecalis ## ENTEROCOCCUS HIRAE datasets summary genome taxon 1354 \\ --as-json-lines &gt; enterococcus_genomes.jsonl #filtering by contamination and completeness jq -c &#39; select( .checkm_info.completeness &gt;= 90 and .checkm_info.contamination &lt;= 2.5 ) &#39; enterococcus_genomes.jsonl &gt; enterococcus_high_quality_genomes.jsonl #put metadata in tsv jq -r &#39; .accession as $asm | .assembly_info.biosample.attributes[]? | [$asm, .name, .value] | @tsv &#39; enterococcus_high_quality_genomes.jsonl &gt; enterococcus_biosample_attributes.tsv enterococcus_metadata &lt;- read_tsv(&quot;data/ncbi/enterococcus_biosample_attributes.tsv&quot;, col_names = c(&quot;assembly&quot;, &quot;attribute&quot;, &quot;value&quot;)) Rows: 6648 Columns: 3 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (3): assembly, attribute, value ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. metadata_wide &lt;- enterococcus_metadata %&gt;% pivot_wider( id_cols = assembly, names_from = attribute, values_from = value, values_fn = function(x) x[1] ) source_counts &lt;- metadata_wide %&gt;% filter(!is.na(isolation_source)) %&gt;% dplyr::count(isolation_source, sort = TRUE) source_counts # A tibble: 82 × 2 isolation_source n &lt;chr&gt; &lt;int&gt; 1 feces 98 2 missing 50 3 Popliteal lymph node of steer 40 4 hospital sewage 32 5 fecal sample 22 6 Breast meat 20 7 Procapra picticaudata 16 8 not collected 14 9 stool 14 10 river water 10 # ℹ 72 more rows host_counts &lt;- metadata_wide %&gt;% filter(!is.na(host)) %&gt;% dplyr::count(host, sort = TRUE) host_counts # A tibble: 39 × 2 host n &lt;chr&gt; &lt;int&gt; 1 Homo sapiens 238 2 cow 41 3 mouse 40 4 pig 40 5 Bos taurus 30 6 Gallus gallus domesticus 20 7 swine 20 8 not applicable 18 9 Gallus gallus 16 10 pigeon 12 # ℹ 29 more rows metadata_wide %&gt;% filter(host == &quot;Homo sapiens&quot; | str_detect(isolation_source, &quot;human&quot;)) # A tibble: 238 × 90 assembly strain isolate collected_by collection_date geo_loc_name isolation_source lat_lon culture_collection &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 GCF_0022… FDAAR… Not Ap… Children&#39;s … 2014-09-14 USA:DC abscess Not Ap… FDA:FDAARGOS_234 2 GCF_0041… bz_00… &lt;NA&gt; &lt;NA&gt; 2015-01 USA: Cambri… stool &lt;NA&gt; &lt;NA&gt; 3 GCF_0098… BIOML… &lt;NA&gt; &lt;NA&gt; 2016-01-15 USA:Boston &lt;NA&gt; 42.36 … &lt;NA&gt; 4 GCF_0098… BIOML… &lt;NA&gt; &lt;NA&gt; 2016-01-15 USA:Boston &lt;NA&gt; 42.36 … &lt;NA&gt; 5 GCF_0098… BIOML… &lt;NA&gt; &lt;NA&gt; 2016-01-15 USA:Boston &lt;NA&gt; 42.36 … &lt;NA&gt; 6 GCF_0098… BIOML… &lt;NA&gt; &lt;NA&gt; 2016-01-15 USA:Boston &lt;NA&gt; 42.36 … &lt;NA&gt; 7 GCF_0098… BIOML… &lt;NA&gt; &lt;NA&gt; 2016-01-15 USA:Boston &lt;NA&gt; 42.36 … &lt;NA&gt; 8 GCF_0098… BIOML… &lt;NA&gt; &lt;NA&gt; 2016-01-15 USA:Boston &lt;NA&gt; 42.36 … &lt;NA&gt; 9 GCF_0098… BIOML… &lt;NA&gt; &lt;NA&gt; 2016-01-15 USA:Boston &lt;NA&gt; 42.36 … &lt;NA&gt; 10 GCF_0098… BIOML… &lt;NA&gt; &lt;NA&gt; 2016-01-15 USA:Boston &lt;NA&gt; 42.36 … &lt;NA&gt; # ℹ 228 more rows # ℹ 81 more variables: host &lt;chr&gt;, host_age &lt;chr&gt;, host_description &lt;chr&gt;, host_disease &lt;chr&gt;, # host_disease_outcome &lt;chr&gt;, host_disease_stage &lt;chr&gt;, host_health_state &lt;chr&gt;, host_sex &lt;chr&gt;, # `identification method` &lt;chr&gt;, `type-material` &lt;chr&gt;, sample_type &lt;chr&gt;, note &lt;chr&gt;, env_broad_scale &lt;chr&gt;, # env_local_scale &lt;chr&gt;, env_medium &lt;chr&gt;, isol_growth_condt &lt;chr&gt;, num_replicons &lt;chr&gt;, # ref_biomaterial &lt;chr&gt;, isolate_name_alias &lt;chr&gt;, estimated_size &lt;chr&gt;, extrachrom_elements &lt;chr&gt;, # host_body_habitat &lt;chr&gt;, host_genotype &lt;chr&gt;, host_phenotype &lt;chr&gt;, host_taxid &lt;chr&gt;, rel_to_oxygen &lt;chr&gt;, … Gut microbiome : c(“ceaca”, “caeca”, “excrement”, “rectal swabs”, “feces”, “stool”, “gut”, “cloaca”, “cloacal”, “fecal”, “intestine”, “intestinal”) selected &lt;- metadata_wide %&gt;% filter( host == &quot;Homo sapiens&quot; | str_detect(isolation_source, regex(&quot;human&quot;, ignore_case = TRUE)) ) %&gt;% pull(assembly) %&gt;% unique() #check length(selected) head(selected) #save the accessions to download the mags in mjolnir #writeLines(selected, &quot;selected_accessions.txt&quot;) 4.2 Downloading the MAGs after filtering Download the MAGs when you finish selecting them ### DOWNLOAD THE MAGS datasets download genome accession --inputfile selected_accessions.txt --include genome --filename selected_genomes.zip "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
