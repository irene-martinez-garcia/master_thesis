[["index.html", "AlberdiLab | Comparative metagenomics MSc project Chapter 1 Introduction 1.1 Prepare the R environment", " AlberdiLab | Comparative metagenomics MSc project Irene Martínez, M Thomas P Gilbert, Antton Alberdi1 Last update: 2025-12-01 Chapter 1 Introduction This webbook contains all the code used for data analysis for the comparative metagenomics analysis of gut microbiome bacterial species in several vertebrates. 1.1 Prepare the R environment 1.1.1 Environment To reproduce all the analyses locally, clone this repository in your computer using: RStudio &gt; New Project &gt; Version Control &gt; Git And indicating the following git repository: https://github.com/irene-martinez-garcia/comparative_metagenomics.git Once the R project has been created, follow the instructions and code chunks shown in this webbook. 1.1.2 Libraries The following R packages are required for the data analysis. # Base library(R.utils) library(knitr) library(tidyverse) library(devtools) library(tinytable) library(rairtable) library(janitor) library(broom) # For tree handling library(ape) library(phyloseq) library(phytools) # For plotting library(ggplot2) library(ggrepel) library(ggpubr) library(ggnewscale) library(gridExtra) library(ggtreeExtra) library(ggtree) library(ggh4x) library(UpSetR) library(viridis) # For statistics library(spaa) library(vegan) library(Rtsne) library(geiger) library(distillR) library(ANCOMBC) library(lme4) library(nlme) library(pairwiseAdonis) library(emmeans) library(pheatmap) library(rstatix) library(uwot) University of Copenhagen, antton.alberdi@sund.ku.dk↩︎ "],["data-preparation.html", "Chapter 2 Data preparation 2.1 Searching for the MAGs 2.2 Downloading the MAGs 2.3 R Studio- Data Analysis 2.4 Load data 2.5 Wrap working objects", " Chapter 2 Data preparation 2.1 Searching for the MAGs Choose the MAGs In this case, we will be working with Parabacteroides distasonis and Phocaeicola vulgatus. In the EHI database, select the MAGs with &gt; 90% completeness and &lt; 2.5 contamination. Do the same in the GTDB, but also filter for isolation source CONTAINS feces. 2.2 Downloading the MAGs Download genome indices and metadata Download the EHI_MAG index for each species (in /data/mags_metadata folder) and the curl file and search metadata tsv from the GTDB and place in each species directory in Mjolnir. 2.5) Extract genome metadata - Make list will all the accession numbers of the MAGs and run this script to obtain more metadata. (modify script a bit to make it scalable). python scripts/extract_gtdb_metadata.py Create the master index Run the create_index.R script to create an index of all the MAGs and the download paths (needs a list of species as input and right now it is hardcoded in the script) conda activate mags_r_env Rscript scripts/create_index.R Run the downloading_mags.smk to download all the genomes snakemake -s snakefiles/downloading_mags.smk --cores 8 Unzip all the MAGs and make sure they are in the same folder: run bash scripts/unzip_mags.sh parabacteroides_distasonis bash scripts/unzip_mags.sh phocaeicola_vulgatus Make a screen session for each species. screen -S parabacteroides_distasonis Run drakkar annotating_function.smk to re-annotate all the MAGs: drakkar annotating -b /maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis/mags/unzipped -o /maps/projects/alberdilab/people/pjq449/comparative_metagenomics --env_path /projects/alberdilab/data/environments/drakkar --annotation-type function 2.3 R Studio- Data Analysis 2.4 Load data 2.4.1 EHI MAGs ehi_mags &lt;- read_csv(&quot;data/ehi_mags.csv&quot;) Rows: 8846 Columns: 52 ── Column specification ───────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylu... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N5... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.4.2 Prepare color scheme AlberdiLab projects use unified color schemes developed for the Earth Hologenome Initiative, to facilitate figure interpretation. ehi_mags_p &lt;- ehi_mags %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(ehi_mags_p, by=join_by(phylum == phylum)) %&gt;% dplyr::select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% pull(colors, name=phylum) source_colors &lt;- c(EHI = &quot;#8BC63F&quot;, GTDB = &quot;#2D522D&quot;) 2.4.3 Sample metadata gtdb_search_metadata &lt;- read_tsv(&quot;data/p_dist_gtdb_metadata.tsv&quot;) Rows: 69 Columns: 9 ── Column specification ───────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (6): Accession, Organism Name, NCBI Taxonomy, GTDB Taxonomy, GTDB Type Material, Isolation Source dbl (2): CheckM Completeness, CheckM2 Contamination lgl (1): GTDB Representative of Species ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. gtdb_accession_metadata&lt;- read_tsv(&quot;data/parabacteroides_distasonis_GTDB_accession_metadata.tsv&quot;) %&gt;% mutate(cleaned_accession = str_replace(accession, &quot;^(RS_|GB_)&quot;, &quot;&quot;)) Rows: 67 Columns: 115 ── Column specification ───────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (69): accession, checkm2_model, checkm_marker_lineage, gtdb_genome_representative, gtdb_taxonomy, gt... dbl (39): ambiguous_bases, checkm2_completeness, checkm2_contamination, checkm_completeness, checkm_cont... lgl (5): gtdb_representative, gtdb_type_species_of_genus, mimag_high_quality, mimag_low_quality, mimag_... date (2): ncbi_date, ncbi_seq_rel_date ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. ehi_metadata &lt;- read_tsv(&quot;data/mags_metadata/parabacteroides_distasonis_metadata.tsv&quot;) %&gt;% mutate(GC = as.numeric(str_remove(GC, &quot;%&quot;))) Rows: 25 Columns: 52 ── Column specification ───────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylu... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N5... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. # Prepare EHI metadata with standardized column names ehi_clean &lt;- ehi_metadata %&gt;% select( ID, species = species, completeness, contamination, genome_size = size, GC, N50, contigs, host_species, host_order, host_class, assembly_type, isolation_source= sample_type ) %&gt;% mutate(source = &quot;EHI&quot;) # Prepare GTDB metadata # Join search and accession metadata gtdb_metadata &lt;- full_join(gtdb_accession_metadata, gtdb_search_metadata, by = c(&quot;cleaned_accession&quot; = &quot;Accession&quot;) ) # Prepare GTDB metadata gtdb_clean &lt;- gtdb_metadata %&gt;% select( ID = cleaned_accession, species = &quot;Organism Name&quot;, completeness = &quot;CheckM Completeness&quot;, contamination = &quot;CheckM2 Contamination&quot;, gtdb_taxonomy = &quot;GTDB Taxonomy&quot;, isolation_source = &quot;Isolation Source&quot;, genome_size, GC = gc_percentage, N50 = n50_contigs, contigs = contig_count, ncbi_country, mimag_high_quality, mimag_medium_quality, gtdb_representative )%&gt;% mutate(source = &quot;GTDB&quot;) #Join genome_metadata &lt;- bind_rows(ehi_clean, gtdb_clean) # Read master index master_index &lt;- read_tsv(&quot;data/master_mag_index.tsv&quot;) %&gt;% filter(species == &quot;parabacteroides_distasonis&quot;) %&gt;% mutate( # Extract the actual genome identifier from out_path genome_identifier = case_when( # For EHI: extract EHA00531_bin.1 from the filename str_detect(out_path, &quot;EHA&quot;) ~ str_extract(out_path, &quot;EHA[0-9]+_bin\\\\.[0-9]+&quot;), # For NCBI: use the ID as is (GCA/GCF number) TRUE ~ ID ) ) Rows: 287 Columns: 4 ── Column specification ───────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (4): species, ID, MAG_url, out_path ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. # Check the mapping print(&quot;Master index mapping:&quot;) [1] &quot;Master index mapping:&quot; master_index %&gt;% select(ID, genome_identifier, out_path) %&gt;% head(10) %&gt;% print() # A tibble: 10 × 3 ID genome_identifier out_path &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016228 EHA00531_bin.1 data/parabacteroides_distasonis/mags/EHA00531_bin.1.fa.gz 2 EHM016318 EHA00539_bin.6 data/parabacteroides_distasonis/mags/EHA00539_bin.6.fa.gz 3 EHM016582 EHA00535_bin.6 data/parabacteroides_distasonis/mags/EHA00535_bin.6.fa.gz 4 EHM016991 EHA00726_bin.13 data/parabacteroides_distasonis/mags/EHA00726_bin.13.fa.gz 5 EHM020917 EHA01202_bin.66 data/parabacteroides_distasonis/mags/EHA01202_bin.66.fa.gz 6 EHM023585 EHA00928_bin.90 data/parabacteroides_distasonis/mags/EHA00928_bin.90.fa.gz 7 EHM023781 EHA01439_bin.44 data/parabacteroides_distasonis/mags/EHA01439_bin.44.fa.gz 8 EHM027637 EHA01634_bin.14 data/parabacteroides_distasonis/mags/EHA01634_bin.14.fa.gz 9 EHM028668 EHA01281_bin.18 data/parabacteroides_distasonis/mags/EHA01281_bin.18.fa.gz 10 EHM029564 EHA01845_bin.103 data/parabacteroides_distasonis/mags/EHA01845_bin.103.fa.gz # Read contig-to-genome mapping contig_to_genome &lt;- read_tsv(&quot;data/p_dist_contig_to_genome.tsv&quot;, col_names = c(&quot;contig&quot;, &quot;genome_filename&quot;)) Rows: 13976 Columns: 2 ── Column specification ───────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (2): contig, genome_filename ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.4.4 Genome annotations # Read annotations and add IDs genome_annotations &lt;- read_tsv(&quot;data/gene_annotations.tsv.xz&quot;) %&gt;% mutate(contig = sub(&quot;_[^_]*$&quot;, &quot;&quot;, gene)) %&gt;% left_join(contig_to_genome, by = &quot;contig&quot;) %&gt;% # Extract accession from genome filename mutate( accession = case_when( # For NCBI genomes: extract GCA/GCF number str_detect(genome_filename, &quot;^GC[AF]_&quot;) ~ str_extract(genome_filename, &quot;^GC[AF]_[0-9]+\\\\.[0-9]+&quot;), # For EHI genomes: the filename IS the identifier TRUE ~ genome_filename ) ) %&gt;% # Join with master index using genome_identifier left_join( master_index %&gt;% select(mag_id = ID, genome_identifier), by = c(&quot;accession&quot; = &quot;genome_identifier&quot;) ) %&gt;% select(gene, mag_id, genome = genome_filename, contig, accession, everything()) %&gt;% filter(!is.na(mag_id)) Warning: One or more parsing issues, call `problems()` on your data frame for details, e.g.: dat &lt;- vroom(...) problems(dat) Rows: 374229 Columns: 13 ── Column specification ───────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (11): gene, strand, kegg, ec, pfam, cazy, resistance_type, resistance_target, vf, vf_type, signalp dbl (2): start, end ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.4.5 Distill annotations into GIFTs genome_gifts &lt;- distill(genome_annotations,GIFT_db,genomecol= 2, annotcol=c(9,10,11,12), verbosity = T) 2.5 Wrap working objects All working objects are wrapped into a single Rdata object to facilitate downstream usage. save(ehi_mags, phylum_colors, genome_annotations, genome_gifts, contig_to_genome, gtdb_metadata, ehi_metadata, master_index, genome_metadata, source_colors, file = &quot;data/data.Rdata&quot;) "],["ehi-mags-exploration.html", "Chapter 3 EHI MAGs exploration", " Chapter 3 EHI MAGs exploration 3.0.1 EHI MAGs load(&quot;data/data.Rdata&quot;) ehi_mags &lt;- read_csv(&quot;data/ehi_mags.csv&quot;) Rows: 8846 Columns: 52 ── Column specification ───────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylu... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N5... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. colnames(ehi_mags) [1] &quot;ID&quot; &quot;mag_name&quot; &quot;link_to_assembly&quot; [4] &quot;AB_batch&quot; &quot;eha_number&quot; &quot;GTDB_version&quot; [7] &quot;GTDB_release&quot; &quot;domain&quot; &quot;phylum&quot; [10] &quot;class&quot; &quot;order&quot; &quot;family&quot; [13] &quot;genus&quot; &quot;species&quot; &quot;fastani_ani&quot; [16] &quot;closest_placement_ani&quot; &quot;closest_placement_af&quot; &quot;completeness&quot; [19] &quot;contamination&quot; &quot;size&quot; &quot;GC&quot; [22] &quot;N50&quot; &quot;coding_density&quot; &quot;contigs&quot; [25] &quot;number_genes&quot; &quot;number_unannotated_genes&quot; &quot;DM_batch&quot; [28] &quot;host_species&quot; &quot;host_order&quot; &quot;host_class&quot; [31] &quot;MAG_url&quot; &quot;anno_url&quot; &quot;kegg_url&quot; [34] &quot;annotated&quot; &quot;taxonomy_level&quot; &quot;assembly_type&quot; [37] &quot;sample_type&quot; &quot;gbk_url&quot; &quot;kegg_hits&quot; [40] &quot;Capture ID&quot; &quot;percent_unannotated_genes&quot; &quot;percent_unannotated_kegg&quot; [43] &quot;dereplicated&quot; &quot;metagenomic source&quot; &quot;completeness software&quot; [46] &quot;binning software&quot; &quot;assembly quality&quot; &quot;binning parameters&quot; [49] &quot;taxonomic identity marker&quot; &quot;isolation_source&quot; &quot;assembly software&quot; [52] &quot;Submission&quot; Check contamination and completeness genome_biplot &lt;- ehi_mags %&gt;% dplyr::select(c(phylum,completeness,contamination,size)) %&gt;% ggplot(aes(x=completeness,y=contamination,size=size,color=phylum)) + geom_point(alpha=0.7) + xlim(c(70,100)) + ylim(c(10,0)) + scale_color_manual(values=phylum_colors) + labs(y= &quot;Contamination&quot;, x = &quot;Completeness&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;) #Generate contamination boxplot genome_contamination &lt;- ehi_mags %&gt;% ggplot(aes(y=contamination)) + ylim(c(10,0)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0.40, 0),&quot;inches&quot;)) #add bottom-margin (top, right, bottom, left) genome_completeness &lt;- ehi_mags %&gt;% ggplot(aes(x=completeness)) + xlim(c(70,100)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0, 0.50),&quot;inches&quot;)) #add left-margin (top, right, bottom, left) #Render composite figure #pdf(&quot;figures/completeness_contamination.pdf&quot;,width=10, height=5) grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination), layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3))) Warning: Removed 1721 rows containing non-finite outside the scale range (`stat_boxplot()`). Warning: No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. Warning: Removed 1721 rows containing missing values or values outside the scale range (`geom_point()`). Warning: Removed 1 row containing non-finite outside the scale range (`stat_boxplot()`). Filter by completeness and contamination ehi_mags_filtered &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5) 3.0.2 Host classes species_hostclass_counts &lt;- ehi_mags %&gt;% filter(!is.na(species), species != &quot;&quot;) %&gt;% filter(!is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_mags = n(), n_host_classes = n_distinct(host_class), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), phylum = paste(unique(phylum), collapse = &quot;, &quot;) ) %&gt;% arrange(desc(n_host_classes)) species_selection &lt;- species_hostclass_counts %&gt;% filter(n_host_classes &gt;= 3) species_selection # A tibble: 34 × 5 species n_mags n_host_classes host_classes phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Hafnia alvei 61 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 2 s__Pseudomonas aeruginosa 99 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 3 s__Aeromonas encheleia 18 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 4 s__Bacteroides caccae 13 3 Aves, Mammalia, Reptilia p__Bacteroidota 5 s__Bacteroides fragilis 20 3 Aves, Mammalia, Reptilia p__Bacteroidota 6 s__Bacteroides nordii 23 3 Aves, Mammalia, Reptilia p__Bacteroidota 7 s__Bacteroides thetaiotaomicron 42 3 Aves, Mammalia, Reptilia p__Bacteroidota 8 s__Bacteroides uniformis 84 3 Aves, Mammalia, Reptilia p__Bacteroidota 9 s__Bacteroides xylanisolvens 27 3 Aves, Mammalia, Reptilia p__Bacteroidota 10 s__Bilophila wadsworthia 12 3 Aves, Mammalia, Reptilia p__Desulfobacter… # ℹ 24 more rows species_selection %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 5 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 5 2 p__Bacillota_A 2 3 p__Bacteroidota 8 4 p__Desulfobacterota 1 5 p__Pseudomonadota 18 3.0.3 Host classes- after filtering species_hostclass_counts_f &lt;- ehi_mags_filtered %&gt;% filter(!is.na(species), species != &quot;&quot;) %&gt;% filter(!is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_mags = n(), n_host_classes = n_distinct(host_class), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), phylum = paste(unique(phylum), collapse = &quot;, &quot;) ) %&gt;% arrange(desc(n_host_classes)) species_selection_f &lt;- species_hostclass_counts_f %&gt;% filter(n_host_classes &gt;= 3, n_mags &gt; 10) %&gt;% arrange(desc(n_mags)) species_selection_f # A tibble: 10 × 5 species n_mags n_host_classes host_classes phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Escherichia coli 64 3 Aves, Mammalia, Reptilia p__Pseudomonadota 2 s__Pseudomonas aeruginosa 55 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 3 s__Lactococcus lactis 38 3 Aves, Mammalia, Reptilia p__Bacillota 4 s__Hafnia paralvei 25 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 5 s__Parabacteroides distasonis 25 3 Aves, Mammalia, Reptilia p__Bacteroidota 6 s__Enterococcus faecalis 21 3 Aves, Mammalia, Reptilia p__Bacillota 7 s__Bacteroides uniformis 19 3 Aves, Mammalia, Reptilia p__Bacteroidota 8 s__Phocaeicola vulgatus 19 3 Aves, Mammalia, Reptilia p__Bacteroidota 9 s__Citrobacter braakii 16 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 10 s__Moellerella wisconsensis 13 3 Amphibia, Aves, Mammalia p__Pseudomonadota species_selection_list&lt;- species_selection_f %&gt;% pull(species) species_selection_f %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 3 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 2 2 p__Bacteroidota 3 3 p__Pseudomonadota 5 3.0.4 Count host classes per species species_hostclass_counts &lt;- ehi_mags_filtered %&gt;% filter(!is.na(species), species != &quot;&quot;, !is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_host_classes = n_distinct(host_class)) %&gt;% arrange(desc(n_host_classes)) counts_species_per_class&lt;- species_hostclass_counts %&gt;% group_by(n_host_classes)%&gt;% summarize(n_species = n()) ggplot(counts_species_per_class, aes(x = n_host_classes, y = n_species)) + geom_col() + geom_text( aes(label = n_species), vjust = -0.3, size = 4 ) + labs( title = &quot;Number of Species per Number of Host Classes&quot;, x = &quot;Number of Host Classes&quot;, y = &quot;Number of Species&quot; ) + theme_bw() mags_with_counts &lt;- ehi_mags_filtered %&gt;% left_join(species_hostclass_counts, by = &quot;species&quot;) #filter for mags with &gt;2 host classes mags_host3 &lt;- mags_with_counts %&gt;% filter(n_host_classes &gt;= 3) n_mags &lt;- mags_host3 %&gt;% group_by(species) %&gt;% summarise(n_mags = n(), .groups = &quot;drop&quot;) #Species level: species_host3 &lt;- mags_host3 %&gt;% group_by(species)%&gt;% summarise(phylum = first(phylum), order = first(order), family = first(family), genus = first(genus), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), host_species = paste(sort(unique(host_species)), collapse = &quot;, &quot;)) We have several MAGs per species, so here we select the “best MAG” (highest completeness and lowest contamination), to have statistics based on the best of each. best_mag_per_species &lt;- mags_host3 %&gt;% group_by(species) %&gt;% arrange(desc(completeness), contamination) %&gt;% slice(1) %&gt;% ungroup() %&gt;% transmute( species, best_mag_name = mag_name, best_MAG_link = link_to_assembly, best_genome_size = size, best_completeness = completeness, best_contamination = contamination, best_N50 = N50, best_host_classes = host_class, best_assembly_type = assembly_type, best_phylum =str_remove_all(phylum, &quot;p__&quot;)) ggplot(best_mag_per_species, aes(x= species, y = best_genome_size, fill = best_phylum))+ scale_color_manual(values=phylum_colors) + scale_fill_manual(values=phylum_colors) + geom_col()+ theme_bw()+ theme(axis.text.x = element_text(angle = 90)) Warning: No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. Filtering for Parabacteroides distasonis (make into a loop for all the relevant species later) p_dist &lt;- ehi_mags %&gt;% filter(completeness &gt;90, contamination &lt; 2.5, species == &quot;s__Parabacteroides distasonis&quot;) write_tsv(p_dist, &quot;data/mags_metadata/parabacteroides_distasonis_metadata.tsv&quot;) p_dist_index &lt;- p_dist %&gt;% select(ID, MAG_url) write_tsv(p_dist_index, &quot;data/mags_metadata/parabacteroides_distasonis_index.tsv&quot;) #Loop through each species in species_selection list for (i in 1:nrow(species_selection_f)) { current_species &lt;- species_selection_f$species[i] #Filter for completeness and contamination #get metadata species_data &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5, species == current_species) #get index species_index &lt;- species_data %&gt;% select(ID, MAG_url) #Filename from species name filename &lt;- current_species %&gt;% str_replace(&quot;s__&quot;, &quot;&quot;) %&gt;% str_replace_all(&quot; &quot;, &quot;_&quot;) %&gt;% tolower() #export to tsv write_tsv(species_data, paste0(&quot;data/mags_metadata/&quot;, filename, &quot;_metadata.tsv&quot;)) write_tsv(species_index, paste0(&quot;data/mags_metadata/&quot;, filename, &quot;_index.tsv&quot;)) } ### First only with two: all_mags &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5, species %in% c(&quot;s__Parabacteroides distasonis&quot;, &quot;s__Phocaeicola vulgatus&quot;)) %&gt;% mutate(species = str_remove(species, &quot;^s__&quot;) %&gt;% str_to_lower() %&gt;% str_replace(&quot; &quot;, &quot;_&quot;), out_path = paste0(&quot;data/&quot;, species, &quot;/mags/&quot;, basename(MAG_url)) ) %&gt;% select(species, ID, MAG_url, out_path) write_tsv(all_mags, &quot;all_mags_index.tsv&quot;) "],["data-statistics.html", "Chapter 4 Data statistics", " Chapter 4 Data statistics 4.0.1 Load data load(&quot;data/data.Rdata&quot;) Total number of MAGs combined_metadata %&gt;% count(source) # A tibble: 2 × 2 source n &lt;chr&gt; &lt;int&gt; 1 EHI 25 2 GTDB 69 combined_metadata %&gt;% summarise( mean_c = mean(completeness, na.rm = TRUE) %&gt;% round(2), sd_c = sd(completeness, na.rm = TRUE) %&gt;% round(2), mean_con = mean(contamination, na.rm = TRUE) %&gt;% round(2), sd_con = sd(contamination, na.rm = TRUE) %&gt;% round(2) ) %&gt;% unite(&quot;Completeness&quot;, mean_c, sd_c, sep = &quot; ± &quot;) %&gt;% unite(&quot;Contamination&quot;, mean_con, sd_con, sep = &quot; ± &quot;) %&gt;% tt() .table td.tinytable_css_9lbjgytenm6sempv6q45, .table th.tinytable_css_9lbjgytenm6sempv6q45 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_vomytbutydsv62mek79x, .table th.tinytable_css_vomytbutydsv62mek79x { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } Completeness Contamination 97.71 ± 2.64 1.15 ± 0.64 #Generate quality biplot genome_biplot &lt;- combined_metadata %&gt;% dplyr::select(c(ID,completeness,contamination)) %&gt;% ggplot(aes(x=completeness,y=contamination)) + geom_point(alpha=0.7) + xlim(c(90,100)) + ylim(c(2.5,0)) + labs(y= &quot;Contamination&quot;, x = &quot;Completeness&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;) #Generate contamination boxplot genome_contamination &lt;- combined_metadata %&gt;% ggplot(aes(y=contamination)) + ylim(c(10,0)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0.40, 0),&quot;inches&quot;)) #add bottom-margin (top, right, bottom, left) #Generate completeness boxplot genome_completeness &lt;- combined_metadata %&gt;% ggplot(aes(x=completeness)) + xlim(c(70,100)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0, 0.50),&quot;inches&quot;)) #add left-margin (top, right, bottom, left) #Render composite figure #pdf(&quot;figures/completeness_contamination.pdf&quot;,width=10, height=5) grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination), layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3))) #dev.off() "],["functional-analysis.html", "Chapter 5 Functional Analysis 5.1 Functional overview 5.2 Functional ordination", " Chapter 5 Functional Analysis 5.1 Functional overview n_genes &lt;- genome_annotations %&gt;% group_by(genome) %&gt;% summarize(n_genes = n()) n_genes # A tibble: 94 × 2 genome n_genes &lt;chr&gt; &lt;int&gt; 1 EHA00531_bin.1 4139 2 EHA00535_bin.6 3426 3 EHA00539_bin.6 3839 4 EHA00726_bin.13 3950 5 EHA00928_bin.90 3569 6 EHA01202_bin.66 3139 7 EHA01281_bin.18 3922 8 EHA01439_bin.44 3572 9 EHA01634_bin.14 3731 10 EHA01845_bin.103 3752 # ℹ 84 more rows 5.1.0.1 Predicted genes pred_genes &lt;- genome_annotations %&gt;% nrow() cat(pred_genes) 374136 5.1.0.2 Number of annotated genes and percentages #How many genes have at least 1 annotation genome_annota &lt;- genome_annotations %&gt;% filter(if_any(c(kegg, pfam, cazy), ~ !is.na(.))) %&gt;% nrow() cat(genome_annota) 313671 #Percentage of predicted genes with at least 1 annotation genome_annota*100/pred_genes [1] 83.83876 5.1.0.3 Number of KEGG annotatated genes and percentages # KEGG annotation kegg_annota &lt;- genome_annotations %&gt;% filter(!is.na(kegg)) %&gt;% nrow() cat(kegg_annota) 245140 # KEGG annotation percentage kegg_annota*100/genome_annota [1] 78.15195 5.2 Functional ordination PCoA with Euclidean distances: # Convert the GIFTs into a matrix of functional elements per genome (row) gift_pcoa &lt;- genome_gifts %&gt;% to.elements(., GIFT_db) %&gt;% as.data.frame() %&gt;% vegdist(method=&quot;euclidean&quot;) %&gt;% pcoa() #principal component analysis #Extract eigenvalues (variance explained by first 10 axes) gift_pcoa_rel_eigen &lt;- gift_pcoa$values$Relative_eig[1:10] # Get genome positions gift_pcoa_vectors &lt;- gift_pcoa$vectors %&gt;% #extract vectors as.data.frame() %&gt;% dplyr::select(Axis.1,Axis.2) # keep the first 2 axes gift_pcoa_eigenvalues &lt;- gift_pcoa$values$Eigenvalues[c(1,2)] #For the black arrows: Functional group loadings # covariance between each functional trait and pcoa axis scores #scale with the eigenvectors gift_pcoa_gifts &lt;- cov(genome_gifts, scale(gift_pcoa_vectors)) %*% diag((gift_pcoa_eigenvalues/(nrow(genome_gifts)-1))^(-0.5)) %&gt;% as.data.frame() %&gt;% rename(Axis.1=1,Axis.2=2) %&gt;% rownames_to_column(var=&quot;label&quot;) %&gt;% #get function summary vectors mutate(func=substr(label,1,3)) %&gt;% group_by(func) %&gt;% #grouping by function summarise(Axis.1=mean(Axis.1), Axis.2=mean(Axis.2)) %&gt;% rename(label=func) %&gt;% filter(!label %in% c(&quot;S01&quot;,&quot;S02&quot;,&quot;S03&quot;)) set.seed(101) scale &lt;- 20 # scale for vector loadings (to make arrows visible) gift_pcoa_vectors %&gt;% rownames_to_column(var=&quot;ID&quot;) %&gt;% left_join(genome_metadata, by=&quot;ID&quot;) %&gt;% ggplot() + #genome positions scale_color_manual(values=source_colors)+ geom_point(aes(x=Axis.1,y=Axis.2, color = source), alpha=0.9, shape=16) + scale_size_continuous(range = c(0.1,5)) + #loading positions geom_segment(data=gift_pcoa_gifts, aes(x=0, y=0, xend=Axis.1 * scale, yend=Axis.2 * scale), arrow = arrow(length = unit(0.3, &quot;cm&quot;), type = &quot;open&quot;, angle = 25), linewidth = 0.5, color = &quot;black&quot;) + #Primary and secondary scale adjustments scale_x_continuous(name = paste0(&quot;PCoA1 (&quot;,round(gift_pcoa_rel_eigen[1]*100, digits = 2), &quot; %)&quot;), sec.axis = sec_axis(~ . / scale, name = &quot;Loadings on PCoA1&quot;) ) + scale_y_continuous(name = paste0(&quot;PCoA2 (&quot;,round(gift_pcoa_rel_eigen[2]*100, digits = 2), &quot; %)&quot;), sec.axis = sec_axis(~ . / scale, name = &quot;Loadings on PCoA2&quot;) ) + geom_label_repel(data = gift_pcoa_gifts, aes(label = label, x = Axis.1 * scale, y = Axis.2 * scale), segment.color = &#39;transparent&#39;) + xlim(-0.8,1) + ylim(-1,1.5) + theme_minimal() + labs( x = paste0(&quot;PCoA1 (&quot;, round(gift_pcoa_rel_eigen[1]*100, 2), &quot; %)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(gift_pcoa_rel_eigen[2]*100, 2), &quot; %)&quot;) ) Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_segment()`). Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_label_repel()`). Warning: ggrepel: 12 unlabeled data points (too many overlaps). Consider increasing max.overlaps arrow_functions &lt;- gift_pcoa_gifts %&gt;% left_join(GIFT_db, by = c(&quot;label&quot; = &quot;Code_function&quot;)) %&gt;% group_by(label) %&gt;% summarise( Axis.1 = mean(Axis.1), Axis.2 = mean(Axis.2), Function = first(Function), Domain = first(Domain), Length = sqrt(Axis.1^2 + Axis.2^2), # vector length .groups = &quot;drop&quot; ) %&gt;% arrange(desc(Length)) # sort so most important arrows are first arrow_functions # A tibble: 18 × 6 label Axis.1 Axis.2 Function Domain Length &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; 1 D09 0.00131 -0.133 Antibiotic degradation Degradation 0.133 2 B03 -0.00235 -0.0603 Amino acid derivative biosynthesis Biosynthesis 0.0604 3 B01 -0.00429 -0.0299 Nucleic acid biosynthesis Biosynthesis 0.0302 4 B07 -0.00699 -0.0249 Vitamin biosynthesis Biosynthesis 0.0259 5 D05 -0.000629 -0.00950 Amino acid degradation Degradation 0.00952 6 B06 -0.00197 -0.00785 Organic anion biosynthesis Biosynthesis 0.00809 7 D01 -0.00427 -0.00523 Lipid degradation Degradation 0.00675 8 B02 0.000620 -0.00500 Amino acid biosynthesis Biosynthesis 0.00504 9 D06 -0.0000748 -0.00392 Nitrogen compound degradation Degradation 0.00392 10 B10 0.0000152 -0.000992 Antibiotic biosynthesis Biosynthesis 0.000992 11 D08 0.0000682 0.000109 Xenobiotic degradation Degradation 0.000129 12 B04 0 0 SCFA biosynthesis Biosynthesis 0 13 B08 0 0 Aromatic compound biosynthesis Biosynthesis 0 14 B09 0 0 Metallophore biosynthesis Biosynthesis 0 15 D02 0 0 Polysaccharide degradation Degradation 0 16 D03 0 0 Sugar degradation Degradation 0 17 D04 0 0 Protein degradation Degradation 0 18 D07 0 0 Alcohol degradation Degradation 0 Using k-means to cluster the groups and check which MAGs cluster together: coords &lt;- gift_pcoa_vectors %&gt;% rownames_to_column(&quot;MAG&quot;) %&gt;% as_tibble() set.seed(123) km &lt;- kmeans(coords[, c(&quot;Axis.1&quot;, &quot;Axis.2&quot;)], centers = 4) coords &lt;- coords %&gt;% mutate(cluster = factor(km$cluster)) # centroids as a tibble for plotting centroids &lt;- as_tibble(km$centers) %&gt;% mutate(cluster = factor(1:nrow(km$centers))) ggplot(coords, aes(x = Axis.1, y = Axis.2, color = cluster)) + geom_point(size = 2, alpha = 0.8) + geom_point(data = centroids, aes(x = Axis.1, y = Axis.2, color = cluster), shape = 4, size = 5, stroke = 1.25) + # X marks centroids theme_minimal() + labs(title = paste0(&quot;PCoA colored by kmeans (k=4)&quot;), color = &quot;cluster&quot;) mags_by_cluster &lt;- split(coords$MAG, km$cluster) mags_by_cluster $`1` [1] &quot;EHM072417&quot; &quot;EHM029564&quot; &quot;GCF_019733675.1&quot; &quot;EHM049533&quot; &quot;GCF_018784125.1&quot; [6] &quot;GCF_022835355.1&quot; &quot;GCF_003475725.1&quot; &quot;EHM028668&quot; &quot;GCF_018587995.1&quot; &quot;GCA_959026225.1&quot; [11] &quot;GCF_022835335.1&quot; &quot;EHM048790&quot; &quot;EHM023781&quot; &quot;GCF_003464475.1&quot; &quot;GCF_018289335.1&quot; [16] &quot;EHM016318&quot; &quot;GCF_003439415.1&quot; $`2` [1] &quot;GCA_022784765.1&quot; &quot;EHM049769&quot; &quot;GCF_003459965.1&quot; &quot;EHM069263&quot; &quot;EHM016228&quot; [6] &quot;GCA_958416885.1&quot; &quot;GCA_008680675.1&quot; &quot;GCA_958404515.1&quot; &quot;GCA_030843875.1&quot; &quot;EHM020917&quot; [11] &quot;GCA_022776965.1&quot; &quot;GCA_959028115.1&quot; &quot;GCA_009774835.1&quot; &quot;GCA_958413795.1&quot; &quot;GCA_959023275.1&quot; [16] &quot;GCF_003474765.1&quot; &quot;GCF_029369685.1&quot; &quot;GCA_008679655.1&quot; $`3` [1] &quot;GCA_958435695.1&quot; &quot;EHM070114&quot; &quot;EHM049446&quot; &quot;GCF_001405935.1&quot; &quot;GCA_030844705.1&quot; [6] &quot;EHM016582&quot; &quot;GCA_030839725.1&quot; &quot;EHM075512&quot; &quot;EHM048917&quot; &quot;GCF_001406015.1&quot; [11] &quot;GCA_958447325.1&quot; &quot;GCA_015060925.1&quot; &quot;GCA_958416015.1&quot; &quot;GCA_030839525.1&quot; &quot;EHM039583&quot; $`4` [1] &quot;GCA_020809955.1&quot; &quot;GCA_014870645.1&quot; &quot;GCA_030842705.1&quot; &quot;GCA_959606485.1&quot; &quot;EHM027637&quot; [6] &quot;GCF_012843465.1&quot; &quot;GCF_003469715.1&quot; &quot;GCF_003471825.1&quot; &quot;EHM046460&quot; &quot;GCF_003469775.1&quot; [11] &quot;GCA_958422645.1&quot; &quot;GCA_022774455.1&quot; &quot;GCA_030842445.1&quot; &quot;GCA_958440685.1&quot; &quot;EHM016991&quot; [16] &quot;GCF_018784195.1&quot; &quot;EHM067538&quot; &quot;GCF_001405775.1&quot; &quot;GCA_030844325.1&quot; &quot;GCA_025757725.1&quot; [21] &quot;GCA_959600655.1&quot; &quot;GCA_958432605.1&quot; &quot;GCF_003437495.1&quot; &quot;GCF_003472045.1&quot; &quot;EHM064868&quot; [26] &quot;GCF_020687325.1&quot; &quot;GCF_003468915.1&quot; &quot;GCF_003467575.1&quot; &quot;GCF_018292145.1&quot; &quot;GCF_003469235.1&quot; [31] &quot;GCA_008679285.1&quot; &quot;GCA_958427815.1&quot; &quot;EHM047216&quot; &quot;GCA_958445425.1&quot; &quot;EHM023585&quot; [36] &quot;GCF_002206325.1&quot; &quot;GCF_003468605.1&quot; &quot;GCA_958371025.1&quot; &quot;GCF_018288975.1&quot; &quot;EHM031743&quot; [41] &quot;GCA_030841945.1&quot; &quot;GCA_959026965.1&quot; &quot;GCA_022771305.1&quot; &quot;GCA_003464145.1&quot; 5.2.1 Checking each cluster at once cluster1_MAGs &lt;- mags_by_cluster[[1]] genome_metadata %&gt;% filter(ID %in% cluster1_MAGs) # A tibble: 17 × 19 ID species completeness contamination genome_size GC N50 contigs host_species host_order &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016318 s__Par… 93.6 1.81 4085923 45.3 7.43e3 685 Strix aluco Strigifor… 2 EHM023781 s__Par… 93.5 1.92 4159834 45.6 1.68e4 369 Podarcis ga… Squamata 3 EHM028668 s__Par… 100.0 0.87 4684324 45 7.38e4 107 Timon lepid… Squamata 4 EHM029564 s__Par… 95.9 1.5 4476906 45 4.19e4 152 Timon lepid… Squamata 5 EHM048790 s__Par… 100.0 2.23 4479865 45 5.73e4 130 Lepus europ… Lagomorpha 6 EHM049533 s__Par… 100.0 0.65 5203783 45 1.24e5 64 Podarcis fi… Squamata 7 EHM072417 s__Par… 93.8 0.7 4365524 45 4.85e4 145 Timon lepid… Squamata 8 GCA_959026225… Paraba… 99.4 0.54 4672770 45.1 9.15e4 77 &lt;NA&gt; &lt;NA&gt; 9 GCF_018587995… Paraba… 99.4 0.27 5066235 45.0 3.04e5 80 &lt;NA&gt; &lt;NA&gt; 10 GCF_018784125… Paraba… 99.4 1.84 4988964 45.1 1.72e5 112 &lt;NA&gt; &lt;NA&gt; 11 GCF_018289335… Paraba… 99.4 0.71 5311305 45.2 5.20e6 3 &lt;NA&gt; &lt;NA&gt; 12 GCF_022835335… Paraba… 93.6 1.43 4806077 45.0 2.76e6 26 &lt;NA&gt; &lt;NA&gt; 13 GCF_022835355… Paraba… 93.6 1.46 4803375 45.0 2.76e6 29 &lt;NA&gt; &lt;NA&gt; 14 GCF_003439415… Paraba… 99.4 1.02 5294086 45.1 2.14e5 81 &lt;NA&gt; &lt;NA&gt; 15 GCF_019733675… Paraba… 99.4 1.49 5285880 45.2 3.21e5 33 &lt;NA&gt; &lt;NA&gt; 16 GCF_003475725… Paraba… 99.4 1.84 5176159 45.0 1.12e5 111 &lt;NA&gt; &lt;NA&gt; 17 GCF_003464475… Paraba… 99.4 1.9 5187286 44.9 2.09e5 72 &lt;NA&gt; &lt;NA&gt; # ℹ 9 more variables: host_class &lt;chr&gt;, assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, source &lt;chr&gt;, # gtdb_taxonomy &lt;chr&gt;, ncbi_country &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, mimag_medium_quality &lt;lgl&gt;, # gtdb_representative &lt;lgl&gt; cluster2_MAGs &lt;- mags_by_cluster[[2]] genome_metadata %&gt;% filter(ID %in% cluster2_MAGs) # A tibble: 18 × 19 ID species completeness contamination genome_size GC N50 contigs host_species host_order &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016228 s__Par… 97.3 0.92 4815605 45 3.27e4 224 Strix aluco Strigifor… 2 EHM020917 s__Par… 90.3 1.73 3472909 45.6 1.19e4 414 Strix aluco Strigifor… 3 EHM049769 s__Par… 95.2 1.01 4794833 45 6.88e4 107 Podarcis ga… Squamata 4 EHM069263 s__Par… 100 0.74 5112462 45 1.46e5 97 Rattus ratt… Rodentia 5 GCA_008680675… Paraba… 99.4 0.69 4962458 45.2 1.06e6 6 &lt;NA&gt; &lt;NA&gt; 6 GCA_022776965… Paraba… 97.3 0.26 4589485 45.3 1.64e5 44 &lt;NA&gt; &lt;NA&gt; 7 GCA_958413795… Paraba… 99.4 0.77 4948642 45.1 1.93e5 48 &lt;NA&gt; &lt;NA&gt; 8 GCA_959028115… Paraba… 99.4 0.51 4709637 45.1 1.35e5 54 &lt;NA&gt; &lt;NA&gt; 9 GCA_958416885… Paraba… 99.4 1.32 4704055 45.0 1.19e5 58 &lt;NA&gt; &lt;NA&gt; 10 GCA_958404515… Paraba… 99.4 0.93 5100500 44.9 1.25e5 61 &lt;NA&gt; &lt;NA&gt; 11 GCA_030843875… Paraba… 96.0 2.28 4410710 45.2 1.27e4 475 &lt;NA&gt; &lt;NA&gt; 12 GCA_009774835… Paraba… 99.2 0.89 4866783 45.1 9.64e4 71 &lt;NA&gt; &lt;NA&gt; 13 GCA_022784765… Paraba… 99.4 1.14 4816138 45.1 1.29e5 55 &lt;NA&gt; &lt;NA&gt; 14 GCA_959023275… Paraba… 99.4 0.73 4832844 45.0 1.39e5 54 &lt;NA&gt; &lt;NA&gt; 15 GCA_008679655… Paraba… 97.8 0.52 5036842 45.0 7.93e5 11 &lt;NA&gt; &lt;NA&gt; 16 GCF_003474765… Paraba… 99.4 1.07 5043355 45.1 1.75e5 83 &lt;NA&gt; &lt;NA&gt; 17 GCF_003459965… Paraba… 99.4 0.83 5151392 44.9 2.28e5 59 &lt;NA&gt; &lt;NA&gt; 18 GCF_029369685… Paraba… 99.4 1.46 5493583 45.1 5.39e6 2 &lt;NA&gt; &lt;NA&gt; # ℹ 9 more variables: host_class &lt;chr&gt;, assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, source &lt;chr&gt;, # gtdb_taxonomy &lt;chr&gt;, ncbi_country &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, mimag_medium_quality &lt;lgl&gt;, # gtdb_representative &lt;lgl&gt; cluster3_MAGs &lt;- mags_by_cluster[[3]] genome_metadata %&gt;% filter(ID %in% cluster3_MAGs) # A tibble: 15 × 19 ID species completeness contamination genome_size GC N50 contigs host_species host_order &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016582 s__Par… 92.2 1.17 3706610 45.7 7507 618 Strix aluco Strigifor… 2 EHM039583 s__Par… 98.5 1.78 4472794 45 29681 243 Sciurus vul… Rodentia 3 EHM048917 s__Par… 94.6 1.35 3837800 46 12164 428 Lepus europ… Lagomorpha 4 EHM049446 s__Par… 90.1 0.6 3591722 46 12732 405 Lepus europ… Lagomorpha 5 EHM070114 s__Par… 100.0 2.39 4728690 45 63727 110 Rattus ratt… Rodentia 6 EHM075512 s__Par… 100.0 2.34 4690486 45 64909 112 Rattus ratt… Rodentia 7 GCA_958416015… Paraba… 92.4 0.18 3902302 46.4 9412 497 &lt;NA&gt; &lt;NA&gt; 8 GCA_958447325… Paraba… 99.4 0.61 4709435 45.0 118754 66 &lt;NA&gt; &lt;NA&gt; 9 GCA_030844705… Paraba… 97.7 0.85 4586771 45.3 134207 49 &lt;NA&gt; &lt;NA&gt; 10 GCA_030839525… Paraba… 97.9 1.68 4512812 45.1 15103 417 &lt;NA&gt; &lt;NA&gt; 11 GCA_015060925… Paraba… 92.9 0 2539824 39.1 102430 41 &lt;NA&gt; &lt;NA&gt; 12 GCA_030839725… Paraba… 92.7 1.74 4293293 44.8 29168 238 &lt;NA&gt; &lt;NA&gt; 13 GCA_958435695… Paraba… 99.4 1.06 4635291 45.0 106588 71 &lt;NA&gt; &lt;NA&gt; 14 GCF_001405935… Paraba… 99.4 1.5 5099398 45.0 277147 45 &lt;NA&gt; &lt;NA&gt; 15 GCF_001406015… Paraba… 99.4 0.62 NA NA NA NA &lt;NA&gt; &lt;NA&gt; # ℹ 9 more variables: host_class &lt;chr&gt;, assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, source &lt;chr&gt;, # gtdb_taxonomy &lt;chr&gt;, ncbi_country &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, mimag_medium_quality &lt;lgl&gt;, # gtdb_representative &lt;lgl&gt; cluster4_MAGs &lt;- mags_by_cluster[[4]] genome_metadata %&gt;% filter(ID %in% cluster4_MAGs) # A tibble: 44 × 19 ID species completeness contamination genome_size GC N50 contigs host_species host_order &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016991 s__Par… 99.0 0.38 4748219 44.9 1.17e5 76 Podarcis pi… Squamata 2 EHM023585 s__Par… 92.8 2.18 3889519 45.6 8.65e3 607 Sciurus vul… Rodentia 3 EHM027637 s__Par… 93.5 2.05 4160022 45.3 1.28e4 526 Cathartes a… Accipitri… 4 EHM031743 s__Par… 93.5 1.99 4260825 45 2.13e4 296 Canis famil… Carnivora 5 EHM046460 s__Par… 99.5 1.66 4335884 45 3.87e4 181 Cathartes a… Accipitri… 6 EHM047216 s__Par… 99.9 1.04 4517903 45 6.39e4 124 Lepus europ… Lagomorpha 7 EHM064868 s__Par… 93.9 0.57 4141119 45 1.32e4 435 Lepus europ… Lagomorpha 8 EHM067538 s__Par… 93.1 1.71 4147480 46 1.27e4 485 Lepus europ… Lagomorpha 9 GCA_025757725… Paraba… 99.4 0.99 4848511 45.1 4.85e6 1 &lt;NA&gt; &lt;NA&gt; 10 GCA_008679285… Paraba… 95.8 1.54 4711604 45.1 3.08e5 21 &lt;NA&gt; &lt;NA&gt; # ℹ 34 more rows # ℹ 9 more variables: host_class &lt;chr&gt;, assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, source &lt;chr&gt;, # gtdb_taxonomy &lt;chr&gt;, ncbi_country &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, mimag_medium_quality &lt;lgl&gt;, # gtdb_representative &lt;lgl&gt; metadata_with_cluster &lt;- genome_metadata %&gt;% left_join(coords %&gt;% select(MAG, cluster), by = c(&quot;ID&quot; = &quot;MAG&quot;)) metadata_with_cluster %&gt;% group_by(cluster, source) %&gt;% summarise(n = n(), .groups = &quot;drop&quot;) %&gt;% arrange(cluster, desc(n)) # A tibble: 8 × 3 cluster source n &lt;fct&gt; &lt;chr&gt; &lt;int&gt; 1 1 GTDB 10 2 1 EHI 7 3 2 GTDB 14 4 2 EHI 4 5 3 GTDB 9 6 3 EHI 6 7 4 GTDB 36 8 4 EHI 8 # Group summaries metadata_with_cluster %&gt;% group_by(cluster) %&gt;% summarise(mean_genome_size = mean(genome_size, na.rm = TRUE), median_contamination = median(contamination, na.rm = TRUE), .groups = &quot;drop&quot;) # A tibble: 4 × 3 cluster mean_genome_size median_contamination &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; 1 1 4826370. 1.46 2 2 4825680. 0.905 3 3 4236231. 1.17 4 4 4702288. 1.04 Plots ggplot(metadata_with_cluster, aes(x = genome_size, y = GC, col = cluster))+ geom_point()+ theme_bw() Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_point()`). ggplot(metadata_with_cluster, aes(x = assembly_type, y = source, col = cluster))+ geom_point()+ theme_bw() ggplot(metadata_with_cluster, aes(x = cluster, y = genome_size, col = cluster))+ geom_point()+ theme_bw() Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_point()`). #Aggregate bundle-level GIFTs into the compound level GIFTs_elements &lt;- to.elements(genome_gifts,GIFT_db) #Aggregate element-level GIFTs into the function level GIFTs_functions &lt;- to.functions(GIFTs_elements,GIFT_db) #Aggregate function-level GIFTs into overall Biosynthesis, Degradation and Structural GIFTs GIFTs_domains &lt;- to.domains(GIFTs_functions,GIFT_db) GIFTs_elements %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;MAG&quot;)%&gt;% pivot_longer(!MAG,names_to=&quot;trait&quot;,values_to=&quot;gift&quot;) %&gt;% left_join(metadata_with_cluster, by = join_by(MAG == ID)) %&gt;% mutate(functionid = substr(trait, 1, 3)) %&gt;% mutate(trait = case_when( trait %in% GIFT_db$Code_element ~ GIFT_db$Element[match(trait, GIFT_db$Code_element)], TRUE ~ trait )) %&gt;% mutate(functionid = case_when( functionid %in% GIFT_db$Code_function ~ GIFT_db$Function[match(functionid, GIFT_db$Code_function)], TRUE ~ functionid )) %&gt;% mutate(trait=factor(trait,levels=unique(GIFT_db$Element))) %&gt;% mutate(functionid=factor(functionid,levels=unique(GIFT_db$Function))) %&gt;% ggplot(aes(x=MAG,y=trait,fill=gift)) + geom_tile(colour=&quot;white&quot;, linewidth=0.2)+ scale_fill_gradientn(colours=rev(c(&quot;#d53e4f&quot;, &quot;#f46d43&quot;, &quot;#fdae61&quot;, &quot;#fee08b&quot;, &quot;#e6f598&quot;, &quot;#abdda4&quot;, &quot;#ddf1da&quot;)))+ facet_grid(functionid ~ cluster, scales=&quot;free&quot;,space=&quot;free&quot;) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.text.y = element_text(size=6), strip.text.y = element_text(angle = 0) ) + labs(y=&quot;Traits&quot;,x=&quot;Samples&quot;,fill=&quot;GIFT&quot;) library(RColorBrewer) library(reshape2) GIFTs_elements %&gt;% reshape2::melt() %&gt;% rename(Genome = Var1, Code_element = Var2, GIFT = value) %&gt;% inner_join(GIFT_db,by=&quot;Code_element&quot;) %&gt;% ggplot(., aes(x=Code_element, y=Genome, fill=GIFT, group=Code_function))+ geom_tile()+ scale_y_discrete(guide = guide_axis(check.overlap = TRUE))+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+ scale_fill_gradientn(limits = c(0,1), colours=brewer.pal(7, &quot;YlGnBu&quot;))+ facet_grid(. ~ Code_function, scales = &quot;free&quot;, space = &quot;free&quot;)+ theme_grey(base_size=8)+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),strip.text.x = element_text(angle = 90)) Warning in inner_join(., GIFT_db, by = &quot;Code_element&quot;): Detected an unexpected many-to-many relationship between `x` and `y`. ℹ Row 753 of `x` matches multiple rows in `y`. ℹ Row 1 of `y` matches multiple rows in `x`. ℹ If a many-to-many relationship is expected, set `relationship = &quot;many-to-many&quot;` to silence this warning. head(GIFT_db) Code_bundle Code_element Code_function Domain Function Element 1 B010101 B0101 B01 Biosynthesis Nucleic acid biosynthesis Inosinic acid (IMP) 2 B010201 B0102 B01 Biosynthesis Nucleic acid biosynthesis Uridylic acid (UMP) 3 B010301 B0103 B01 Biosynthesis Nucleic acid biosynthesis UDP/UTP 4 B010401 B0104 B01 Biosynthesis Nucleic acid biosynthesis CDP/CTP 5 B010501 B0105 B01 Biosynthesis Nucleic acid biosynthesis ADP/ATP 6 B010601 B0106 B01 Biosynthesis Nucleic acid biosynthesis GDP/GTP Definition 1 K00764 (K01945,K11787,K11788,K13713) (K00601,K11175,K08289,K11787,K01492) (K01952,(K23269+K23264+K23265),(K23270+K23265)) (K01933,K11787,(K11788 (K01587,K11808,(K01589 K01588)))) (K01923,K01587,K13713) K01756 (K00602,(K01492,(K06863 K11176))) 2 (K11540,((K11541 K01465),((K01954,(K01955+K01956)) ((K00609+K00610),K00608) K01465))) (K00226,K00254,K17828) (K13421,(K00762 K01591)) 3 (K13800,K13809,K09903) 4 (K00940,K18533) K01937 5 K01939 K01756 (K00939,K18532,K18533,K00944) K00940 6 K00088 K01951 K00942 (K00940,K18533) GIFT_db%&gt;% filter(Code_function == &quot;D09&quot;) Code_bundle Code_element Code_function Domain Function Element 1 D090101 D0901 D09 Degradation Antibiotic degradation Penicillin 2 D090201 D0902 D09 Degradation Antibiotic degradation Carbapenem 3 D090301 D0903 D09 Degradation Antibiotic degradation Cephalosporin 4 D090401 D0904 D09 Degradation Antibiotic degradation Oxacillin 5 D090501 D0905 D09 Degradation Antibiotic degradation Streptogramin 6 D090601 D0906 D09 Degradation Antibiotic degradation Fosfomycin 7 D090701 D0907 D09 Degradation Antibiotic degradation Tetracycline 8 D090801 D0908 D09 Degradation Antibiotic degradation Macrolide 9 D091001 D0910 D09 Degradation Antibiotic degradation Chloramphenicol 10 D091101 D0911 D09 Degradation Antibiotic degradation Lincosamide 11 D091201 D0912 D09 Degradation Antibiotic degradation Streptothricin Definition 1 K18698,K18699,K18796,K18767,K18797,K19097,K19317,K18768,K18970,K19316,K22346,K18795,K19218,K19217,K17836,K18766 2 K17837,K18782,K18781,K18780,K19099,K19216 3 K19095,K19096,K19100,K19101,K19214,K19215,K20319,K20320,K01467 4 K17838,K18790,K18791,K19098,K18792,K19213,K21276,K18793,K18971,K22352,K19209,K18976,K18973,K18794,K18972,K21277,K19210,K19211,K19212,K22335,K19319,K22331,K22351,K19320,K19318,K19321,K19322,K21266,K22334,K22333,K22332 5 K19349,K19350 6 K21252 7 K08151,K08168,K18214,K18218,K18220,K18221 8 K06979,K08217,K18230,K18231,K21251 9 K00638,K08160,K18552,K18553,K18554,K19271 10 K18236,K19349,K19350,K19545 11 K19273,K20816 GIFTs_elements %&gt;% melt() %&gt;% rename(Genome = Var1, Code_element = Var2, GIFT = value) %&gt;% inner_join(GIFT_db, by = &quot;Code_element&quot;) %&gt;% filter(str_starts(Code_element, &quot;D09&quot;)) %&gt;% # only antibiotic degradation left_join(metadata_with_cluster, by = join_by(Genome == ID)) %&gt;% mutate(cluster = factor(cluster)) %&gt;% droplevels() %&gt;% # Order genomes by cluster arrange(cluster, Genome) %&gt;% ggplot(aes(x = Code_element, y = Genome, fill = GIFT)) + geom_tile() + scale_y_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_fill_gradientn(limits = c(0,1), colours = brewer.pal(7, &quot;YlGnBu&quot;)) + facet_wrap(~ cluster, scales = &quot;free_y&quot;, ncol = 1) + theme_grey(base_size = 8) + theme( axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), strip.text.x = element_text(angle = 0) ) Warning in inner_join(., GIFT_db, by = &quot;Code_element&quot;): Detected an unexpected many-to-many relationship between `x` and `y`. ℹ Row 753 of `x` matches multiple rows in `y`. ℹ Row 1 of `y` matches multiple rows in `x`. ℹ If a many-to-many relationship is expected, set `relationship = &quot;many-to-many&quot;` to silence this warning. "],["antibiotic-resistance-analysis.html", "Chapter 6 Antibiotic resistance analysis 6.1 Building an AMR abundance table", " Chapter 6 Antibiotic resistance analysis 6.1 Building an AMR abundance table amr_abundance &lt;- genome_annotations %&gt;% filter(resistance_type == &quot;AMR&quot;) %&gt;% group_by(mag_id, resistance_target) %&gt;% summarise(count = n(), .groups=&quot;drop&quot;) %&gt;% tidyr::pivot_wider( names_from = resistance_target, values_from = count, values_fill = 0 ) amr_cluster &lt;- amr_abundance %&gt;% dplyr::full_join(metadata_with_cluster, by= join_by(mag_id == ID)) amr_matrix &lt;- amr_abundance %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% as.matrix() min_val &lt;- 0 max_val &lt;- max(amr_matrix, na.rm = TRUE) library(viridis) colors &lt;- viridis(100, option = &quot;viridis&quot;) breaks &lt;- seq(min_val, max_val, length.out = 101) pheatmap( amr_matrix, color = colors, cluster_rows = TRUE, cluster_cols = TRUE, fontsize = 9, border_color = NA ) amr_scaled &lt;- scale(amr_matrix, center = TRUE, scale = TRUE) min_val &lt;- 0 max_val &lt;- max(amr_scaled, na.rm = TRUE) library(viridis) colors &lt;- viridis(100, option = &quot;viridis&quot;) breaks &lt;- seq(min_val, max_val, length.out = 101) pheatmap( amr_scaled, color = colors, cluster_rows = TRUE, cluster_cols = TRUE, fontsize = 9, border_color = NA ) amr_presence &lt;- amr_abundance %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% mutate(across(everything(), ~ ifelse(. &gt; 0, 1, 0)))%&gt;% as.matrix() pheatmap( amr_presence, cluster_rows = TRUE, cluster_cols = TRUE, color = c(&quot;white&quot;, &quot;black&quot;), # white = absent, black = present legend_breaks = c(0,1), legend_labels = c(&quot;Absent&quot;, &quot;Present&quot;), border_color = NA ) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
