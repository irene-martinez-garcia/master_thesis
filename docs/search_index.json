[["index.html", "AlberdiLab | Comparative metagenomics MSc project Chapter 1 Introduction 1.1 Prepare the R environment", " AlberdiLab | Comparative metagenomics MSc project Irene Martínez, M Thomas P Gilbert, Antton Alberdi1 Last update: 2026-01-26 Chapter 1 Introduction This webbook contains all the code used for data analysis for the comparative metagenomics analysis of gut microbiome bacterial species in several vertebrates. 1.1 Prepare the R environment 1.1.1 Environment To reproduce all the analyses locally, clone this repository in your computer using: RStudio &gt; New Project &gt; Version Control &gt; Git And indicating the following git repository: https://github.com/irene-martinez-garcia/comparative_metagenomics.git Once the R project has been created, follow the instructions and code chunks shown in this webbook. 1.1.2 Libraries The following R packages are required for the data analysis. # Base library(R.utils) library(knitr) library(tidyverse) #library(devtools) library(tinytable) library(rairtable) library(janitor) library(broom) # For tree handling library(ape) library(phyloseq) library(phytools) # For plotting library(ggplot2) library(ggrepel) library(ggpubr) library(ggnewscale) library(gridExtra) library(ggtreeExtra) library(ggtree) library(ggh4x) library(UpSetR) library(viridis) # For statistics library(spaa) library(vegan) library(Rtsne) library(geiger) library(distillR) library(ANCOMBC) library(lme4) library(nlme) library(pairwiseAdonis) library(emmeans) library(pheatmap) library(rstatix) library(uwot) University of Copenhagen, antton.alberdi@sund.ku.dk↩︎ "],["data-preparation.html", "Chapter 2 Data preparation 2.1 Searching for the MAGs 2.2 Downloading the MAGs and generating data 2.3 R Studio- Data Analysis 2.4 Wrap working objects", " Chapter 2 Data preparation 2.1 Searching for the MAGs Choose the MAGs In this case, we will be working with Parabacteroides distasonis. In the EHI database, select the MAGs with &gt; 90% completeness and &lt; 2.5 contamination. Do the same in the GTDB, but also filter for isolation source CONTAINS feces. 2.2 Downloading the MAGs and generating data Download genome indices and metadata Download the EHI_MAG index for each species (in /data/mags_metadata folder) and the curl file and search metadata tsv from the GTDB and place in each species directory in Mjolnir. 2.5) Extract genome metadata - Use the GTDB search tsv to run this script to obtain more metadata. (modify script a bit to make it scalable). python scripts/extract_gtdb_metadata.py Create the master index Run the create_index.R script to create an index of all the MAGs and the download paths (needs a list of species as input and right now it is hardcoded in the script) conda activate mags_r_env Rscript scripts/create_index.R Run the downloading_mags.smk to download all the genomes snakemake -s snakefiles/downloading_mags.smk \\ --executor slurm \\ --jobs 50 \\ --rerun-incomplete \\ --keep-going #testing with the HUMAN_EHI snakemake -s snakefiles/downloading_and_unzipping.smk \\ --executor slurm \\ --jobs 50 \\ --rerun-incomplete \\ --keep-going Unzip all the MAGs and make sure they are in the same folder: run (maybe add this to the downloading_mags.smk) bash scripts/unzip_mags.sh parabacteroides_distasonis bash scripts/unzip_mags.sh phocaeicola_vulgatus Make a screen session for each species. screen -S parabacteroides_distasonis Run drakkar annotating_function.smk to re-annotate all the MAGs: drakkar annotating -b /maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis/mags/unzipped -o /maps/projects/alberdilab/people/pjq449/comparative_metagenomics --env_path /projects/alberdilab/data/environments/drakkar --annotation-type function Annotate with prokka and make phylogenetic tree with getphylo snakemake -s snakefiles/prokka_and_pangenome.smk --profile snakefiles/slurm_profile Run genome_mapping.sh to map the mag ids to the corresponding names Run drep sbatch scripts/drep_compare.slurm Run create_pangolin_input.R to create the input file ppanggolin needs conda activate mags_r_env Rscript scripts/create_pangolin_input.R #or if we want to use the annotation files by prokka: Rscript scripts/create_pangolin_input_gff.R Pangenome analysis with ppanggolin conda activate ppanggolin ppanggolin all --fasta /maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis/ppanggolin_input.tsv #with annotation files: ppanggolin all --anno maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis/genome_gff_paths.tsv --rarefaction ##if you are runnning this in the species folder, write local path not absolute. 2.3 R Studio- Data Analysis 2.3.1 EHI MAGs ehi_mags &lt;- read_csv(&quot;data/ehi_metadata_location.csv&quot;) Rows: 8857 Columns: 54 ── Column specification ──────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (38): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, ... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, ... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.3.2 Prepare color scheme AlberdiLab projects use unified color schemes developed for the Earth Hologenome Initiative, to facilitate figure interpretation. ehi_mags_p &lt;- ehi_mags %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(ehi_mags_p, by=join_by(phylum == phylum)) %&gt;% dplyr::select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% pull(colors, name=phylum) source_colors &lt;- c(EHI = &quot;#8BC63F&quot;, GTDB = &quot;#2D522D&quot;) #source_colors &lt;- c(EHI = &quot;#8BC63F&quot;, GTDB = &quot;#A90D00&quot;) 2.3.3 Sample metadata gtdb_search_metadata &lt;- read_tsv(&quot;data/p_dist_gtdb_metadata.tsv&quot;) Rows: 69 Columns: 9 ── Column specification ──────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (6): Accession, Organism Name, NCBI Taxonomy, GTDB Taxonomy, GTDB Type Material, Isolation Source dbl (2): CheckM Completeness, CheckM2 Contamination lgl (1): GTDB Representative of Species ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. gtdb_accession_metadata&lt;- read_tsv(&quot;data/parabacteroides_distasonis_GTDB_accession_metadata.tsv&quot;) Rows: 67 Columns: 115 ── Column specification ──────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (69): accession, checkm2_model, checkm_marker_lineage, gtdb_genome_representative, gtdb_taxonomy, gtdb_... dbl (39): ambiguous_bases, checkm2_completeness, checkm2_contamination, checkm_completeness, checkm_contami... lgl (5): gtdb_representative, gtdb_type_species_of_genus, mimag_high_quality, mimag_low_quality, mimag_med... date (2): ncbi_date, ncbi_seq_rel_date ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. ehi_metadata &lt;- read_tsv(&quot;data/mags_metadata/parabacteroides_distasonis_metadata.tsv&quot;) %&gt;% mutate(GC = as.numeric(str_remove(GC, &quot;%&quot;))) Rows: 25 Columns: 52 ── Column specification ──────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, ... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, ... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. location_data&lt;- ehi_mags %&gt;% dplyr::select(ID, locality, country) ehi_metadata_location &lt;- left_join(ehi_metadata, location_data, by = &quot;ID&quot;) 2.3.4 Load genome mapping genome_mapping &lt;- read_tsv(&quot;data/genome_mapping.tsv&quot;) Rows: 69 Columns: 2 ── Column specification ──────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (2): genome_id, genome_file ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. gtdb_accession_metadata_2 &lt;- left_join(gtdb_accession_metadata, genome_mapping, by = c(&quot;search_accession&quot; = &quot;genome_id&quot;) ) #Make a genome_mapping with all the MAGs (including EHI) #First select the ehi IDs from ehi_metadata ehi_ids &lt;- ehi_metadata %&gt;% dplyr::select(ID, mag_name) %&gt;% dplyr::rename(genome_id = ID, genome_file = mag_name) ehi_ids$genome_file &lt;- sub(&quot;\\\\.fa$&quot;, &quot;&quot;, ehi_ids$genome_file)#remove .fa genome_mapping_all &lt;- genome_mapping %&gt;% bind_rows(ehi_ids) # Prepare EHI metadata with standardized column names ehi_clean &lt;- ehi_metadata_location%&gt;% dplyr::select( ID, species = species, completeness, contamination, genome_size = size, GC, N50, contigs, host_species, host_order, host_class, assembly_type, isolation_source= sample_type, mag_name, eha_number, locality, country ) %&gt;% mutate(source = &quot;EHI&quot;) # Prepare GTDB metadata # Join search and accession metadata gtdb_metadata &lt;- full_join(gtdb_accession_metadata_2, gtdb_search_metadata, by = c(&quot;search_accession&quot; = &quot;Accession&quot;) ) # Prepare GTDB metadata gtdb_clean &lt;- gtdb_metadata %&gt;% dplyr::select( ID = search_accession, species = &quot;Organism Name&quot;, completeness = &quot;CheckM Completeness&quot;, contamination = &quot;CheckM2 Contamination&quot;, gtdb_taxonomy = &quot;GTDB Taxonomy&quot;, isolation_source = &quot;Isolation Source&quot;, genome_size, GC = gc_percentage, N50 = n50_contigs, contigs = contig_count, country = ncbi_country, mimag_high_quality, mimag_medium_quality, gtdb_representative, mag_name = genome_file, ncbi_date )%&gt;% mutate(source = &quot;GTDB&quot;) #Join genome_metadata &lt;- bind_rows(ehi_clean, gtdb_clean) genome_metadata_clean &lt;- genome_metadata %&gt;% separate_wider_delim( cols = country, delim = regex(&quot;:\\\\s*&quot;), names = c(&quot;country_clean&quot;, &quot;extra_locality&quot;), too_few = &quot;align_start&quot; ) %&gt;% mutate( locality = case_when( !is.na(extra_locality) &amp; !is.na(locality) ~ paste(extra_locality, locality, sep = &quot;, &quot;), !is.na(extra_locality) ~ extra_locality, TRUE ~ locality ) ) %&gt;% dplyr::rename(country = country_clean) genome_metadata &lt;- genome_metadata_clean %&gt;% mutate( # United States to USA country = case_match( country, &quot;United States&quot; ~ &quot;USA&quot;, .default = country ), # Continent column continent = case_when( country %in% c(&quot;Spain&quot;, &quot;Italy&quot;, &quot;Greece&quot;, &quot;Portugal&quot;, &quot;Malta&quot;, &quot;Ireland&quot;, &quot;Germany&quot;, &quot;United Kingdom&quot;) ~ &quot;Europe&quot;, country %in% c(&quot;USA&quot;, &quot;Canada&quot;, &quot;Greenland&quot;) ~ &quot;North America&quot;, country %in% c(&quot;South Korea&quot;, &quot;China&quot;, &quot;Japan&quot;) ~ &quot;Asia&quot;, country == &quot;Australia&quot; ~ &quot;Oceania&quot;, TRUE ~ NA_character_ # Handle &quot;none&quot; and NA ) ) # Read master index master_index &lt;- read_tsv(&quot;data/master_mag_index.tsv&quot;) %&gt;% filter(species == &quot;parabacteroides_distasonis&quot;) %&gt;% mutate( # Extract the actual genome identifier from out_path genome_identifier = case_when( # For EHI: extract EHA00531_bin.1 from the filename str_detect(out_path, &quot;EHA&quot;) ~ str_extract(out_path, &quot;EHA[0-9]+_bin\\\\.[0-9]+&quot;), # For NCBI: use the ID as is (GCA/GCF number) TRUE ~ ID ) ) Rows: 287 Columns: 4 ── Column specification ──────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (4): species, ID, MAG_url, out_path ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. # Check the mapping print(&quot;Master index mapping:&quot;) [1] &quot;Master index mapping:&quot; master_index %&gt;% dplyr::select(ID, genome_identifier, out_path) %&gt;% head(10) %&gt;% print() # A tibble: 10 × 3 ID genome_identifier out_path &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016228 EHA00531_bin.1 data/parabacteroides_distasonis/mags/EHA00531_bin.1.fa.gz 2 EHM016318 EHA00539_bin.6 data/parabacteroides_distasonis/mags/EHA00539_bin.6.fa.gz 3 EHM016582 EHA00535_bin.6 data/parabacteroides_distasonis/mags/EHA00535_bin.6.fa.gz 4 EHM016991 EHA00726_bin.13 data/parabacteroides_distasonis/mags/EHA00726_bin.13.fa.gz 5 EHM020917 EHA01202_bin.66 data/parabacteroides_distasonis/mags/EHA01202_bin.66.fa.gz 6 EHM023585 EHA00928_bin.90 data/parabacteroides_distasonis/mags/EHA00928_bin.90.fa.gz 7 EHM023781 EHA01439_bin.44 data/parabacteroides_distasonis/mags/EHA01439_bin.44.fa.gz 8 EHM027637 EHA01634_bin.14 data/parabacteroides_distasonis/mags/EHA01634_bin.14.fa.gz 9 EHM028668 EHA01281_bin.18 data/parabacteroides_distasonis/mags/EHA01281_bin.18.fa.gz 10 EHM029564 EHA01845_bin.103 data/parabacteroides_distasonis/mags/EHA01845_bin.103.fa.gz # Read contig-to-genome mapping contig_to_genome &lt;- read_tsv(&quot;data/p_dist_contig_to_genome.tsv&quot;, col_names = c(&quot;contig&quot;, &quot;genome_filename&quot;)) Rows: 13976 Columns: 2 ── Column specification ──────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (2): contig, genome_filename ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.3.5 Genome annotations # Read annotations and add IDs genome_annotations &lt;- read_tsv(&quot;data/gene_annotations.tsv.xz&quot;) %&gt;% mutate(contig = sub(&quot;_[^_]*$&quot;, &quot;&quot;, gene)) %&gt;% left_join(contig_to_genome, by = &quot;contig&quot;) %&gt;% # Extract accession from genome filename mutate( accession = case_when( # For NCBI genomes: extract GCA/GCF number str_detect(genome_filename, &quot;^GC[AF]_&quot;) ~ str_extract(genome_filename, &quot;^GC[AF]_[0-9]+\\\\.[0-9]+&quot;), # For EHI genomes: the filename IS the identifier TRUE ~ genome_filename ) ) %&gt;% # Join with master index using genome_identifier left_join( master_index %&gt;% dplyr::select(mag_id = ID, genome_identifier), by = c(&quot;accession&quot; = &quot;genome_identifier&quot;) ) %&gt;% dplyr::select(gene, mag_id, genome = genome_filename, contig, accession, everything()) %&gt;% filter(!is.na(mag_id)) Warning: One or more parsing issues, call `problems()` on your data frame for details, e.g.: dat &lt;- vroom(...) problems(dat) Rows: 374229 Columns: 13 ── Column specification ──────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (11): gene, strand, kegg, ec, pfam, cazy, resistance_type, resistance_target, vf, vf_type, signalp dbl (2): start, end ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.3.6 Distill annotations into GIFTs genome_gifts &lt;- distill(genome_annotations,GIFT_db,genomecol= 2, annotcol=c(9,10,11,12), verbosity = F) Identifiers in the annotation table: 1648 Identifiers in the database: 1547 Identifiers in both: 201 Percentage of annotation table identifiers used for distillation: 12.2% Percentage of database identifiers used for distillation: 12.99% 2.3.7 Load getphylo trees genome_metadata$mag_name &lt;- sub(&quot;\\\\.fa$&quot;, &quot;&quot;, genome_metadata$mag_name)#remove .fa from the mag names so that they match the tree ids getphylo_tree &lt;- read_tree(&quot;data/combined_alignment.tree&quot;) getphylo_tree$tip.label &lt;- gsub(&quot;&#39;&quot;, &quot;&quot;, getphylo_tree$tip.label) tip_df &lt;- data.frame(label = getphylo_tree$tip.label) %&gt;% left_join(genome_metadata, by = c(&quot;label&quot; = &quot;mag_name&quot;)) #replace long mag names with IDs getphylo_tree$tip.label &lt;- tip_df$ID 2.4 Wrap working objects All working objects are wrapped into a single Rdata object to facilitate downstream usage. save(ehi_mags, phylum_colors, genome_annotations, genome_gifts, contig_to_genome, gtdb_metadata, ehi_metadata, master_index, genome_metadata, source_colors, getphylo_tree, file = &quot;data/data.Rdata&quot;) "],["ehi-mags-exploration.html", "Chapter 3 EHI MAGs exploration", " Chapter 3 EHI MAGs exploration 3.0.1 EHI MAGs load(&quot;data/data.Rdata&quot;) ehi_mags &lt;- read_csv(&quot;data/ehi_mags.csv&quot;) Rows: 8846 Columns: 52 ── Column specification ──────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, ... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, ... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. colnames(ehi_mags) [1] &quot;ID&quot; &quot;mag_name&quot; &quot;link_to_assembly&quot; [4] &quot;AB_batch&quot; &quot;eha_number&quot; &quot;GTDB_version&quot; [7] &quot;GTDB_release&quot; &quot;domain&quot; &quot;phylum&quot; [10] &quot;class&quot; &quot;order&quot; &quot;family&quot; [13] &quot;genus&quot; &quot;species&quot; &quot;fastani_ani&quot; [16] &quot;closest_placement_ani&quot; &quot;closest_placement_af&quot; &quot;completeness&quot; [19] &quot;contamination&quot; &quot;size&quot; &quot;GC&quot; [22] &quot;N50&quot; &quot;coding_density&quot; &quot;contigs&quot; [25] &quot;number_genes&quot; &quot;number_unannotated_genes&quot; &quot;DM_batch&quot; [28] &quot;host_species&quot; &quot;host_order&quot; &quot;host_class&quot; [31] &quot;MAG_url&quot; &quot;anno_url&quot; &quot;kegg_url&quot; [34] &quot;annotated&quot; &quot;taxonomy_level&quot; &quot;assembly_type&quot; [37] &quot;sample_type&quot; &quot;gbk_url&quot; &quot;kegg_hits&quot; [40] &quot;Capture ID&quot; &quot;percent_unannotated_genes&quot; &quot;percent_unannotated_kegg&quot; [43] &quot;dereplicated&quot; &quot;metagenomic source&quot; &quot;completeness software&quot; [46] &quot;binning software&quot; &quot;assembly quality&quot; &quot;binning parameters&quot; [49] &quot;taxonomic identity marker&quot; &quot;isolation_source&quot; &quot;assembly software&quot; [52] &quot;Submission&quot; Check contamination and completeness genome_biplot &lt;- ehi_mags %&gt;% dplyr::select(c(phylum,completeness,contamination,size)) %&gt;% ggplot(aes(x=completeness,y=contamination,size=size,color=phylum)) + geom_point(alpha=0.7) + xlim(c(70,100)) + ylim(c(10,0)) + scale_color_manual(values=phylum_colors) + labs(y= &quot;Contamination&quot;, x = &quot;Completeness&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;) #Generate contamination boxplot genome_contamination &lt;- ehi_mags %&gt;% ggplot(aes(y=contamination)) + ylim(c(10,0)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0.40, 0),&quot;inches&quot;)) #add bottom-margin (top, right, bottom, left) genome_completeness &lt;- ehi_mags %&gt;% ggplot(aes(x=completeness)) + xlim(c(70,100)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0, 0.50),&quot;inches&quot;)) #add left-margin (top, right, bottom, left) #Render composite figure #pdf(&quot;figures/completeness_contamination.pdf&quot;,width=10, height=5) grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination), layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3))) Warning: Removed 1721 rows containing non-finite outside the scale range (`stat_boxplot()`). Warning: No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. Warning: Removed 1721 rows containing missing values or values outside the scale range (`geom_point()`). Warning: Removed 1 row containing non-finite outside the scale range (`stat_boxplot()`). Filter by completeness and contamination ehi_mags_filtered &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5) 3.0.2 Host classes species_hostclass_counts &lt;- ehi_mags %&gt;% filter(!is.na(species), species != &quot;&quot;) %&gt;% filter(!is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_mags = n(), n_host_classes = n_distinct(host_class), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), phylum = paste(unique(phylum), collapse = &quot;, &quot;) ) %&gt;% arrange(desc(n_host_classes)) species_selection &lt;- species_hostclass_counts %&gt;% filter(n_host_classes &gt;= 3) species_selection # A tibble: 34 × 5 species n_mags n_host_classes host_classes phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Hafnia alvei 61 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 2 s__Pseudomonas aeruginosa 99 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 3 s__Aeromonas encheleia 18 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 4 s__Bacteroides caccae 13 3 Aves, Mammalia, Reptilia p__Bacteroidota 5 s__Bacteroides fragilis 20 3 Aves, Mammalia, Reptilia p__Bacteroidota 6 s__Bacteroides nordii 23 3 Aves, Mammalia, Reptilia p__Bacteroidota 7 s__Bacteroides thetaiotaomicron 42 3 Aves, Mammalia, Reptilia p__Bacteroidota 8 s__Bacteroides uniformis 84 3 Aves, Mammalia, Reptilia p__Bacteroidota 9 s__Bacteroides xylanisolvens 27 3 Aves, Mammalia, Reptilia p__Bacteroidota 10 s__Bilophila wadsworthia 12 3 Aves, Mammalia, Reptilia p__Desulfobacterota # ℹ 24 more rows species_selection %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 5 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 5 2 p__Bacillota_A 2 3 p__Bacteroidota 8 4 p__Desulfobacterota 1 5 p__Pseudomonadota 18 3.0.3 Host classes- after filtering species_hostclass_counts_f &lt;- ehi_mags_filtered %&gt;% dplyr::filter(!is.na(species), species != &quot;&quot;) %&gt;% dplyr::filter(!is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_mags = n(), n_host_classes = n_distinct(host_class), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), phylum = paste(unique(phylum), collapse = &quot;, &quot;) ) %&gt;% arrange(desc(n_host_classes)) species_selection_f &lt;- species_hostclass_counts_f %&gt;% dplyr::filter(n_host_classes &gt;= 3, n_mags &gt; 10) %&gt;% arrange(desc(n_mags)) species_selection_f # A tibble: 10 × 5 species n_mags n_host_classes host_classes phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Escherichia coli 64 3 Aves, Mammalia, Reptilia p__Pseudomonadota 2 s__Pseudomonas aeruginosa 55 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 3 s__Lactococcus lactis 38 3 Aves, Mammalia, Reptilia p__Bacillota 4 s__Hafnia paralvei 25 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 5 s__Parabacteroides distasonis 25 3 Aves, Mammalia, Reptilia p__Bacteroidota 6 s__Enterococcus faecalis 21 3 Aves, Mammalia, Reptilia p__Bacillota 7 s__Bacteroides uniformis 19 3 Aves, Mammalia, Reptilia p__Bacteroidota 8 s__Phocaeicola vulgatus 19 3 Aves, Mammalia, Reptilia p__Bacteroidota 9 s__Citrobacter braakii 16 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 10 s__Moellerella wisconsensis 13 3 Amphibia, Aves, Mammalia p__Pseudomonadota species_selection_list&lt;- species_selection_f %&gt;% pull(species) species_selection_f %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 3 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 2 2 p__Bacteroidota 3 3 p__Pseudomonadota 5 3.0.4 Count host classes per species species_hostclass_counts &lt;- ehi_mags_filtered %&gt;% dplyr::filter(!is.na(species), species != &quot;&quot;, !is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_host_classes = n_distinct(host_class)) %&gt;% arrange(desc(n_host_classes)) counts_species_per_class&lt;- species_hostclass_counts %&gt;% group_by(n_host_classes)%&gt;% summarize(n_species = n()) ggplot(counts_species_per_class, aes(x = n_host_classes, y = n_species)) + geom_col() + geom_text( aes(label = n_species), vjust = -0.3, size = 4 ) + labs( title = &quot;Number of Species per Number of Host Classes&quot;, x = &quot;Number of Host Classes&quot;, y = &quot;Number of Species&quot; ) + theme_bw() mags_with_counts &lt;- ehi_mags_filtered %&gt;% left_join(species_hostclass_counts, by = &quot;species&quot;) #filter for mags with &gt;2 host classes mags_host3 &lt;- mags_with_counts %&gt;% dplyr::filter(n_host_classes &gt;= 3) n_mags &lt;- mags_host3 %&gt;% group_by(species) %&gt;% summarise(n_mags = n(), .groups = &quot;drop&quot;) #Species level: species_host3 &lt;- mags_host3 %&gt;% group_by(species)%&gt;% summarise(phylum = dplyr::first(phylum), order = dplyr::first(order), family = dplyr::first(family), genus = dplyr::first(genus), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), host_species = paste(sort(unique(host_species)), collapse = &quot;, &quot;)) We have several MAGs per species, so here we select the “best MAG” (highest completeness and lowest contamination), to have statistics based on the best of each. best_mag_per_species &lt;- mags_host3 %&gt;% group_by(species) %&gt;% arrange(desc(completeness), contamination) %&gt;% slice_head(n = 1) %&gt;% ungroup() %&gt;% transmute( species, best_mag_name = mag_name, best_MAG_link = link_to_assembly, best_genome_size = size, best_completeness = completeness, best_contamination = contamination, best_N50 = N50, best_host_classes = host_class, best_assembly_type = assembly_type, best_phylum =str_remove_all(phylum, &quot;p__&quot;)) ggplot(best_mag_per_species, aes(x= species, y = best_genome_size, fill = best_phylum))+ scale_color_manual(values=phylum_colors) + scale_fill_manual(values=phylum_colors) + geom_col()+ theme_bw()+ theme(axis.text.x = element_text(angle = 90)) Warning: No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. Filtering for Parabacteroides distasonis (make into a loop for all the relevant species later) p_dist &lt;- ehi_mags %&gt;% filter(completeness &gt;90, contamination &lt; 2.5, species == &quot;s__Parabacteroides distasonis&quot;) write_tsv(p_dist, &quot;data/mags_metadata/parabacteroides_distasonis_metadata.tsv&quot;) p_dist_index &lt;- p_dist %&gt;% dplyr::select(ID, MAG_url) write_tsv(p_dist_index, &quot;data/mags_metadata/parabacteroides_distasonis_index.tsv&quot;) #Loop through each species in species_selection list for (i in 1:nrow(species_selection_f)) { current_species &lt;- species_selection_f$species[i] #Filter for completeness and contamination #get metadata species_data &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5, species == current_species) #get index species_index &lt;- species_data %&gt;% dplyr::select(ID, MAG_url) #Filename from species name filename &lt;- current_species %&gt;% str_replace(&quot;s__&quot;, &quot;&quot;) %&gt;% str_replace_all(&quot; &quot;, &quot;_&quot;) %&gt;% tolower() #export to tsv write_tsv(species_data, paste0(&quot;data/mags_metadata/&quot;, filename, &quot;_metadata.tsv&quot;)) write_tsv(species_index, paste0(&quot;data/mags_metadata/&quot;, filename, &quot;_index.tsv&quot;)) } ### First only with two: all_mags &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5, species %in% c(&quot;s__Parabacteroides distasonis&quot;, &quot;s__Phocaeicola vulgatus&quot;)) %&gt;% mutate(species = str_remove(species, &quot;^s__&quot;) %&gt;% str_to_lower() %&gt;% str_replace(&quot; &quot;, &quot;_&quot;), out_path = paste0(&quot;data/&quot;, species, &quot;/mags/&quot;, basename(MAG_url)) ) %&gt;% dplyr::select(species, ID, MAG_url, out_path) write_tsv(all_mags, &quot;all_mags_index.tsv&quot;) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
