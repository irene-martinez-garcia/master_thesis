[["index.html", "AlberdiLab | Comparative metagenomics MSc project Chapter 1 Introduction 1.1 Prepare the R environment", " AlberdiLab | Comparative metagenomics MSc project Irene Martínez, M Thomas P Gilbert, Antton Alberdi1 Last update: 2025-11-23 Chapter 1 Introduction This webbook contains all the code used for data analysis for the comparative metagenomics analysis of gut microbiome bacterial species in several vertebrates. 1.1 Prepare the R environment 1.1.1 Environment To reproduce all the analyses locally, clone this repository in your computer using: RStudio &gt; New Project &gt; Version Control &gt; Git And indicating the following git repository: https://github.com/irene-martinez-garcia/comparative_metagenomics.git Once the R project has been created, follow the instructions and code chunks shown in this webbook. 1.1.2 Libraries The following R packages are required for the data analysis. # Base library(R.utils) library(knitr) library(tidyverse) library(devtools) library(tinytable) library(rairtable) library(janitor) library(broom) # For tree handling library(ape) library(phyloseq) library(phytools) # For plotting library(ggplot2) library(ggrepel) library(ggpubr) library(ggnewscale) library(gridExtra) library(ggtreeExtra) library(ggtree) library(ggh4x) library(UpSetR) library(viridis) # For statistics library(spaa) library(vegan) library(Rtsne) library(geiger) library(distillR) library(ANCOMBC) library(lme4) library(nlme) library(pairwiseAdonis) library(emmeans) library(pheatmap) library(rstatix) library(uwot) University of Copenhagen, antton.alberdi@sund.ku.dk↩︎ "],["data-preparation.html", "Chapter 2 Data preparation 2.1 Load data 2.2 Prepare color scheme 2.3 Wrap working objects", " Chapter 2 Data preparation 2.1 Load data Load the original data files outputted by the bioinformatic pipeline. 2.1.1 EHI MAGs ehi_mags &lt;- read_csv(&quot;data/ehi_mags.csv&quot;) Rows: 8846 Columns: 52 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, c... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, c... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.2 Prepare color scheme AlberdiLab projects use unified color schemes developed for the Earth Hologenome Initiative, to facilitate figure interpretation. ehi_mags_p &lt;- ehi_mags %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(ehi_mags_p, by=join_by(phylum == phylum)) %&gt;% dplyr::select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% pull(colors, name=phylum) 2.3 Wrap working objects All working objects are wrapped into a single Rdata object to facilitate downstream usage. save(ehi_mags, phylum_colors, file = &quot;data/data.Rdata&quot;) "],["data-preparation-1.html", "Chapter 3 Data preparation", " Chapter 3 Data preparation 3.0.1 EHI MAGs load(&quot;data/data.Rdata&quot;) ehi_mags &lt;- read_csv(&quot;data/ehi_mags.csv&quot;) Rows: 8846 Columns: 52 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, c... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, c... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. colnames(ehi_mags) [1] &quot;ID&quot; &quot;mag_name&quot; &quot;link_to_assembly&quot; [4] &quot;AB_batch&quot; &quot;eha_number&quot; &quot;GTDB_version&quot; [7] &quot;GTDB_release&quot; &quot;domain&quot; &quot;phylum&quot; [10] &quot;class&quot; &quot;order&quot; &quot;family&quot; [13] &quot;genus&quot; &quot;species&quot; &quot;fastani_ani&quot; [16] &quot;closest_placement_ani&quot; &quot;closest_placement_af&quot; &quot;completeness&quot; [19] &quot;contamination&quot; &quot;size&quot; &quot;GC&quot; [22] &quot;N50&quot; &quot;coding_density&quot; &quot;contigs&quot; [25] &quot;number_genes&quot; &quot;number_unannotated_genes&quot; &quot;DM_batch&quot; [28] &quot;host_species&quot; &quot;host_order&quot; &quot;host_class&quot; [31] &quot;MAG_url&quot; &quot;anno_url&quot; &quot;kegg_url&quot; [34] &quot;annotated&quot; &quot;taxonomy_level&quot; &quot;assembly_type&quot; [37] &quot;sample_type&quot; &quot;gbk_url&quot; &quot;kegg_hits&quot; [40] &quot;Capture ID&quot; &quot;percent_unannotated_genes&quot; &quot;percent_unannotated_kegg&quot; [43] &quot;dereplicated&quot; &quot;metagenomic source&quot; &quot;completeness software&quot; [46] &quot;binning software&quot; &quot;assembly quality&quot; &quot;binning parameters&quot; [49] &quot;taxonomic identity marker&quot; &quot;isolation_source&quot; &quot;assembly software&quot; [52] &quot;Submission&quot; Check contamination and completeness genome_biplot &lt;- ehi_mags %&gt;% dplyr::select(c(phylum,completeness,contamination,size)) %&gt;% ggplot(aes(x=completeness,y=contamination,size=size,color=phylum)) + geom_point(alpha=0.7) + xlim(c(70,100)) + ylim(c(10,0)) + scale_color_manual(values=phylum_colors) + labs(y= &quot;Contamination&quot;, x = &quot;Completeness&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;) #Generate contamination boxplot genome_contamination &lt;- ehi_mags %&gt;% ggplot(aes(y=contamination)) + ylim(c(10,0)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0.40, 0),&quot;inches&quot;)) #add bottom-margin (top, right, bottom, left) genome_completeness &lt;- ehi_mags %&gt;% ggplot(aes(x=completeness)) + xlim(c(70,100)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0, 0.50),&quot;inches&quot;)) #add left-margin (top, right, bottom, left) #Render composite figure #pdf(&quot;figures/completeness_contamination.pdf&quot;,width=10, height=5) grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination), layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3))) Warning: Removed 1721 rows containing non-finite outside the scale range (`stat_boxplot()`). Warning: No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. Warning: Removed 1721 rows containing missing values or values outside the scale range (`geom_point()`). Warning: Removed 1 row containing non-finite outside the scale range (`stat_boxplot()`). Filter by completeness and contamination ehi_mags_filtered &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5) 3.0.2 Host classes species_hostclass_counts &lt;- ehi_mags %&gt;% filter(!is.na(species), species != &quot;&quot;) %&gt;% filter(!is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_mags = n(), n_host_classes = n_distinct(host_class), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), phylum = paste(unique(phylum), collapse = &quot;, &quot;) ) %&gt;% arrange(desc(n_host_classes)) species_selection &lt;- species_hostclass_counts %&gt;% filter(n_host_classes &gt;= 3) species_selection # A tibble: 34 × 5 species n_mags n_host_classes host_classes phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Hafnia alvei 61 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 2 s__Pseudomonas aeruginosa 99 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 3 s__Aeromonas encheleia 18 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 4 s__Bacteroides caccae 13 3 Aves, Mammalia, Reptilia p__Bacteroidota 5 s__Bacteroides fragilis 20 3 Aves, Mammalia, Reptilia p__Bacteroidota 6 s__Bacteroides nordii 23 3 Aves, Mammalia, Reptilia p__Bacteroidota 7 s__Bacteroides thetaiotaomicron 42 3 Aves, Mammalia, Reptilia p__Bacteroidota 8 s__Bacteroides uniformis 84 3 Aves, Mammalia, Reptilia p__Bacteroidota 9 s__Bacteroides xylanisolvens 27 3 Aves, Mammalia, Reptilia p__Bacteroidota 10 s__Bilophila wadsworthia 12 3 Aves, Mammalia, Reptilia p__Desulfobacterota # ℹ 24 more rows species_selection %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 5 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 5 2 p__Bacillota_A 2 3 p__Bacteroidota 8 4 p__Desulfobacterota 1 5 p__Pseudomonadota 18 3.0.3 Host classes- after filtering species_hostclass_counts_f &lt;- ehi_mags_filtered %&gt;% filter(!is.na(species), species != &quot;&quot;) %&gt;% filter(!is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_mags = n(), n_host_classes = n_distinct(host_class), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), phylum = paste(unique(phylum), collapse = &quot;, &quot;) ) %&gt;% arrange(desc(n_host_classes)) species_selection_f &lt;- species_hostclass_counts_f %&gt;% filter(n_host_classes &gt;= 3, n_mags &gt; 10) %&gt;% arrange(desc(n_mags)) species_selection_f # A tibble: 10 × 5 species n_mags n_host_classes host_classes phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Escherichia coli 64 3 Aves, Mammalia, Reptilia p__Pseudomonadota 2 s__Pseudomonas aeruginosa 55 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 3 s__Lactococcus lactis 38 3 Aves, Mammalia, Reptilia p__Bacillota 4 s__Hafnia paralvei 25 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 5 s__Parabacteroides distasonis 25 3 Aves, Mammalia, Reptilia p__Bacteroidota 6 s__Enterococcus faecalis 21 3 Aves, Mammalia, Reptilia p__Bacillota 7 s__Bacteroides uniformis 19 3 Aves, Mammalia, Reptilia p__Bacteroidota 8 s__Phocaeicola vulgatus 19 3 Aves, Mammalia, Reptilia p__Bacteroidota 9 s__Citrobacter braakii 16 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 10 s__Moellerella wisconsensis 13 3 Amphibia, Aves, Mammalia p__Pseudomonadota species_selection_f %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 3 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 2 2 p__Bacteroidota 3 3 p__Pseudomonadota 5 3.0.4 Count host classes per species species_hostclass_counts &lt;- ehi_mags_filtered %&gt;% filter(!is.na(species), species != &quot;&quot;, !is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_host_classes = n_distinct(host_class)) %&gt;% arrange(desc(n_host_classes)) counts_species_per_class&lt;- species_hostclass_counts %&gt;% group_by(n_host_classes)%&gt;% summarize(n_species = n()) ggplot(counts_species_per_class, aes(x = n_host_classes, y = n_species)) + geom_col() + geom_text( aes(label = n_species), vjust = -0.3, size = 4 ) + labs( title = &quot;Number of Species per Number of Host Classes&quot;, x = &quot;Number of Host Classes&quot;, y = &quot;Number of Species&quot; ) + theme_bw() mags_with_counts &lt;- ehi_mags_filtered %&gt;% left_join(species_hostclass_counts, by = &quot;species&quot;) #filter for mags with &gt;2 host classes mags_host3 &lt;- mags_with_counts %&gt;% filter(n_host_classes &gt;= 3) n_mags &lt;- mags_host3 %&gt;% group_by(species) %&gt;% summarise(n_mags = n(), .groups = &quot;drop&quot;) #Species level: species_host3 &lt;- mags_host3 %&gt;% group_by(species)%&gt;% summarise(phylum = first(phylum), order = first(order), family = first(family), genus = first(genus), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), host_species = paste(sort(unique(host_species)), collapse = &quot;, &quot;)) We have several MAGs per species, so here we select the “best MAG” (highest completeness and lowest contamination), to have statistics based on the best of each. best_mag_per_species &lt;- mags_host3 %&gt;% group_by(species) %&gt;% arrange(desc(completeness), contamination) %&gt;% slice(1) %&gt;% ungroup() %&gt;% transmute( species, best_mag_name = mag_name, best_MAG_link = link_to_assembly, best_genome_size = size, best_completeness = completeness, best_contamination = contamination, best_N50 = N50, best_host_classes = host_class, best_assembly_type = assembly_type, best_phylum =str_remove_all(phylum, &quot;p__&quot;)) ggplot(best_mag_per_species, aes(x= species, y = best_genome_size, fill = best_phylum))+ scale_color_manual(values=phylum_colors) + scale_fill_manual(values=phylum_colors) + geom_col()+ theme_bw()+ theme(axis.text.x = element_text(angle = 90)) Warning: No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. Filtering for Parabacteroides distasonis (make into a loop for all the relevant species later) p_dist &lt;- ehi_mags %&gt;% filter(completeness &gt;90, contamination &lt; 2.5, species == &quot;s__Parabacteroides distasonis&quot;) write_tsv(p_dist, &quot;data/mags_metadata/parabacteroides_distasonis_metadata.tsv&quot;) # #Loop through each species in species_selection # for (i in 1:nrow(species_selection)) { # current_species &lt;- species_species$species[i] # # #Filter for completeness and contamination # species_data &lt;- ehi_mags %&gt;% # filter(completeness &gt; 90, # contamination &lt; 2.5, # species == current_species) # # #Filename from species name # filename &lt;- current_species %&gt;% # str_replace(&quot;s__&quot;, &quot;&quot;) %&gt;% # str_replace_all(&quot; &quot;, &quot;_&quot;) %&gt;% # tolower() # # #export to tsv # write_tsv(species_data, # paste0(&quot;data/mags_metadata/&quot;, filename, &quot;_metadata.tsv&quot;)) # } "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
