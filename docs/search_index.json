[["index.html", "AlberdiLab | Comparative metagenomics MSc project Chapter 1 Introduction 1.1 Prepare the R environment", " AlberdiLab | Comparative metagenomics MSc project Irene Martínez, M Thomas P Gilbert, Antton Alberdi1 Last update: 2026-01-15 Chapter 1 Introduction This webbook contains all the code used for data analysis for the comparative metagenomics analysis of gut microbiome bacterial species in several vertebrates. 1.1 Prepare the R environment 1.1.1 Environment To reproduce all the analyses locally, clone this repository in your computer using: RStudio &gt; New Project &gt; Version Control &gt; Git And indicating the following git repository: https://github.com/irene-martinez-garcia/comparative_metagenomics.git Once the R project has been created, follow the instructions and code chunks shown in this webbook. 1.1.2 Libraries The following R packages are required for the data analysis. # Base library(R.utils) library(knitr) library(tidyverse) #library(devtools) library(tinytable) library(rairtable) library(janitor) library(broom) # For tree handling library(ape) library(phyloseq) library(phytools) # For plotting library(ggplot2) library(ggrepel) library(ggpubr) library(ggnewscale) library(gridExtra) library(ggtreeExtra) library(ggtree) library(ggh4x) library(UpSetR) library(viridis) # For statistics library(spaa) library(vegan) library(Rtsne) library(geiger) library(distillR) library(ANCOMBC) library(lme4) library(nlme) library(pairwiseAdonis) library(emmeans) library(pheatmap) library(rstatix) library(uwot) University of Copenhagen, antton.alberdi@sund.ku.dk↩︎ "],["data-preparation.html", "Chapter 2 Data preparation 2.1 Searching for the MAGs 2.2 Downloading the MAGs and generating data 2.3 R Studio- Data Analysis 2.4 Load pangenome data 2.5 Exploring ppanggolin outputs 2.6 Wrap working objects", " Chapter 2 Data preparation 2.1 Searching for the MAGs Choose the MAGs In this case, we will be working with Parabacteroides distasonis. In the EHI database, select the MAGs with &gt; 90% completeness and &lt; 2.5 contamination. Do the same in the GTDB, but also filter for isolation source CONTAINS feces. 2.2 Downloading the MAGs and generating data Download genome indices and metadata Download the EHI_MAG index for each species (in /data/mags_metadata folder) and the curl file and search metadata tsv from the GTDB and place in each species directory in Mjolnir. 2.5) Extract genome metadata - Use the GTDB search tsv to run this script to obtain more metadata. (modify script a bit to make it scalable). python scripts/extract_gtdb_metadata.py Create the master index Run the create_index.R script to create an index of all the MAGs and the download paths (needs a list of species as input and right now it is hardcoded in the script) conda activate mags_r_env Rscript scripts/create_index.R Run the downloading_mags.smk to download all the genomes snakemake -s snakefiles/downloading_mags.smk \\ --executor slurm \\ --jobs 50 \\ --rerun-incomplete \\ --keep-going #testing with the HUMAN_EHI snakemake -s snakefiles/downloading_and_unzipping.smk \\ --executor slurm \\ --jobs 50 \\ --rerun-incomplete \\ --keep-going Unzip all the MAGs and make sure they are in the same folder: run (maybe add this to the downloading_mags.smk) bash scripts/unzip_mags.sh parabacteroides_distasonis bash scripts/unzip_mags.sh phocaeicola_vulgatus Make a screen session for each species. screen -S parabacteroides_distasonis Run drakkar annotating_function.smk to re-annotate all the MAGs: drakkar annotating -b /maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis/mags/unzipped -o /maps/projects/alberdilab/people/pjq449/comparative_metagenomics --env_path /projects/alberdilab/data/environments/drakkar --annotation-type function Annotate with prokka and make phylogenetic tree with getphylo snakemake -s snakefiles/prokka_and_pangenome.smk --profile snakefiles/slurm_profile Run genome_mapping.sh to map the mag ids to the corresponding names Run drep sbatch scripts/drep_compare.slurm Run create_pangolin_input.R to create the input file ppanggolin needs conda activate mags_r_env Rscript scripts/create_pangolin_input.R #or if we want to use the annotation files by prokka: Rscript scripts/create_pangolin_input_gff.R Pangenome analysis with ppanggolin conda activate ppanggolin ppanggolin all --fasta /maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis/ppanggolin_input.tsv #with annotation files: ppanggolin all --anno maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis/genome_gff_paths.tsv --rarefaction ##if you are runnning this in the species folder, write local path not absolute. 2.3 R Studio- Data Analysis 2.3.1 EHI MAGs ehi_mags &lt;- read_csv(&quot;data/ehi_metadata_location.csv&quot;) Rows: 8857 Columns: 54 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (38): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, class, or... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, coding_de... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.3.2 Prepare color scheme AlberdiLab projects use unified color schemes developed for the Earth Hologenome Initiative, to facilitate figure interpretation. ehi_mags_p &lt;- ehi_mags %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(ehi_mags_p, by=join_by(phylum == phylum)) %&gt;% dplyr::select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% pull(colors, name=phylum) source_colors &lt;- c(EHI = &quot;#8BC63F&quot;, GTDB = &quot;#2D522D&quot;) #source_colors &lt;- c(EHI = &quot;#8BC63F&quot;, GTDB = &quot;#A90D00&quot;) 2.3.3 Sample metadata gtdb_search_metadata &lt;- read_tsv(&quot;data/p_dist_gtdb_metadata.tsv&quot;) Rows: 69 Columns: 9 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (6): Accession, Organism Name, NCBI Taxonomy, GTDB Taxonomy, GTDB Type Material, Isolation Source dbl (2): CheckM Completeness, CheckM2 Contamination lgl (1): GTDB Representative of Species ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. gtdb_accession_metadata&lt;- read_tsv(&quot;data/parabacteroides_distasonis_GTDB_accession_metadata.tsv&quot;) Rows: 67 Columns: 115 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (69): accession, checkm2_model, checkm_marker_lineage, gtdb_genome_representative, gtdb_taxonomy, gtdb_type_desi... dbl (39): ambiguous_bases, checkm2_completeness, checkm2_contamination, checkm_completeness, checkm_contamination, c... lgl (5): gtdb_representative, gtdb_type_species_of_genus, mimag_high_quality, mimag_low_quality, mimag_medium_quality date (2): ncbi_date, ncbi_seq_rel_date ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. ehi_metadata &lt;- read_tsv(&quot;data/mags_metadata/parabacteroides_distasonis_metadata.tsv&quot;) %&gt;% mutate(GC = as.numeric(str_remove(GC, &quot;%&quot;))) Rows: 25 Columns: 52 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, class, or... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, coding_de... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. location_data&lt;- ehi_mags %&gt;% dplyr::select(ID, locality, country) ehi_metadata_location &lt;- left_join(ehi_metadata, location_data, by = &quot;ID&quot;) 2.3.4 Load genome mapping genome_mapping &lt;- read_tsv(&quot;data/genome_mapping.tsv&quot;) Rows: 69 Columns: 2 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (2): genome_id, genome_file ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. gtdb_accession_metadata_2 &lt;- left_join(gtdb_accession_metadata, genome_mapping, by = c(&quot;search_accession&quot; = &quot;genome_id&quot;) ) #Make a genome_mapping with all the MAGs (including EHI) #First select the ehi IDs from ehi_metadata ehi_ids &lt;- ehi_metadata %&gt;% dplyr::select(ID, mag_name) %&gt;% dplyr::rename(genome_id = ID, genome_file = mag_name) ehi_ids$genome_file &lt;- sub(&quot;\\\\.fa$&quot;, &quot;&quot;, ehi_ids$genome_file)#remove .fa genome_mapping_all &lt;- genome_mapping %&gt;% bind_rows(ehi_ids) # Prepare EHI metadata with standardized column names ehi_clean &lt;- ehi_metadata_location%&gt;% dplyr::select( ID, species = species, completeness, contamination, genome_size = size, GC, N50, contigs, host_species, host_order, host_class, assembly_type, isolation_source= sample_type, mag_name, eha_number, locality, country ) %&gt;% mutate(source = &quot;EHI&quot;) # Prepare GTDB metadata # Join search and accession metadata gtdb_metadata &lt;- full_join(gtdb_accession_metadata_2, gtdb_search_metadata, by = c(&quot;search_accession&quot; = &quot;Accession&quot;) ) # Prepare GTDB metadata gtdb_clean &lt;- gtdb_metadata %&gt;% dplyr::select( ID = search_accession, species = &quot;Organism Name&quot;, completeness = &quot;CheckM Completeness&quot;, contamination = &quot;CheckM2 Contamination&quot;, gtdb_taxonomy = &quot;GTDB Taxonomy&quot;, isolation_source = &quot;Isolation Source&quot;, genome_size, GC = gc_percentage, N50 = n50_contigs, contigs = contig_count, country = ncbi_country, mimag_high_quality, mimag_medium_quality, gtdb_representative, mag_name = genome_file, ncbi_date )%&gt;% mutate(source = &quot;GTDB&quot;) #Join genome_metadata &lt;- bind_rows(ehi_clean, gtdb_clean) genome_metadata_clean &lt;- genome_metadata %&gt;% separate_wider_delim( cols = country, delim = regex(&quot;:\\\\s*&quot;), names = c(&quot;country_clean&quot;, &quot;extra_locality&quot;), too_few = &quot;align_start&quot; ) %&gt;% mutate( locality = case_when( !is.na(extra_locality) &amp; !is.na(locality) ~ paste(extra_locality, locality, sep = &quot;, &quot;), !is.na(extra_locality) ~ extra_locality, TRUE ~ locality ) ) %&gt;% dplyr::rename(country = country_clean) genome_metadata &lt;- genome_metadata_clean %&gt;% mutate( # United States to USA country = case_match( country, &quot;United States&quot; ~ &quot;USA&quot;, .default = country ), # Continent column continent = case_when( country %in% c(&quot;Spain&quot;, &quot;Italy&quot;, &quot;Greece&quot;, &quot;Portugal&quot;, &quot;Malta&quot;, &quot;Ireland&quot;, &quot;Germany&quot;, &quot;United Kingdom&quot;) ~ &quot;Europe&quot;, country %in% c(&quot;USA&quot;, &quot;Canada&quot;, &quot;Greenland&quot;) ~ &quot;North America&quot;, country %in% c(&quot;South Korea&quot;, &quot;China&quot;, &quot;Japan&quot;) ~ &quot;Asia&quot;, country == &quot;Australia&quot; ~ &quot;Oceania&quot;, TRUE ~ NA_character_ # Handle &quot;none&quot; and NA ) ) # Read master index master_index &lt;- read_tsv(&quot;data/master_mag_index.tsv&quot;) %&gt;% filter(species == &quot;parabacteroides_distasonis&quot;) %&gt;% mutate( # Extract the actual genome identifier from out_path genome_identifier = case_when( # For EHI: extract EHA00531_bin.1 from the filename str_detect(out_path, &quot;EHA&quot;) ~ str_extract(out_path, &quot;EHA[0-9]+_bin\\\\.[0-9]+&quot;), # For NCBI: use the ID as is (GCA/GCF number) TRUE ~ ID ) ) Rows: 287 Columns: 4 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (4): species, ID, MAG_url, out_path ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. # Check the mapping print(&quot;Master index mapping:&quot;) [1] &quot;Master index mapping:&quot; master_index %&gt;% dplyr::select(ID, genome_identifier, out_path) %&gt;% head(10) %&gt;% print() # A tibble: 10 × 3 ID genome_identifier out_path &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016228 EHA00531_bin.1 data/parabacteroides_distasonis/mags/EHA00531_bin.1.fa.gz 2 EHM016318 EHA00539_bin.6 data/parabacteroides_distasonis/mags/EHA00539_bin.6.fa.gz 3 EHM016582 EHA00535_bin.6 data/parabacteroides_distasonis/mags/EHA00535_bin.6.fa.gz 4 EHM016991 EHA00726_bin.13 data/parabacteroides_distasonis/mags/EHA00726_bin.13.fa.gz 5 EHM020917 EHA01202_bin.66 data/parabacteroides_distasonis/mags/EHA01202_bin.66.fa.gz 6 EHM023585 EHA00928_bin.90 data/parabacteroides_distasonis/mags/EHA00928_bin.90.fa.gz 7 EHM023781 EHA01439_bin.44 data/parabacteroides_distasonis/mags/EHA01439_bin.44.fa.gz 8 EHM027637 EHA01634_bin.14 data/parabacteroides_distasonis/mags/EHA01634_bin.14.fa.gz 9 EHM028668 EHA01281_bin.18 data/parabacteroides_distasonis/mags/EHA01281_bin.18.fa.gz 10 EHM029564 EHA01845_bin.103 data/parabacteroides_distasonis/mags/EHA01845_bin.103.fa.gz # Read contig-to-genome mapping contig_to_genome &lt;- read_tsv(&quot;data/p_dist_contig_to_genome.tsv&quot;, col_names = c(&quot;contig&quot;, &quot;genome_filename&quot;)) Rows: 13976 Columns: 2 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (2): contig, genome_filename ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.3.5 Genome annotations # Read annotations and add IDs genome_annotations &lt;- read_tsv(&quot;data/gene_annotations.tsv.xz&quot;) %&gt;% mutate(contig = sub(&quot;_[^_]*$&quot;, &quot;&quot;, gene)) %&gt;% left_join(contig_to_genome, by = &quot;contig&quot;) %&gt;% # Extract accession from genome filename mutate( accession = case_when( # For NCBI genomes: extract GCA/GCF number str_detect(genome_filename, &quot;^GC[AF]_&quot;) ~ str_extract(genome_filename, &quot;^GC[AF]_[0-9]+\\\\.[0-9]+&quot;), # For EHI genomes: the filename IS the identifier TRUE ~ genome_filename ) ) %&gt;% # Join with master index using genome_identifier left_join( master_index %&gt;% dplyr::select(mag_id = ID, genome_identifier), by = c(&quot;accession&quot; = &quot;genome_identifier&quot;) ) %&gt;% dplyr::select(gene, mag_id, genome = genome_filename, contig, accession, everything()) %&gt;% filter(!is.na(mag_id)) Warning: One or more parsing issues, call `problems()` on your data frame for details, e.g.: dat &lt;- vroom(...) problems(dat) Rows: 374229 Columns: 13 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (11): gene, strand, kegg, ec, pfam, cazy, resistance_type, resistance_target, vf, vf_type, signalp dbl (2): start, end ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 2.3.6 Distill annotations into GIFTs genome_gifts &lt;- distill(genome_annotations,GIFT_db,genomecol= 2, annotcol=c(9,10,11,12), verbosity = T) 2.3.7 Load trees genome_metadata$mag_name &lt;- sub(&quot;\\\\.fa$&quot;, &quot;&quot;, genome_metadata$mag_name)#remove .fa from the mag names so that they match the tree ids getphylo_tree &lt;- read_tree(&quot;data/combined_alignment.tree&quot;) getphylo_tree$tip.label &lt;- gsub(&quot;&#39;&quot;, &quot;&quot;, getphylo_tree$tip.label) tip_df &lt;- data.frame(label = getphylo_tree$tip.label) %&gt;% left_join(genome_metadata, by = c(&quot;label&quot; = &quot;mag_name&quot;)) #replace long mag names with IDs getphylo_tree$tip.label &lt;- tip_df$ID fastani_comparisons &lt;- read_csv(&quot;data/Ndb.csv&quot;) #Secondary comparison results Rows: 8650 Columns: 5 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (2): reference, querry dbl (3): ani, alignment_coverage, primary_cluster ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. genomes &lt;- unique(c(fastani_comparisons$reference, fastani_comparisons$querry)) # Create empty matrix ani_matrix &lt;- matrix(0, nrow = length(genomes), ncol = length(genomes)) rownames(ani_matrix) &lt;- genomes colnames(ani_matrix) &lt;- genomes # Fill the matrix for(i in 1:nrow(fastani_comparisons)) { ref &lt;- fastani_comparisons$reference[i] qry &lt;- fastani_comparisons$querry[i] ani_val &lt;- fastani_comparisons$ani[i] ani_matrix[ref, qry] &lt;- ani_val ani_matrix[qry, ref] &lt;- ani_val # Make symmetric } # Set diagonal to 100 diag(ani_matrix) &lt;- 100 # Convert to distance matrix (for tree building) dist_matrix &lt;- as.dist(1 - ani_matrix) # Build tree hc &lt;- hclust(dist_matrix, method = &quot;average&quot;) #drep uses hierarchical clustering tree &lt;- as.phylo(hc) ggtree(tree) + geom_tiplab(size = 2) + theme_tree2() Warning in fortify(data, ...): Arguments in `...` must be used. ✖ Problematic arguments: • as.Date = as.Date • yscale_mapping = yscale_mapping • hang = hang ℹ Did you misspell an argument name? #remove this outlier that is &gt;95% different (it must be another species) outlier &lt;- &quot;GCA_015060925.1_ASM1506092v1_genomic.fna&quot; fastani_filtered &lt;- fastani_comparisons %&gt;% filter(reference != outlier, querry != outlier) #create the matrix genomes &lt;- unique(c(fastani_filtered$reference, fastani_filtered$querry)) ani_matrix &lt;- matrix(0, nrow = length(genomes), ncol = length(genomes), dimnames = list(genomes, genomes)) #fill in the matrix with the distances for(i in seq_len(nrow(fastani_filtered))) { ref &lt;- fastani_filtered$reference[i] qry &lt;- fastani_filtered$querry[i] ani &lt;- fastani_filtered$ani[i] ani_matrix[ref, qry] &lt;- ani ani_matrix[qry, ref] &lt;- ani } diag(ani_matrix) &lt;- 1 dist_matrix &lt;- as.dist(1 - ani_matrix ) #hierarchical clustering ti generate the tree hc &lt;- hclust(dist_matrix, method = &quot;average&quot;) tree &lt;- as.phylo(hc) #use the short labels tip_df &lt;- tibble( label = tree$tip.label, label_clean = sub(&quot;\\\\.fna$|\\\\.fa$&quot;, &quot;&quot;, tree$tip.label) ) tip_df &lt;- tip_df %&gt;% left_join(genome_metadata, by = c(&quot;label_clean&quot; = &quot;mag_name&quot;)) tree$tip.label &lt;- ifelse( is.na(tip_df$ID), tip_df$label_clean, tip_df$ID ) #check sum(is.na(tip_df$ID)) [1] 2 tips_to_remove &lt;- tree$tip.label[is.na(tip_df$ID)] tree &lt;- ape::drop.tip(tree, tips_to_remove) # Update tip_df to match the pruned tree tip_df &lt;- tip_df %&gt;% filter(!is.na(ID)) tree_reversed &lt;- tree # Get the maximum distance (root to furthest tip) max_dist &lt;- max(node.depth.edgelength(tree)) # Reverse: make tips = 0 and root = max tree_reversed$edge.length &lt;- tree$edge.length node_depths &lt;- node.depth.edgelength(tree) # Calculate new positions (invert from tips) for(i in 1:length(tree_reversed$edge.length)) { tree_reversed$edge.length[i] &lt;- tree$edge.length[i] } p &lt;- ggtree(tree) + geom_tiplab(size = 2, hjust = 0.8)+ scale_x_continuous( breaks = seq(0, 0.02, by = 0.002), labels = function(x) round(100 * (1 - x), 1), # Reverse the labels trans = &quot;reverse&quot; # Reverse the axis ) + coord_cartesian(xlim = c(0.02, 0)) + labs(x = &quot;Average Nucleotide Identity (ANI, %)&quot;) + theme_tree2() Warning in fortify(data, ...): Arguments in `...` must be used. ✖ Problematic arguments: • as.Date = as.Date • yscale_mapping = yscale_mapping • hang = hang ℹ Did you misspell an argument name? p # Create a proper matching data frame tip_data_for_plot &lt;- data.frame( label = tree$tip.label, stringsAsFactors = FALSE ) # Match with metadata tip_data_for_plot &lt;- tip_data_for_plot %&gt;% left_join( tip_df %&gt;% dplyr::select(ID, source, host_species, country, locality, continent), by = c(&quot;label&quot; = &quot;ID&quot;) ) # Get the actual x-range of the tree tree_data &lt;- fortify(tree) max_x &lt;- max(tree_data$x[tree_data$isTip]) # Plot p &lt;- ggtree(tree, size = 1) + geom_vline(xintercept = max_x - 0.005, # 99.5% ANI (0.005 from tips) linetype = &quot;dashed&quot;, color = &quot;red&quot;, size = 0.8) + geom_tippoint(aes(color = source), size = 3) + geom_tiplab(aes(color = source), size = 4, hjust = -0.1) Warning in fortify(data, ...): Arguments in `...` must be used. ✖ Problematic arguments: • as.Date = as.Date • yscale_mapping = yscale_mapping • hang = hang • size = 1 ℹ Did you misspell an argument name? p &lt;- p %&lt;+% tip_data_for_plot + scale_color_manual(values = source_colors, name = &quot;Source&quot;) + scale_x_continuous( labels = function(x) round(100 * (1 - (max_x - x)), 1) # Convert based on distance from tips ) + coord_cartesian(xlim = c(0, max_x + 0.005)) + labs(x = &quot;Average Nucleotide Identity (ANI, %)&quot;) + theme_tree2() + theme( legend.position = &quot;right&quot;, plot.margin = margin(5, 100, 5, 5), axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16) ) p # Convert phylo tree to hclust object hclust_tree &lt;- as.hclust.phylo(tree) # Cut at 95% similarity (5% distance) # The height corresponds to genetic distance # For 95% similarity = 0.05 distance from tips cut_height &lt;- 0.05 # Cut the tree groups &lt;- cutree(hclust_tree, h = cut_height) # Add group information to your tip data tip_data_for_plot$group &lt;- groups[match(tip_data_for_plot$label, names(groups))] # See how many groups you have table(groups) groups 1 91 # Visualize with groups highlighted p &lt;- ggtree(tree, size = 1) + geom_vline(xintercept = max_x - 0.05, # 95% ANI (0.05 from tips) linetype = &quot;dashed&quot;, color = &quot;red&quot;, size = 0.8) + geom_tippoint(aes(color = source, shape = as.factor(group)), size = 3) + geom_tiplab(aes(color = source), size = 4, hjust = -0.1) Warning in fortify(data, ...): Arguments in `...` must be used. ✖ Problematic arguments: • as.Date = as.Date • yscale_mapping = yscale_mapping • hang = hang • size = 1 ℹ Did you misspell an argument name? p &lt;- p %&lt;+% tip_data_for_plot + scale_color_manual(values = source_colors, name = &quot;Source&quot;) + scale_shape_manual(values = rep(15:18, length.out = max(groups)), name = &quot;95% ANI Group&quot;) + scale_x_continuous( labels = function(x) round(100 * (1 - (max_x - x)), 1) ) + coord_cartesian(xlim = c(0, max_x + 0.005)) + labs(x = &quot;Average Nucleotide Identity (ANI, %)&quot;) + theme_tree2() + theme( legend.position = &quot;right&quot;, plot.margin = margin(5, 100, 5, 5), axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16) ) p # Get the actual x-range of the tree tree_data &lt;- fortify(tree) max_x &lt;- max(tree_data$x[tree_data$isTip]) # Plot p &lt;- ggtree(tree, size = 1) + geom_vline(xintercept = max_x - 0.005, # 99.5% ANI (0.005 from tips) linetype = &quot;dashed&quot;, color = &quot;red&quot;, size = 0.8) + geom_tippoint(aes(color = host_species), size = 3) + geom_tiplab(aes(color = host_species), size = 4, hjust = -0.1) Warning in fortify(data, ...): Arguments in `...` must be used. ✖ Problematic arguments: • as.Date = as.Date • yscale_mapping = yscale_mapping • hang = hang • size = 1 ℹ Did you misspell an argument name? p &lt;- p %&lt;+% tip_data_for_plot + scale_x_continuous( labels = function(x) round(100 * (1 - (max_x - x)), 1) # Convert based on distance from tips ) + coord_cartesian(xlim = c(0, max_x + 0.005)) + labs(x = &quot;Average Nucleotide Identity (ANI, %)&quot;) + theme_tree2() + theme( legend.position = &quot;right&quot;, plot.margin = margin(5, 100, 5, 5), axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16) ) p # Get the actual x-range of the tree tree_data &lt;- fortify(tree) max_x &lt;- max(tree_data$x[tree_data$isTip]) # Plot p &lt;- ggtree(tree, size = 1) + geom_vline(xintercept = max_x - 0.005, # 99.5% ANI (0.005 from tips) linetype = &quot;dashed&quot;, color = &quot;red&quot;, size = 0.8) + geom_tippoint(aes(color = continent), size = 3) + geom_tiplab(aes(color = continent), size = 4, hjust = -0.1) Warning in fortify(data, ...): Arguments in `...` must be used. ✖ Problematic arguments: • as.Date = as.Date • yscale_mapping = yscale_mapping • hang = hang • size = 1 ℹ Did you misspell an argument name? p &lt;- p %&lt;+% tip_data_for_plot + scale_x_continuous( labels = function(x) round(100 * (1 - (max_x - x)), 1) # Convert based on distance from tips ) + coord_cartesian(xlim = c(0, max_x + 0.005)) + labs(x = &quot;Average Nucleotide Identity (ANI, %)&quot;) + theme_tree2() + theme( legend.position = &quot;right&quot;, plot.margin = margin(5, 100, 5, 5), axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16) ) p 2.4 Load pangenome data PPanggolin gene_matrix &lt;- read.table(&quot;data/gene_presence_absence.Rtab&quot;, header = TRUE, row.names = 1) gene_matrix_transposed &lt;- gene_matrix %&gt;% t() pca_gene_matrix &lt;- prcomp(gene_matrix_transposed) plot_pca_gene_matrix &lt;- as_tibble(pca_gene_matrix$x)%&gt;% bind_cols(genome_metadata) percent_variance &lt;- summary(pca_gene_matrix)$importance[&quot;Proportion of Variance&quot;,] * 100 ggplot( plot_pca_gene_matrix, aes(x=PC1, y=PC2, col=host_species, label = ID)) + geom_point() + geom_text(hjust=0, vjust=0, size=2) + xlab(paste(&quot;PC1 &quot;, percent_variance[1], &quot;%&quot;))+ ylab(label = paste(&quot;PC2 &quot;, percent_variance[2], &quot;%&quot;)) + theme_bw() # Removing outlier outlier_to_remove &lt;- &quot;GCA_015060925.1&quot; gene_matrix_filtered &lt;- gene_matrix[, !colnames(gene_matrix) %in% outlier_to_remove] # Rerun PCA without outlier gene_matrix_transposed_filtered &lt;- gene_matrix_filtered %&gt;% t() pca_gene_matrix_filtered &lt;- prcomp(gene_matrix_transposed_filtered) plot_pca_filtered &lt;- as_tibble(pca_gene_matrix_filtered$x) %&gt;% bind_cols(genome_metadata %&gt;% filter(!rownames(.) %in% outlier_to_remove)) percent_variance_filtered &lt;- summary(pca_gene_matrix_filtered)$importance[&quot;Proportion of Variance&quot;,] * 100 plot_pca_filtered &lt;- plot_pca_filtered %&gt;% mutate( collection_date = as.Date(ncbi_date), date_numeric = as.numeric(ncbi_date) ) # Plot colored by date with gradient ggplot(plot_pca_filtered, aes(x=PC1, y=PC2, color=collection_date)) + geom_point(size=3) + scale_color_viridis_c(option=&quot;viridis&quot;) + # or use &quot;plasma&quot;, &quot;inferno&quot;, etc. xlab(paste(&quot;PC1 &quot;, percent_variance_filtered[1], &quot;%&quot;))+ ylab(paste(&quot;PC2 &quot;, percent_variance_filtered[2], &quot;%&quot;)) + labs(color=&quot;Collection Date&quot;) + theme_bw() mapping_from_tip_df &lt;- setNames(tip_df$ID, tip_df$label_clean) # Check the mapping cat(&quot;First 10 mappings from tip_df:\\n&quot;) First 10 mappings from tip_df: head(mapping_from_tip_df, 10) EHA00531_bin.1 EHA00535_bin.6 EHA00539_bin.6 EHA00726_bin.13 EHA00928_bin.90 EHA01202_bin.66 EHA01281_bin.18 &quot;EHM016228&quot; &quot;EHM016582&quot; &quot;EHM016318&quot; &quot;EHM016991&quot; &quot;EHM023585&quot; &quot;EHM020917&quot; &quot;EHM028668&quot; EHA01439_bin.44 EHA01634_bin.14 EHA01845_bin.103 &quot;EHM023781&quot; &quot;EHM027637&quot; &quot;EHM029564&quot; # How many gene_matrix columns match? cat(&quot;\\nGene_matrix columns in tip_df mapping:&quot;, sum(colnames(gene_matrix) %in% names(mapping_from_tip_df)), &quot;\\n&quot;) Gene_matrix columns in tip_df mapping: 91 # Which gene_matrix columns are NOT in tip_df? not_in_tipdf &lt;- colnames(gene_matrix)[!colnames(gene_matrix) %in% names(mapping_from_tip_df)] cat(&quot;Not in tip_df (&quot;, length(not_in_tipdf), &quot;):\\n&quot;) Not in tip_df ( 3 ): print(head(not_in_tipdf, 20)) [1] &quot;GCA_015060925.1_ASM1506092v1_genomic&quot; &quot;GCF_001406015.1_14207_7_71_genomic&quot; &quot;GCF_002206325.1_ASM220632v2_genomic&quot; # Apply the mapping from tip_df new_colnames &lt;- mapping_from_tip_df[colnames(gene_matrix)] cat(&quot;\\nNumber of successful mappings:&quot;, sum(!is.na(new_colnames)), &quot;\\n&quot;) Number of successful mappings: 91 cat(&quot;Number of NAs:&quot;, sum(is.na(new_colnames)), &quot;\\n&quot;) Number of NAs: 3 # Apply new names colnames(gene_matrix) &lt;- ifelse( is.na(new_colnames), colnames(gene_matrix), # Keep original if no mapping new_colnames # Use mapped EHM ID ) # Now check matching with tree cat(&quot;\\nAfter mapping - columns matching tree:&quot;, sum(colnames(gene_matrix) %in% tree$tip.label), &quot;\\n&quot;) After mapping - columns matching tree: 91 # Common genomes common_genomes &lt;- intersect(colnames(gene_matrix), tree$tip.label) cat(&quot;Common genomes:&quot;, length(common_genomes), &quot;\\n&quot;) Common genomes: 91 # Should be 91 now (or close to it)! gene_matrix_filtered &lt;- gene_matrix[, common_genomes] gene_matrix_t &lt;- t(gene_matrix_filtered) gene_matrix_t &lt;- gene_matrix_t[tree$tip.label, ] cat(&quot;\\nFinal verification - Perfect match?&quot;, all(rownames(gene_matrix_t) == tree$tip.label), &quot;\\n&quot;) Final verification - Perfect match? TRUE hc &lt;- as.hclust(tree) pheatmap( gene_matrix_t, cluster_rows = hc, cluster_cols = TRUE, show_rownames = TRUE, show_colnames = FALSE, fontsize = 5, color = c(&quot;white&quot;, &quot;blue&quot;) ) annotation_row &lt;- data.frame( source = genome_metadata$source ) rownames(annotation_row) &lt;- genome_metadata$ID ann_colors &lt;- list( source = source_colors ) # keep only rows in the matrix annotation_row &lt;- annotation_row[rownames(gene_matrix_t), , drop = FALSE] pheatmap( gene_matrix_t, cluster_rows = hc, cluster_cols = TRUE, treeheight_row = 120, show_rownames = TRUE, show_colnames = FALSE, fontsize = 5, color = c(&quot;white&quot;, &quot;blue&quot;), annotation_row = annotation_row, annotation_colors = ann_colors, legend_breaks = c(0, 1), legend_labels = c(&quot;Absent&quot;, &quot;Present&quot;) ) library(ComplexHeatmap) library(circlize) # Heatmap colors col_fun &lt;- colorRamp2(c(0, 1), c(&quot;white&quot;, &quot;blue&quot;)) # Row annotation row_ha &lt;- rowAnnotation( source = annotation_row$source, col = list(source = ann_colors$source) ) Heatmap( gene_matrix_t, name = &quot;Gene presence&quot;, col = col_fun, cluster_rows = hc, cluster_columns = TRUE, show_row_names = TRUE, show_column_names = FALSE, row_names_gp = gpar(fontsize = 6), left_annotation = row_ha ) 2.5 Exploring ppanggolin outputs functional_modules &lt;- read_tsv(&quot;data/pangolin/functional_modules.tsv&quot;) gene_families &lt;- read_tsv(&quot;data/pangolin/gene_families.tsv&quot;, col_names = FALSE) mean_persistent_duplication &lt;- read_tsv(&quot;data/pangolin/mean_persistent_duplication.tsv&quot;) modules_in_genomes &lt;- read_tsv(&quot;data/pangolin/modules_in_genomes.tsv&quot;) modules_RGP_lists &lt;- read_tsv(&quot;data/pangolin/modules_RGP_lists.tsv&quot;) modules_spots &lt;- read_tsv(&quot;data/pangolin/modules_spots.tsv&quot;) modules_summary &lt;- read_tsv(&quot;data/pangolin/modules_summary.tsv&quot;) spot_borders &lt;- read_tsv(&quot;data/pangolin/spot_borders.tsv&quot;) spots &lt;- read_tsv(&quot;data/pangolin/spots.tsv&quot;) summarize_spots &lt;- read_tsv(&quot;data/pangolin/summarize_spots.tsv&quot;) genomes_statistics &lt;- read_tsv(&quot;data/pangolin/genomes_statistics.tsv&quot;, comment= &quot;#&quot;) regions_of_genomic_plasticity &lt;- read_tsv(&quot;data/pangolin/regions_of_genomic_plasticity.tsv&quot;) genome_metadata &lt;- genome_metadata %&gt;% mutate( genome_size = case_when( ID == &quot;GCF_001406015.1&quot; &amp; is.na(genome_size) ~ 5073478, ID == &quot;GCF_002206325.1&quot; &amp; is.na(genome_size) ~ 4963958, TRUE ~ genome_size ) ) excluded_mags &lt;- c(&quot;GCA_015060925.1&quot;) valid_mags &lt;- genome_metadata %&gt;% filter(!ID %in% excluded_mags) %&gt;% pull(ID) genome_annotations &lt;- genome_annotations %&gt;% filter(mag_id %in% valid_mags) genome_metadata &lt;- genome_metadata %&gt;% filter(ID %in% valid_mags) genome_gifts &lt;- genome_gifts[rownames(genome_gifts) %in% valid_mags, ] 2.6 Wrap working objects All working objects are wrapped into a single Rdata object to facilitate downstream usage. save(ehi_mags, phylum_colors, genome_annotations, genome_gifts, contig_to_genome, gtdb_metadata, ehi_metadata, master_index, genome_metadata, source_colors, getphylo_tree, file = &quot;data/data.Rdata&quot;) "],["data-preparation-human.html", "Chapter 3 Data preparation (HUMAN) 3.1 Searching for the MAGs 3.2 Downloading the MAGs and generating data 3.3 R Studio- Data Analysis 3.4 Wrap working objects", " Chapter 3 Data preparation (HUMAN) MAKING SURE THAT THE MAGS FROM GTDB ARE HUMAN 3.1 Searching for the MAGs Choose the MAGs In this case, we will be working with Parabacteroides distasonis and Phocaeicola vulgatus. In the EHI database, select the MAGs with &gt; 90% completeness and &lt; 2.5 contamination. Do the same in the GTDB, but also filter for isolation source CONTAINS human. 3.2 Downloading the MAGs and generating data Download genome indices and metadata Download the EHI_MAG index for each species (in /data/mags_metadata folder) and the curl file and search metadata tsv from the GTDB and place in each species directory in Mjolnir. 2.5) Extract genome metadata - Use the GTDB search tsv to run this script to obtain more metadata. (modify script a bit to make it scalable). python scripts/extract_gtdb_metadata.py Create the master index Run the create_index.R script to create an index of all the MAGs and the download paths (needs a list of species as input and right now it is hardcoded in the script) conda activate mags_r_env Rscript scripts/create_index.R Run the downloading_mags.smk to download all the genomes snakemake -s snakefiles/downloading_mags.smk \\ --executor slurm \\ --jobs 50 \\ --rerun-incomplete \\ --keep-going #testing with the HUMAN_EHI snakemake -s snakefiles/downloading_and_unzipping.smk \\ --executor slurm \\ --jobs 50 \\ --rerun-incomplete \\ --keep-going Unzip all the MAGs and make sure they are in the same folder: run (maybe add this to the downloading_mags.smk) bash scripts/unzip_mags.sh parabacteroides_distasonis bash scripts/unzip_mags.sh phocaeicola_vulgatus Make a screen session for each species. screen -S parabacteroides_distasonis Run drakkar annotating_function.smk to re-annotate all the MAGs: drakkar annotating -b /maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis/mags/unzipped -o /maps/projects/alberdilab/people/pjq449/comparative_metagenomics --env_path /projects/alberdilab/data/environments/drakkar --annotation-type function Annotate with prokka and make phylogenetic tree with getphylo snakemake -s snakefiles/prokka_and_pangenome.smk --profile snakefiles/slurm_profile Run genome_mapping.sh to map the mag ids to the corresponding names bash scripts/genome_mapping.sh #dont think we need this now Run drep sbatch scripts/drep_compare.slurm Run create_pangolin_input.R to create the input file ppanggolin needs conda activate mags_r_env Rscript scripts/create_pangolin_input.R #or if we want to use the annotation files by prokka: Rscript scripts/create_pangolin_input_gff.R Pangenome analysis with ppanggolin conda activate ppanggolin ppanggolin all --fasta /maps/projects/alberdilab/people/pjq449/comparative_metagenomics/data/parabacteroides_distasonis_HUMAN_EHI/ppanggolin_input.tsv 3.3 R Studio- Data Analysis 3.3.1 EHI MAGs ehi_mags &lt;- read_csv(&quot;data/ehi_mags.csv&quot;) Rows: 8846 Columns: 52 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, class, or... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, coding_de... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 3.3.2 Prepare color scheme AlberdiLab projects use unified color schemes developed for the Earth Hologenome Initiative, to facilitate figure interpretation. ehi_mags_p &lt;- ehi_mags %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(ehi_mags_p, by=join_by(phylum == phylum)) %&gt;% dplyr::select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% pull(colors, name=phylum) #source_colors &lt;- c(EHI = &quot;#8BC63F&quot;, GTDB = &quot;#2D522D&quot;) source_colors_human &lt;- c(EHI = &quot;#8BC63F&quot;, GTDB = &quot;#A90D00&quot;) 3.3.3 Sample metadata gtdb_search_metadata &lt;- read_tsv(&quot;data/human/gtdb_search_results.tsv&quot;) Warning: One or more parsing issues, call `problems()` on your data frame for details, e.g.: dat &lt;- vroom(...) problems(dat) Rows: 47 Columns: 10 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (7): Accession, Organism Name, NCBI Taxonomy, GTDB Taxonomy, GTDB Type Material, Isolation Source, Isolation Sour... dbl (2): CheckM2 Completeness, CheckM Contamination lgl (1): GTDB Representative of Species ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. colnames(gtdb_search_metadata) [1] &quot;Accession&quot; &quot;Organism Name&quot; &quot;NCBI Taxonomy&quot; [4] &quot;GTDB Taxonomy&quot; &quot;GTDB Representative of Species&quot; &quot;GTDB Type Material&quot; [7] &quot;CheckM2 Completeness&quot; &quot;CheckM Contamination&quot; &quot;Isolation Source&quot; [10] &quot;Isolation Source_2&quot; gtdb_accession_metadata&lt;- read_tsv(&quot;data/human/parabacteroides_distasonis_human_GTDB_accession_metadata.tsv&quot;) Rows: 47 Columns: 115 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (69): accession, checkm2_model, checkm_marker_lineage, gtdb_genome_representative, gtdb_taxonomy, gtdb_type_desi... dbl (39): ambiguous_bases, checkm2_completeness, checkm2_contamination, checkm_completeness, checkm_contamination, c... lgl (5): gtdb_representative, gtdb_type_species_of_genus, mimag_high_quality, mimag_low_quality, mimag_medium_quality date (2): ncbi_date, ncbi_seq_rel_date ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. ehi_metadata &lt;- read_tsv(&quot;data/mags_metadata/parabacteroides_distasonis_metadata.tsv&quot;) %&gt;% mutate(GC = as.numeric(str_remove(GC, &quot;%&quot;))) Rows: 25 Columns: 52 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, class, or... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, coding_de... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 3.3.4 Load genome mapping # Prepare EHI metadata with standardized column names ehi_clean &lt;- ehi_metadata %&gt;% dplyr::select( ID, species, completeness, contamination, genome_size = size, GC, N50, contigs, host_species, host_order, host_class, assembly_type, isolation_source= sample_type, mag_name, eha_number ) %&gt;% mutate(source = &quot;EHI&quot;) # Prepare GTDB metadata # Join search and accession metadata gtdb_metadata &lt;- full_join(gtdb_accession_metadata, gtdb_search_metadata, by = c(&quot;search_accession&quot; = &quot;Accession&quot;) ) # Prepare GTDB metadata gtdb_clean &lt;- gtdb_metadata %&gt;% dplyr::select( ID = search_accession, completeness = &quot;checkm2_completeness&quot;, contamination = &quot;checkm2_contamination&quot;, gtdb_taxonomy = &quot;GTDB Taxonomy&quot;, isolation_source = &quot;Isolation Source&quot;, genome_size, GC = gc_percentage, N50 = n50_contigs, contigs = contig_count, ncbi_country, mimag_high_quality, mimag_medium_quality, gtdb_representative, mag_name = search_accession )%&gt;% mutate(source = &quot;GTDB&quot;) #Join genome_metadata &lt;- bind_rows(ehi_clean, gtdb_clean) # Read master index master_index &lt;- read_tsv(&quot;data/human/master_mag_index_2.tsv&quot;) %&gt;% filter(species == &quot;parabacteroides_distasonis&quot;) %&gt;% mutate( # Extract the actual genome identifier from out_path genome_identifier = case_when( # For EHI: extract EHA00531_bin.1 from the filename str_detect(out_path, &quot;EHA&quot;) ~ str_extract(out_path, &quot;EHA[0-9]+_bin\\\\.[0-9]+&quot;), # For NCBI: use the ID as is (GCA/GCF number) TRUE ~ ID ) ) Rows: 72 Columns: 4 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (4): species, ID, MAG_url, out_path ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. # Check the mapping print(&quot;Master index mapping:&quot;) [1] &quot;Master index mapping:&quot; master_index %&gt;% dplyr::select(ID, genome_identifier, out_path) %&gt;% head(10) %&gt;% print() # A tibble: 0 × 3 # ℹ 3 variables: ID &lt;chr&gt;, genome_identifier &lt;chr&gt;, out_path &lt;chr&gt; # Read contig-to-genome mapping contig_to_genome &lt;- read_tsv(&quot;data/human/contig_to_mag.tsv&quot;, col_names = c(&quot;contig&quot;, &quot;genome_filename&quot;)) Rows: 10094 Columns: 2 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (2): contig, genome_filename ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 3.3.5 Genome annotations genome_annotations &lt;-read_tsv(&quot;data/human/gene_annotations_human.tsv.xz&quot;) Warning: One or more parsing issues, call `problems()` on your data frame for details, e.g.: dat &lt;- vroom(...) problems(dat) Rows: 275277 Columns: 13 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (11): gene, strand, kegg, ec, pfam, cazy, resistance_type, resistance_target, vf, vf_type, signalp dbl (2): start, end ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. # Read annotations and add IDs genome_annotations &lt;- read_tsv(&quot;data/human/gene_annotations_human.tsv.xz&quot;) %&gt;% mutate(contig = sub(&quot;_[^_]*$&quot;, &quot;&quot;, gene)) %&gt;% left_join(contig_to_genome, by = &quot;contig&quot;) %&gt;% mutate(genome= genome_filename)%&gt;% filter(!is.na(genome)) Warning: One or more parsing issues, call `problems()` on your data frame for details, e.g.: dat &lt;- vroom(...) problems(dat) Rows: 275277 Columns: 13 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;\\t&quot; chr (11): gene, strand, kegg, ec, pfam, cazy, resistance_type, resistance_target, vf, vf_type, signalp dbl (2): start, end ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. 3.3.6 Distill annotations into GIFTs genome_gifts &lt;- distill(genome_annotations,GIFT_db,genomecol= 15, annotcol=c(5,6,7,8), verbosity = T) 3.3.7 Load trees genome_metadata$mag_name &lt;- sub(&quot;\\\\.fa$&quot;, &quot;&quot;, genome_metadata$mag_name)#remove .fa from the mag names so that they match the tree ids getphylo_tree &lt;- read_tree(&quot;data/combined_alignment.tree&quot;) getphylo_tree$tip.label &lt;- gsub(&quot;&#39;&quot;, &quot;&quot;, getphylo_tree$tip.label) tip_df &lt;- data.frame(label = getphylo_tree$tip.label) %&gt;% left_join(genome_metadata, by = c(&quot;label&quot; = &quot;mag_name&quot;)) #replace long mag names with IDs getphylo_tree$tip.label &lt;- tip_df$ID 3.4 Wrap working objects All working objects are wrapped into a single Rdata object to facilitate downstream usage. save(ehi_mags, phylum_colors, genome_annotations, genome_gifts, contig_to_genome, gtdb_metadata, ehi_metadata, master_index, genome_metadata, source_colors, getphylo_tree, file = &quot;data/human/data.Rdata&quot;) "],["ehi-mags-exploration.html", "Chapter 4 EHI MAGs exploration", " Chapter 4 EHI MAGs exploration 4.0.1 EHI MAGs load(&quot;data/data.Rdata&quot;) ehi_mags &lt;- read_csv(&quot;data/ehi_mags.csv&quot;) Rows: 8846 Columns: 52 ── Column specification ───────────────────────────────────────────────────────────────────────────────────────────────── Delimiter: &quot;,&quot; chr (36): ID, mag_name, link_to_assembly, AB_batch, eha_number, GTDB_version, GTDB_release, domain, phylum, class, or... dbl (15): fastani_ani, closest_placement_ani, closest_placement_af, completeness, contamination, size, N50, coding_de... lgl (1): annotated ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message. colnames(ehi_mags) [1] &quot;ID&quot; &quot;mag_name&quot; &quot;link_to_assembly&quot; &quot;AB_batch&quot; [5] &quot;eha_number&quot; &quot;GTDB_version&quot; &quot;GTDB_release&quot; &quot;domain&quot; [9] &quot;phylum&quot; &quot;class&quot; &quot;order&quot; &quot;family&quot; [13] &quot;genus&quot; &quot;species&quot; &quot;fastani_ani&quot; &quot;closest_placement_ani&quot; [17] &quot;closest_placement_af&quot; &quot;completeness&quot; &quot;contamination&quot; &quot;size&quot; [21] &quot;GC&quot; &quot;N50&quot; &quot;coding_density&quot; &quot;contigs&quot; [25] &quot;number_genes&quot; &quot;number_unannotated_genes&quot; &quot;DM_batch&quot; &quot;host_species&quot; [29] &quot;host_order&quot; &quot;host_class&quot; &quot;MAG_url&quot; &quot;anno_url&quot; [33] &quot;kegg_url&quot; &quot;annotated&quot; &quot;taxonomy_level&quot; &quot;assembly_type&quot; [37] &quot;sample_type&quot; &quot;gbk_url&quot; &quot;kegg_hits&quot; &quot;Capture ID&quot; [41] &quot;percent_unannotated_genes&quot; &quot;percent_unannotated_kegg&quot; &quot;dereplicated&quot; &quot;metagenomic source&quot; [45] &quot;completeness software&quot; &quot;binning software&quot; &quot;assembly quality&quot; &quot;binning parameters&quot; [49] &quot;taxonomic identity marker&quot; &quot;isolation_source&quot; &quot;assembly software&quot; &quot;Submission&quot; Check contamination and completeness genome_biplot &lt;- ehi_mags %&gt;% dplyr::select(c(phylum,completeness,contamination,size)) %&gt;% ggplot(aes(x=completeness,y=contamination,size=size,color=phylum)) + geom_point(alpha=0.7) + xlim(c(70,100)) + ylim(c(10,0)) + scale_color_manual(values=phylum_colors) + labs(y= &quot;Contamination&quot;, x = &quot;Completeness&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;) #Generate contamination boxplot genome_contamination &lt;- ehi_mags %&gt;% ggplot(aes(y=contamination)) + ylim(c(10,0)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0.40, 0),&quot;inches&quot;)) #add bottom-margin (top, right, bottom, left) genome_completeness &lt;- ehi_mags %&gt;% ggplot(aes(x=completeness)) + xlim(c(70,100)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0, 0.50),&quot;inches&quot;)) #add left-margin (top, right, bottom, left) #Render composite figure #pdf(&quot;figures/completeness_contamination.pdf&quot;,width=10, height=5) grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination), layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3))) Warning: Removed 1721 rows containing non-finite outside the scale range (`stat_boxplot()`). Warning: No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. Warning: Removed 1721 rows containing missing values or values outside the scale range (`geom_point()`). Warning: Removed 1 row containing non-finite outside the scale range (`stat_boxplot()`). Filter by completeness and contamination ehi_mags_filtered &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5) 4.0.2 Host classes species_hostclass_counts &lt;- ehi_mags %&gt;% filter(!is.na(species), species != &quot;&quot;) %&gt;% filter(!is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_mags = n(), n_host_classes = n_distinct(host_class), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), phylum = paste(unique(phylum), collapse = &quot;, &quot;) ) %&gt;% arrange(desc(n_host_classes)) species_selection &lt;- species_hostclass_counts %&gt;% filter(n_host_classes &gt;= 3) species_selection # A tibble: 34 × 5 species n_mags n_host_classes host_classes phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Hafnia alvei 61 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 2 s__Pseudomonas aeruginosa 99 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 3 s__Aeromonas encheleia 18 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 4 s__Bacteroides caccae 13 3 Aves, Mammalia, Reptilia p__Bacteroidota 5 s__Bacteroides fragilis 20 3 Aves, Mammalia, Reptilia p__Bacteroidota 6 s__Bacteroides nordii 23 3 Aves, Mammalia, Reptilia p__Bacteroidota 7 s__Bacteroides thetaiotaomicron 42 3 Aves, Mammalia, Reptilia p__Bacteroidota 8 s__Bacteroides uniformis 84 3 Aves, Mammalia, Reptilia p__Bacteroidota 9 s__Bacteroides xylanisolvens 27 3 Aves, Mammalia, Reptilia p__Bacteroidota 10 s__Bilophila wadsworthia 12 3 Aves, Mammalia, Reptilia p__Desulfobacterota # ℹ 24 more rows species_selection %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 5 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 5 2 p__Bacillota_A 2 3 p__Bacteroidota 8 4 p__Desulfobacterota 1 5 p__Pseudomonadota 18 4.0.3 Host classes- after filtering species_hostclass_counts_f &lt;- ehi_mags_filtered %&gt;% dplyr::filter(!is.na(species), species != &quot;&quot;) %&gt;% dplyr::filter(!is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_mags = n(), n_host_classes = n_distinct(host_class), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), phylum = paste(unique(phylum), collapse = &quot;, &quot;) ) %&gt;% arrange(desc(n_host_classes)) species_selection_f &lt;- species_hostclass_counts_f %&gt;% dplyr::filter(n_host_classes &gt;= 3, n_mags &gt; 10) %&gt;% arrange(desc(n_mags)) species_selection_f # A tibble: 10 × 5 species n_mags n_host_classes host_classes phylum &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;chr&gt; 1 s__Escherichia coli 64 3 Aves, Mammalia, Reptilia p__Pseudomonadota 2 s__Pseudomonas aeruginosa 55 4 Amphibia, Aves, Mammalia, Reptilia p__Pseudomonadota 3 s__Lactococcus lactis 38 3 Aves, Mammalia, Reptilia p__Bacillota 4 s__Hafnia paralvei 25 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 5 s__Parabacteroides distasonis 25 3 Aves, Mammalia, Reptilia p__Bacteroidota 6 s__Enterococcus faecalis 21 3 Aves, Mammalia, Reptilia p__Bacillota 7 s__Bacteroides uniformis 19 3 Aves, Mammalia, Reptilia p__Bacteroidota 8 s__Phocaeicola vulgatus 19 3 Aves, Mammalia, Reptilia p__Bacteroidota 9 s__Citrobacter braakii 16 3 Amphibia, Mammalia, Reptilia p__Pseudomonadota 10 s__Moellerella wisconsensis 13 3 Amphibia, Aves, Mammalia p__Pseudomonadota species_selection_list&lt;- species_selection_f %&gt;% pull(species) species_selection_f %&gt;% group_by(phylum)%&gt;% summarize(n_species = n()) # A tibble: 3 × 2 phylum n_species &lt;chr&gt; &lt;int&gt; 1 p__Bacillota 2 2 p__Bacteroidota 3 3 p__Pseudomonadota 5 4.0.4 Count host classes per species species_hostclass_counts &lt;- ehi_mags_filtered %&gt;% dplyr::filter(!is.na(species), species != &quot;&quot;, !is.na(host_class), host_class != &quot;&quot;) %&gt;% group_by(species) %&gt;% summarise( n_host_classes = n_distinct(host_class)) %&gt;% arrange(desc(n_host_classes)) counts_species_per_class&lt;- species_hostclass_counts %&gt;% group_by(n_host_classes)%&gt;% summarize(n_species = n()) ggplot(counts_species_per_class, aes(x = n_host_classes, y = n_species)) + geom_col() + geom_text( aes(label = n_species), vjust = -0.3, size = 4 ) + labs( title = &quot;Number of Species per Number of Host Classes&quot;, x = &quot;Number of Host Classes&quot;, y = &quot;Number of Species&quot; ) + theme_bw() mags_with_counts &lt;- ehi_mags_filtered %&gt;% left_join(species_hostclass_counts, by = &quot;species&quot;) #filter for mags with &gt;2 host classes mags_host3 &lt;- mags_with_counts %&gt;% dplyr::filter(n_host_classes &gt;= 3) n_mags &lt;- mags_host3 %&gt;% group_by(species) %&gt;% summarise(n_mags = n(), .groups = &quot;drop&quot;) #Species level: species_host3 &lt;- mags_host3 %&gt;% group_by(species)%&gt;% summarise(phylum = dplyr::first(phylum), order = dplyr::first(order), family = dplyr::first(family), genus = dplyr::first(genus), host_classes = paste(sort(unique(host_class)), collapse = &quot;, &quot;), host_species = paste(sort(unique(host_species)), collapse = &quot;, &quot;)) We have several MAGs per species, so here we select the “best MAG” (highest completeness and lowest contamination), to have statistics based on the best of each. best_mag_per_species &lt;- mags_host3 %&gt;% group_by(species) %&gt;% arrange(desc(completeness), contamination) %&gt;% slice_head(n = 1) %&gt;% ungroup() %&gt;% transmute( species, best_mag_name = mag_name, best_MAG_link = link_to_assembly, best_genome_size = size, best_completeness = completeness, best_contamination = contamination, best_N50 = N50, best_host_classes = host_class, best_assembly_type = assembly_type, best_phylum =str_remove_all(phylum, &quot;p__&quot;)) ggplot(best_mag_per_species, aes(x= species, y = best_genome_size, fill = best_phylum))+ scale_color_manual(values=phylum_colors) + scale_fill_manual(values=phylum_colors) + geom_col()+ theme_bw()+ theme(axis.text.x = element_text(angle = 90)) Warning: No shared levels found between `names(values)` of the manual scale and the data&#39;s colour values. Filtering for Parabacteroides distasonis (make into a loop for all the relevant species later) p_dist &lt;- ehi_mags %&gt;% filter(completeness &gt;90, contamination &lt; 2.5, species == &quot;s__Parabacteroides distasonis&quot;) write_tsv(p_dist, &quot;data/mags_metadata/parabacteroides_distasonis_metadata.tsv&quot;) p_dist_index &lt;- p_dist %&gt;% dplyr::select(ID, MAG_url) write_tsv(p_dist_index, &quot;data/mags_metadata/parabacteroides_distasonis_index.tsv&quot;) #Loop through each species in species_selection list for (i in 1:nrow(species_selection_f)) { current_species &lt;- species_selection_f$species[i] #Filter for completeness and contamination #get metadata species_data &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5, species == current_species) #get index species_index &lt;- species_data %&gt;% dplyr::select(ID, MAG_url) #Filename from species name filename &lt;- current_species %&gt;% str_replace(&quot;s__&quot;, &quot;&quot;) %&gt;% str_replace_all(&quot; &quot;, &quot;_&quot;) %&gt;% tolower() #export to tsv write_tsv(species_data, paste0(&quot;data/mags_metadata/&quot;, filename, &quot;_metadata.tsv&quot;)) write_tsv(species_index, paste0(&quot;data/mags_metadata/&quot;, filename, &quot;_index.tsv&quot;)) } ### First only with two: all_mags &lt;- ehi_mags %&gt;% filter(completeness &gt; 90, contamination &lt; 2.5, species %in% c(&quot;s__Parabacteroides distasonis&quot;, &quot;s__Phocaeicola vulgatus&quot;)) %&gt;% mutate(species = str_remove(species, &quot;^s__&quot;) %&gt;% str_to_lower() %&gt;% str_replace(&quot; &quot;, &quot;_&quot;), out_path = paste0(&quot;data/&quot;, species, &quot;/mags/&quot;, basename(MAG_url)) ) %&gt;% dplyr::select(species, ID, MAG_url, out_path) write_tsv(all_mags, &quot;all_mags_index.tsv&quot;) "],["data-statistics.html", "Chapter 5 Data statistics", " Chapter 5 Data statistics load(&quot;data/data.Rdata&quot;) Total number of MAGs genome_metadata %&gt;% dplyr::count(source) # A tibble: 2 × 2 source n &lt;chr&gt; &lt;int&gt; 1 EHI 25 2 GTDB 69 5.0.1 Mean completeness and contamination genome_metadata %&gt;% summarise( mean_c = mean(completeness, na.rm = TRUE) %&gt;% round(2), sd_c = sd(completeness, na.rm = TRUE) %&gt;% round(2), mean_con = mean(contamination, na.rm = TRUE) %&gt;% round(2), sd_con = sd(contamination, na.rm = TRUE) %&gt;% round(2) ) %&gt;% unite(&quot;Completeness&quot;, mean_c, sd_c, sep = &quot; ± &quot;) %&gt;% unite(&quot;Contamination&quot;, mean_con, sd_con, sep = &quot; ± &quot;) %&gt;% tt() .table td.tinytable_css_1klzlqj7ax9t20k4cndp, .table th.tinytable_css_1klzlqj7ax9t20k4cndp { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_xwe3pv7z9672larqkj95, .table th.tinytable_css_xwe3pv7z9672larqkj95 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } Completeness Contamination 97.71 ± 2.64 1.15 ± 0.64 #Generate quality biplot genome_biplot &lt;- genome_metadata %&gt;% dplyr::select(c(ID,completeness,contamination, source)) %&gt;% ggplot(aes(x=completeness,y=contamination, color = source)) + scale_color_manual(values = source_colors)+ geom_point(alpha=0.7) + xlim(c(90,100)) + ylim(c(2.5,0)) + labs(y= &quot;Contamination&quot;, x = &quot;Completeness&quot;) + theme_classic() + theme(legend.position = &quot;left&quot;) #Generate contamination boxplot genome_contamination &lt;- genome_metadata %&gt;% ggplot(aes(y=contamination)) + ylim(c(10,0)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0.40, 0),&quot;inches&quot;)) #add bottom-margin (top, right, bottom, left) #Generate completeness boxplot genome_completeness &lt;- genome_metadata %&gt;% ggplot(aes(x=completeness)) + xlim(c(70,100)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0, 0.50),&quot;inches&quot;)) #add left-margin (top, right, bottom, left) #Render composite figure #pdf(&quot;figures/completeness_contamination.pdf&quot;,width=10, height=5) grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination), layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3))) #dev.off() ggplot(genome_metadata, aes(x= ID, y = genome_size, fill = source))+ scale_fill_manual(values = source_colors)+ geom_col()+ theme_classic() ggplot(genome_metadata, aes(x= source, y = genome_size, fill = source))+ scale_fill_manual(values = source_colors)+ geom_boxplot()+ geom_point()+ theme_classic()+ labs(y = &quot;Genome Size&quot;, x = &quot;Source&quot;) genome_metadata%&gt;% filter(genome_size == min(genome_size)) # A tibble: 1 × 25 ID species completeness contamination genome_size GC N50 contigs host_species host_order host_class &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 GCA_015060925.1 Parabac… 92.9 0 2539824 39.1 102430 41 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; # ℹ 14 more variables: assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, mag_name &lt;chr&gt;, eha_number &lt;chr&gt;, locality &lt;chr&gt;, # country &lt;chr&gt;, extra_locality &lt;chr&gt;, source &lt;chr&gt;, gtdb_taxonomy &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, # mimag_medium_quality &lt;lgl&gt;, gtdb_representative &lt;lgl&gt;, ncbi_date &lt;date&gt;, continent &lt;chr&gt; ggplot(genome_metadata, aes(x= ID, y = contamination, fill = source))+ scale_fill_manual(values = source_colors)+ geom_col()+ theme_classic() ggplot(genome_metadata, aes(x= source, y = contamination, fill = source))+ scale_fill_manual(values = source_colors)+ geom_boxplot()+ theme_classic()+ labs(y = &quot;Contamination&quot;, x = &quot;Source&quot;) ggplot(genome_metadata, aes(x= ID, y = completeness, fill = source))+ scale_fill_manual(values = source_colors)+ geom_col()+ theme_classic() ggplot(genome_metadata, aes(x= source, y = completeness, fill = source))+ scale_fill_manual(values = source_colors)+ geom_point()+ geom_boxplot()+ theme_classic()+ labs(y = &quot;Completeness&quot;, x = &quot;Source&quot;) wilcox.test(contamination ~ source, data=genome_metadata) %&gt;% tidy() # A tibble: 1 × 4 statistic p.value method alternative &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 1 1118. 0.0288 Wilcoxon rank sum test with continuity correction two.sided wilcox.test(completeness ~ source, data=genome_metadata) %&gt;% tidy() # A tibble: 1 × 4 statistic p.value method alternative &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 1 661 0.0751 Wilcoxon rank sum test with continuity correction two.sided wilcox.test(genome_size ~ source, data=genome_metadata) %&gt;% tidy() # A tibble: 1 × 4 statistic p.value method alternative &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 1 373 0.0000286 Wilcoxon rank sum test with continuity correction two.sided # Combine the summaries ehi_stats &lt;- genome_metadata %&gt;% filter(source == &quot;EHI&quot;) %&gt;% mutate(genome_size_mb = genome_size/1000000) %&gt;% summarise( m_gs = round(mean(genome_size_mb), 2), sd_gs = round(sd(genome_size_mb), 2), m_cont = round(mean(contamination), 2), sd_cont = round(sd(contamination), 2), m_comp = round(mean(completeness), 2), sd_comp = round(sd(completeness), 2) ) %&gt;% unite(&quot;Mean genome size&quot;,m_gs, sd_gs, sep = &quot; ± &quot;, remove = TRUE) %&gt;% unite(&quot;Mean completeness&quot;,m_comp, sd_comp, sep = &quot; ± &quot;, remove = TRUE) %&gt;% unite(&quot;Mean contamination&quot;,m_cont, sd_cont, sep = &quot; ± &quot;, remove = TRUE) %&gt;% mutate(Source = &quot;EHI&quot;) %&gt;% dplyr::select(Source, everything()) gtdb_stats &lt;- genome_metadata %&gt;% filter(source == &quot;GTDB&quot;) %&gt;% filter(!is.na(genome_size)) %&gt;% mutate(genome_size_mb = genome_size/1000000) %&gt;% summarise( m_gs = round(mean(genome_size_mb), 2), sd_gs = round(sd(genome_size_mb), 2), m_cont = round(mean(contamination), 2), sd_cont = round(sd(contamination), 2), m_comp = round(mean(completeness), 2), sd_comp = round(sd(completeness), 2) ) %&gt;% unite(&quot;Mean genome size&quot;,m_gs, sd_gs, sep = &quot; ± &quot;, remove = TRUE) %&gt;% unite(&quot;Mean completeness&quot;,m_comp, sd_comp, sep = &quot; ± &quot;, remove = TRUE) %&gt;% unite(&quot;Mean contamination&quot;,m_cont, sd_cont, sep = &quot; ± &quot;, remove = TRUE) %&gt;% mutate(Source = &quot;GTDB&quot;) %&gt;% dplyr::select(Source, everything()) # Combine into one table summary_table &lt;- bind_rows(ehi_stats, gtdb_stats) summary_table # A tibble: 2 × 4 Source `Mean genome size` `Mean contamination` `Mean completeness` &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHI 4.36 ± 0.45 1.41 ± 0.63 96 ± 3.4 2 GTDB 4.81 ± 0.45 1.06 ± 0.62 98.34 ± 1.99 "],["data-statistics-human.html", "Chapter 6 Data statistics (HUMAN)", " Chapter 6 Data statistics (HUMAN) 6.0.1 Load data load(&quot;data/human/data.Rdata&quot;) Total number of MAGs genome_metadata %&gt;% dplyr::count(source) # A tibble: 2 × 2 source n &lt;chr&gt; &lt;int&gt; 1 EHI 25 2 GTDB 47 genome_metadata %&gt;% summarise( mean_c = mean(completeness, na.rm = TRUE) %&gt;% round(2), sd_c = sd(completeness, na.rm = TRUE) %&gt;% round(2), mean_con = mean(contamination, na.rm = TRUE) %&gt;% round(2), sd_con = sd(contamination, na.rm = TRUE) %&gt;% round(2) ) %&gt;% unite(&quot;Completeness&quot;, mean_c, sd_c, sep = &quot; ± &quot;) %&gt;% unite(&quot;Contamination&quot;, mean_con, sd_con, sep = &quot; ± &quot;) %&gt;% tt() .table td.tinytable_css_r42s9fk7iag50ft873qf, .table th.tinytable_css_r42s9fk7iag50ft873qf { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_lqgfzt0zrmv7f9perxfa, .table th.tinytable_css_lqgfzt0zrmv7f9perxfa { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } Completeness Contamination 97.89 ± 2.81 1.02 ± 0.61 #Generate quality biplot genome_biplot &lt;- genome_metadata %&gt;% dplyr::select(c(ID,completeness,contamination)) %&gt;% ggplot(aes(x=completeness,y=contamination)) + geom_point(alpha=0.7) + xlim(c(90,100)) + ylim(c(2.5,0)) + labs(y= &quot;Contamination&quot;, x = &quot;Completeness&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;) #Generate contamination boxplot genome_contamination &lt;- genome_metadata %&gt;% ggplot(aes(y=contamination)) + ylim(c(10,0)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0.40, 0),&quot;inches&quot;)) #add bottom-margin (top, right, bottom, left) #Generate completeness boxplot genome_completeness &lt;- genome_metadata %&gt;% ggplot(aes(x=completeness)) + xlim(c(70,100)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;, axis.line = element_blank(), axis.title = element_blank(), axis.text=element_blank(), axis.ticks=element_blank(), plot.margin = unit(c(0, 0, 0, 0.50),&quot;inches&quot;)) #add left-margin (top, right, bottom, left) #Render composite figure #pdf(&quot;figures/completeness_contamination.pdf&quot;,width=10, height=5) grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination), layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3))) #dev.off() "],["phylogenetic-analysis.html", "Chapter 7 Phylogenetic Analysis", " Chapter 7 Phylogenetic Analysis 7.0.1 Load data load(&quot;data/data.Rdata&quot;) # Merge tip data with tree tip_df &lt;- data.frame(label = getphylo_tree$tip.label) %&gt;% left_join(genome_metadata, by = c(&quot;label&quot; = &quot;ID&quot;)) p &lt;- ggtree(getphylo_tree) %&lt;+% tip_df + geom_tiplab(aes(color = source), size = 3) + theme_tree2() + scale_color_manual(values = source_colors) Warning in fortify(data, ...): Arguments in `...` must be used. ✖ Problematic arguments: • as.Date = as.Date • yscale_mapping = yscale_mapping • hang = hang ℹ Did you misspell an argument name? p #Remove GCA_015060925.1 getphylo_tree_trimmed &lt;- drop.tip(getphylo_tree, &quot;GCA_015060925.1&quot;) tip_df_trimmed &lt;- tip_df %&gt;% filter(label != &quot;GCA_015060925.1&quot;) p &lt;- ggtree(getphylo_tree_trimmed) %&lt;+% tip_df_trimmed + geom_tiplab(aes(color = source), size = 3) + theme_tree2() + scale_color_manual(values = source_colors) Warning in fortify(data, ...): Arguments in `...` must be used. ✖ Problematic arguments: • as.Date = as.Date • yscale_mapping = yscale_mapping • hang = hang ℹ Did you misspell an argument name? p Circular tree with genome size and completeness # Generate basal tree circular_tree &lt;- force.ultrametric(getphylo_tree_trimmed, method=&quot;extend&quot;) %&gt;% # extend to ultrametric for the sake of visualization ggtree(., layout=&quot;fan&quot;, open.angle=10, size=0.5) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** # Add completeness ring circular_tree &lt;- circular_tree + new_scale_fill() + scale_fill_gradient(low = &quot;#d1f4ba&quot;, high = &quot;#f4baba&quot;) + geom_fruit( data=genome_metadata, geom=geom_bar, mapping = aes(x=completeness, y=ID, fill=contamination), offset = 0.24, pwidth = 0.1, orientation=&quot;y&quot;, stat=&quot;identity&quot;)+ labs(fill=&quot;Contamination&quot;) # Add genome-size ring circular_tree &lt;- circular_tree + new_scale_fill() circular_tree &lt;- circular_tree + geom_fruit( data=genome_metadata, geom=geom_bar, mapping = aes(x=genome_size, y=ID), fill = &quot;#1e6e55&quot;, offset = 0.05, orientation=&quot;y&quot;, stat=&quot;identity&quot;) #Plot circular tree circular_tree %&gt;% open_tree(30) %&gt;% rotate_tree(90) Circular tree with host and source # Generate basal tree circular_tree &lt;- force.ultrametric(getphylo_tree_trimmed, method=&quot;extend&quot;) %&gt;% # extend to ultrametric for the sake of visualisation ggtree(., layout=&quot;fan&quot;, open.angle=10, size=0.4) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** #Host species ring circular_tree &lt;- circular_tree + new_scale_fill() + geom_fruit( data = genome_metadata, geom = geom_tile, mapping = aes(y = ID, fill = host_species), width = 0.005, offset = 0.10 ) + scale_fill_brewer(palette = &quot;Set3&quot;) + labs(fill = &quot;Host&quot;) #source ring circular_tree &lt;- circular_tree + new_scale_fill() + geom_fruit( data = genome_metadata, geom = geom_tile, mapping = aes(y = ID, fill = source), width = 0.005, offset = 0.15 ) + scale_fill_manual(values = source_colors) + labs(fill = &quot;Source&quot;) # Plot circular_tree %&gt;% open_tree(30) %&gt;% rotate_tree(90) "],["phylogenetic-analysis-human.html", "Chapter 8 Phylogenetic Analysis (HUMAN)", " Chapter 8 Phylogenetic Analysis (HUMAN) 8.0.1 Load data load(&quot;data/human/data.Rdata&quot;) # Merge tip data with tree tip_df &lt;- data.frame(label = getphylo_tree$tip.label) %&gt;% left_join(genome_metadata, by = c(&quot;label&quot; = &quot;ID&quot;)) p &lt;- ggtree(getphylo_tree) %&lt;+% tip_df + geom_tiplab(aes(color = source), size = 3) + theme_tree2() + scale_color_manual(values = source_colors) Warning in fortify(data, ...): Arguments in `...` must be used. ✖ Problematic arguments: • as.Date = as.Date • yscale_mapping = yscale_mapping • hang = hang ℹ Did you misspell an argument name? p #Remove GCA_015060925.1 getphylo_tree_trimmed &lt;- drop.tip(getphylo_tree, &quot;GCA_015060925.1&quot;) tip_df_trimmed &lt;- tip_df %&gt;% filter(label != &quot;GCA_015060925.1&quot;) p &lt;- ggtree(getphylo_tree_trimmed) %&lt;+% tip_df_trimmed + geom_tiplab(aes(color = source), size = 3) + theme_tree2() + scale_color_manual(values = source_colors) Warning in fortify(data, ...): Arguments in `...` must be used. ✖ Problematic arguments: • as.Date = as.Date • yscale_mapping = yscale_mapping • hang = hang ℹ Did you misspell an argument name? p Circular tree with genome size and completeness # Generate basal tree circular_tree &lt;- force.ultrametric(getphylo_tree_trimmed, method=&quot;extend&quot;) %&gt;% # extend to ultrametric for the sake of visualization ggtree(., layout=&quot;fan&quot;, open.angle=10, size=0.5) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** # Add completeness ring circular_tree &lt;- circular_tree + new_scale_fill() + scale_fill_gradient(low = &quot;#d1f4ba&quot;, high = &quot;#f4baba&quot;) + geom_fruit( data=genome_metadata, geom=geom_bar, mapping = aes(x=completeness, y=ID, fill=contamination), offset = 0.24, pwidth = 0.1, orientation=&quot;y&quot;, stat=&quot;identity&quot;)+ labs(fill=&quot;Contamination&quot;) # Add genome-size ring circular_tree &lt;- circular_tree + new_scale_fill() circular_tree &lt;- circular_tree + geom_fruit( data=genome_metadata, geom=geom_bar, mapping = aes(x=genome_size, y=ID), fill = &quot;#1e6e55&quot;, offset = 0.05, orientation=&quot;y&quot;, stat=&quot;identity&quot;) #Plot circular tree circular_tree %&gt;% open_tree(30) %&gt;% rotate_tree(90) Circular tree with host and source # Generate basal tree circular_tree &lt;- force.ultrametric(getphylo_tree_trimmed, method=&quot;extend&quot;) %&gt;% # extend to ultrametric for the sake of visualisation ggtree(., layout=&quot;fan&quot;, open.angle=10, size=0.4) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** #Host species ring circular_tree &lt;- circular_tree + new_scale_fill() + geom_fruit( data = genome_metadata, geom = geom_tile, mapping = aes(y = ID, fill = host_species), width = 0.005, offset = 0.10 ) + scale_fill_brewer(palette = &quot;Set3&quot;) + labs(fill = &quot;Host&quot;) #source ring circular_tree &lt;- circular_tree + new_scale_fill() + geom_fruit( data = genome_metadata, geom = geom_tile, mapping = aes(y = ID, fill = source), width = 0.005, offset = 0.15 ) + scale_fill_manual(values = source_colors) + labs(fill = &quot;Source&quot;) # Plot circular_tree %&gt;% open_tree(30) %&gt;% rotate_tree(90) "],["functional-analysis.html", "Chapter 9 Functional Analysis 9.1 Functional overview 9.2 KEGG 9.3 GIFTs", " Chapter 9 Functional Analysis 9.1 Functional overview n_genes &lt;- genome_annotations %&gt;% group_by(genome) %&gt;% summarize(n_genes = n()) n_genes # A tibble: 94 × 2 genome n_genes &lt;chr&gt; &lt;int&gt; 1 EHA00531_bin.1 4139 2 EHA00535_bin.6 3426 3 EHA00539_bin.6 3839 4 EHA00726_bin.13 3950 5 EHA00928_bin.90 3569 6 EHA01202_bin.66 3139 7 EHA01281_bin.18 3922 8 EHA01439_bin.44 3572 9 EHA01634_bin.14 3731 10 EHA01845_bin.103 3752 # ℹ 84 more rows 9.1.0.1 Predicted genes pred_genes &lt;- genome_annotations %&gt;% nrow() cat(pred_genes) 374136 9.1.0.2 Number of annotated genes and percentages #How many genes have at least 1 annotation genome_annota &lt;- genome_annotations %&gt;% filter(if_any(c(kegg, pfam, cazy), ~ !is.na(.))) %&gt;% nrow() cat(genome_annota) 313671 #Percentage of predicted genes with at least 1 annotation genome_annota*100/pred_genes [1] 83.83876 9.1.0.3 Number of KEGG annotatated genes and percentages # KEGG annotation kegg_annota &lt;- genome_annotations %&gt;% filter(!is.na(kegg)) %&gt;% nrow() cat(kegg_annota) 245140 # KEGG annotation percentage kegg_annota*100/genome_annota [1] 78.15195 n_pred_genes &lt;- genome_annotations %&gt;% group_by(mag_id) %&gt;% summarize(n_genes = n()) %&gt;% left_join( genome_metadata %&gt;% dplyr::select(ID, source), by = c(&quot;mag_id&quot; = &quot;ID&quot;) ) annotated_genes &lt;- genome_annotations %&gt;% filter(if_any(c(kegg, pfam, cazy), ~ !is.na(.))) %&gt;% group_by(mag_id) %&gt;% summarize(n_annotated_genes = n()) %&gt;% left_join( genome_metadata %&gt;% dplyr::select(ID, source), by = c(&quot;mag_id&quot; = &quot;ID&quot;) ) ggplot(n_pred_genes, aes(x= source, y = n_genes, fill = source))+ scale_fill_manual(values = source_colors)+ geom_boxplot()+ geom_point()+ theme_classic()+ labs(y = &quot;Gene Number&quot;, x = &quot;Source&quot;) ggplot(annotated_genes, aes(x= source, y = n_annotated_genes, fill = source))+ scale_fill_manual(values = source_colors)+ geom_boxplot()+ geom_point()+ theme_classic()+ labs(y = &quot;Annotated Gene Number&quot;, x = &quot;Source&quot;) wilcox.test(n_genes ~ source, data=n_pred_genes) %&gt;% tidy() # A tibble: 1 × 4 statistic p.value method alternative &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 1 418. 0.000148 Wilcoxon rank sum test with continuity correction two.sided wilcox.test(n_annotated_genes ~ source, data=annotated_genes) %&gt;% tidy() # A tibble: 1 × 4 statistic p.value method alternative &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 1 376. 0.0000314 Wilcoxon rank sum test with continuity correction two.sided 9.2 KEGG 9.2.1 Nº of MAGs with KOs #Proportion of MAGs belonging to each group per KEGG #I want to know for example 5% of MAGs in the EHI group have this KEGG, but 40 % of MAGs in the GTDB group have it # KEGG presence/absence kegg_presence &lt;- genome_annotations %&gt;% filter(mag_id != &quot;GCA_015060925.1&quot;) %&gt;% # remove weird MAG filter(!is.na(kegg)) %&gt;% dplyr::select(mag_id, kegg) %&gt;% distinct() #Add the source info kegg_with_source &lt;- kegg_presence %&gt;% left_join( genome_metadata %&gt;% dplyr::select(ID, source), by = c(&quot;mag_id&quot; = &quot;ID&quot;) ) # Count how many MAGs in each KEGG kegg_mag_counts &lt;- kegg_with_source %&gt;% group_by(source, kegg) %&gt;% summarise( n_mags = n(), .groups = &quot;drop&quot; ) #Count total MAGs per source (except the outlier) total_mags_per_source &lt;- genome_metadata %&gt;% filter(ID != &quot;GCA_015060925.1&quot;) %&gt;% group_by(source) %&gt;% summarise( total_mags = n_distinct(ID), .groups = &quot;drop&quot; ) #Calculate proportions of MAGs from each source in each KEGG kegg_mag_proportions &lt;- kegg_mag_counts %&gt;% left_join(total_mags_per_source, by = &quot;source&quot;) %&gt;% mutate( proportion = n_mags / total_mags, absent = total_mags - n_mags ) 9.2.1.1 Plotting KEGG MAG proportions kegg_mag_proportions %&gt;% filter(n_mags &gt;= 20) # A tibble: 3,068 × 6 source kegg n_mags total_mags proportion absent &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;int&gt; 1 EHI K00010 25 25 1 0 2 EHI K00012 24 25 0.96 1 3 EHI K00013 25 25 1 0 4 EHI K00014 22 25 0.88 3 5 EHI K00015 24 25 0.96 1 6 EHI K00018 22 25 0.88 3 7 EHI K00024 25 25 1 0 8 EHI K00027 23 25 0.92 2 9 EHI K00030 24 25 0.96 1 10 EHI K00033 25 25 1 0 # ℹ 3,058 more rows ggplot(kegg_mag_proportions, aes(x = kegg, y = proportion, fill = source)) + geom_col(position = &quot;dodge&quot;) + scale_fill_manual(values = source_colors) + theme_minimal() + theme( axis.text.x = element_text(angle = 45, hjust = 1) ) + labs( x = &quot;KEGG ortholog&quot;, y = &quot;Proportion of MAGs&quot; ) 9.2.1.2 Statistical testing of MAG proportions fisher_results &lt;- kegg_mag_proportions %&gt;% dplyr::select(kegg, source, n_mags, absent) %&gt;% pivot_wider( names_from = source, values_from = c(n_mags, absent), values_fill = 0 ) %&gt;% rowwise() %&gt;% mutate( p_value = fisher.test( matrix( c(n_mags_EHI, absent_EHI, n_mags_GTDB, absent_GTDB), nrow = 2, byrow = TRUE ) )$p.value ) %&gt;% ungroup() %&gt;% mutate(p_adj = p.adjust(p_value, method = &quot;BH&quot;)) fisher_results &lt;- fisher_results %&gt;% mutate( prop_EHI = n_mags_EHI / (n_mags_EHI + absent_EHI), prop_GTDB = n_mags_GTDB / (n_mags_GTDB + absent_GTDB), diff_prop = prop_GTDB - prop_EHI ) sig_fisher_results &lt;- fisher_results%&gt;% filter(p_adj &lt; 0.05) sig_fisher_results # A tibble: 4 × 10 kegg n_mags_EHI n_mags_GTDB absent_EHI absent_GTDB p_value p_adj prop_EHI prop_GTDB diff_prop &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; 1 K03205 3 40 22 28 0.0000486 0.0281 0.12 0.588 0.468 2 K06926 2 38 23 30 0.0000318 0.0245 0.08 0.559 0.479 3 K13525 14 68 11 0 0.0000000731 0.000169 0.56 1 0.44 4 K20331 13 64 12 4 0.0000118 0.0137 0.52 0.941 0.421 library(KEGGREST) # Function to get info from KEGG get_kegg_info &lt;- function(ko_id) { query &lt;- keggGet(ko_id)[[1]] # Extract Name and Definition name &lt;- ifelse(!is.null(query$NAME), query$NAME, &quot;N/A&quot;) definition &lt;- ifelse(!is.null(query$DEFINITION), query$DEFINITION, &quot;N/A&quot;) # Extract Pathways (often multiple) pathways &lt;- if(!is.null(query$PATHWAY)) { paste(names(query$PATHWAY), query$PATHWAY, sep = &quot;: &quot;, collapse = &quot;; &quot;) } else { &quot;No pathway assigned&quot; } return(c(KO = ko_id, Name = name, Definition = definition, Pathways = pathways)) } signigicant_kos &lt;- fisher_results%&gt;% filter(p_adj &lt; 0.05) %&gt;% pull(kegg) ko_list &lt;- lapply(signigicant_kos, get_kegg_info) ko_summary &lt;- as.data.frame(do.call(rbind, ko_list)) print(ko_summary) KO Name Definition 1 K03205 type IV secretion system protein VirD4 [EC:7.4.2.8] N/A 2 K06926 uncharacterized protein N/A 3 K13525 transitional endoplasmic reticulum ATPase N/A 4 K20331 toxoflavin synthase [EC:2.1.1.349] N/A Pathways 1 map03070: Bacterial secretion system 2 No pathway assigned 3 map04137: Mitophagy - animal; map04141: Protein processing in endoplasmic reticulum; map05014: Amyotrophic lateral sclerosis; map05022: Pathways of neurodegeneration - multiple diseases; map05134: Legionellosis 4 map02024: Quorum sensing heatmap_data &lt;- sig_fisher_results %&gt;% dplyr::select(kegg, prop_EHI, prop_GTDB)%&gt;% pivot_longer(!kegg, names_to = &quot;source&quot;, values_to= &quot;proportion&quot; ) %&gt;% mutate( source = case_when( source == &quot;prop_EHI&quot; ~ &quot;EHI&quot;, source == &quot;prop_GTDB&quot; ~ &quot;GTDB&quot;, TRUE ~ source ) ) ggplot(heatmap_data, aes(x = source, y = kegg, fill = proportion)) + geom_tile() + scale_fill_viridis_c( name = &quot;Proportion of MAGs&quot;, limits = c(0, 1) ) + theme_minimal() + labs( x = &quot;Source&quot;, y = &quot;KEGG ortholog&quot;, title = &quot;Differential KEGG presence between EHI and GTDB&quot; ) 9.2.2 Functional Ordination PCA of KEGG annotations: kegg_counts &lt;- genome_annotations %&gt;% filter(mag_id != &quot;GCA_015060925.1&quot;)%&gt;% #this is the smaller mag that&#39;s weird filter(!is.na(kegg)) %&gt;% dplyr::count(mag_id, kegg) %&gt;% pivot_wider( names_from = kegg, values_from = n, values_fill = 0 ) # Normalization kegg_rel &lt;- kegg_counts %&gt;% column_to_rownames(&quot;mag_id&quot;) kegg_rel &lt;- kegg_rel / rowSums(kegg_rel) # Each row sums to 1 # Remove zero variance kegg_rel_nz &lt;- kegg_rel[, apply(kegg_rel, 2, sd) &gt; 0] # PCA with scaling pca &lt;- prcomp(kegg_rel_nz, scale. = TRUE) # Check variance explained summary(pca)$importance[,1:5] PC1 PC2 PC3 PC4 PC5 Standard deviation 17.94329 9.61480 8.85902 8.735097 8.450299 Proportion of Variance 0.13926 0.03998 0.03395 0.033000 0.030890 Cumulative Proportion 0.13926 0.17924 0.21319 0.246190 0.277080 scores &lt;- as.data.frame(pca$x) scores$ID &lt;- rownames(scores) scores &lt;- scores %&gt;% left_join(genome_metadata, by = &quot;ID&quot;) ggplot(scores, aes(PC1, PC2, color = source)) + geom_point(size = 2) + scale_color_manual(values = source_colors)+ theme_minimal() + labs( title = &quot;PCA of KEGG annotations across MAGs&quot;, x = paste0(&quot;PC1 (&quot;, round(summary(pca)$importance[2,1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(summary(pca)$importance[2,2] * 100, 1), &quot;%)&quot;) ) ggplot(scores, aes(PC2, PC3, color = source)) + scale_color_manual(values = source_colors)+ geom_point(size = 2) + theme_minimal() + labs( title = &quot;P2 vs PC3 of KEGG annotations across MAGs&quot;, x = paste0(&quot;PC2 (&quot;, round(summary(pca)$importance[2,2] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC3 (&quot;, round(summary(pca)$importance[2,3] * 100, 1), &quot;%)&quot;) ) ggplot(scores, aes(PC3, PC4, color = source)) + scale_color_manual(values = source_colors)+ geom_point(size = 2) + theme_minimal() + labs( title = &quot;P3 vs PC4 of KEGG annotations across MAGs&quot;, x = paste0(&quot;PC3 (&quot;, round(summary(pca)$importance[2,3] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC4 (&quot;, round(summary(pca)$importance[2,4] * 100, 1), &quot;%)&quot;) ) ggplot(scores, aes(PC1, PC2, color = genome_size)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;KEGG PCA colored by genome size&quot;, x = paste0(&quot;PC1 (&quot;, round(summary(pca)$importance[2,1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(summary(pca)$importance[2,2] * 100, 1), &quot;%)&quot;) ) ggplot(scores, aes(PC1, PC2, color = completeness)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;KEGG PCA colored by completeness&quot;, x = paste0(&quot;PC1 (&quot;, round(summary(pca)$importance[2,1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(summary(pca)$importance[2,2] * 100, 1), &quot;%)&quot;) ) ggplot(scores, aes(PC1, PC2, color = host_species)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;KEGG PCA colored by host species &quot;, x = paste0(&quot;PC1 (&quot;, round(summary(pca)$importance[2,1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(summary(pca)$importance[2,2] * 100, 1), &quot;%)&quot;) ) ggplot(scores, aes(PC1, PC2, color = country)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;KEGG PCA colored by country &quot;, x = paste0(&quot;PC1 (&quot;, round(summary(pca)$importance[2,1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(summary(pca)$importance[2,2] * 100, 1), &quot;%)&quot;) ) ggplot(scores, aes(PC1, PC2, color = continent)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;KEGG PCA colored by continent&quot;, x = paste0(&quot;PC1 (&quot;, round(summary(pca)$importance[2,1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(summary(pca)$importance[2,2] * 100, 1), &quot;%)&quot;) ) loadings &lt;- pca$rotation abs_loadings &lt;- apply(abs(loadings[, 1:2]), 1, sum) top_combined &lt;- sort(abs_loadings, decreasing = TRUE)[1:10] top_combined K00428 K13663 K19783 K12035 K03310 K19234 K01442 K07012 K15971 K02574 0.09395610 0.09123926 0.08962148 0.08809128 0.08623159 0.08587434 0.08425436 0.08356048 0.08308556 0.08301173 library(KEGGREST) top_loadings &lt;- loadings %&gt;% as.data.frame() %&gt;% rownames_to_column(&quot;KEGG&quot;) %&gt;% arrange(desc(abs(PC1))) head(top_loadings) KEGG PC1 PC2 PC3 PC4 PC5 PC6 PC7 PC8 PC9 1 K00318 0.05474364 -0.009694579 -0.004520008 0.001965835 -0.0091653 0.006068488 0.005395356 -0.003637749 -0.001571744 2 K00603 0.05474364 -0.009694579 -0.004520008 0.001965835 -0.0091653 0.006068488 0.005395356 -0.003637749 -0.001571744 3 K00602 0.05474364 -0.009694579 -0.004520008 0.001965835 -0.0091653 0.006068488 0.005395356 -0.003637749 -0.001571744 4 K00241 0.05474364 -0.009694579 -0.004520008 0.001965835 -0.0091653 0.006068488 0.005395356 -0.003637749 -0.001571744 5 K00760 0.05474364 -0.009694579 -0.004520008 0.001965835 -0.0091653 0.006068488 0.005395356 -0.003637749 -0.001571744 6 K00761 0.05474364 -0.009694579 -0.004520008 0.001965835 -0.0091653 0.006068488 0.005395356 -0.003637749 -0.001571744 PC10 PC11 PC12 PC13 PC14 PC15 PC16 PC17 PC18 1 0.005902403 -0.004233131 -0.004894505 -0.003881218 0.001778101 0.004588241 0.004266847 0.004969778 -0.005891177 2 0.005902403 -0.004233131 -0.004894505 -0.003881218 0.001778101 0.004588241 0.004266847 0.004969778 -0.005891177 3 0.005902403 -0.004233131 -0.004894505 -0.003881218 0.001778101 0.004588241 0.004266847 0.004969778 -0.005891177 4 0.005902403 -0.004233131 -0.004894505 -0.003881218 0.001778101 0.004588241 0.004266847 0.004969778 -0.005891177 5 0.005902403 -0.004233131 -0.004894505 -0.003881218 0.001778101 0.004588241 0.004266847 0.004969778 -0.005891177 6 0.005902403 -0.004233131 -0.004894505 -0.003881218 0.001778101 0.004588241 0.004266847 0.004969778 -0.005891177 PC19 PC20 PC21 PC22 PC23 PC24 PC25 PC26 PC27 1 0.002499591 -0.002737706 -0.003074745 -0.0003239928 0.001770124 0.006645987 0.0004019688 -0.003059053 0.0006535857 2 0.002499591 -0.002737706 -0.003074745 -0.0003239928 0.001770124 0.006645987 0.0004019688 -0.003059053 0.0006535857 3 0.002499591 -0.002737706 -0.003074745 -0.0003239928 0.001770124 0.006645987 0.0004019688 -0.003059053 0.0006535857 4 0.002499591 -0.002737706 -0.003074745 -0.0003239928 0.001770124 0.006645987 0.0004019688 -0.003059053 0.0006535857 5 0.002499591 -0.002737706 -0.003074745 -0.0003239928 0.001770124 0.006645987 0.0004019688 -0.003059053 0.0006535857 6 0.002499591 -0.002737706 -0.003074745 -0.0003239928 0.001770124 0.006645987 0.0004019688 -0.003059053 0.0006535857 PC28 PC29 PC30 PC31 PC32 PC33 PC34 PC35 PC36 1 -0.0005719754 0.001903491 0.0001743872 -0.001443894 -0.0002852472 -0.00147588 -0.002148302 -0.0004669545 -0.001198529 2 -0.0005719754 0.001903491 0.0001743872 -0.001443894 -0.0002852472 -0.00147588 -0.002148302 -0.0004669545 -0.001198529 3 -0.0005719754 0.001903491 0.0001743872 -0.001443894 -0.0002852472 -0.00147588 -0.002148302 -0.0004669545 -0.001198529 4 -0.0005719754 0.001903491 0.0001743872 -0.001443894 -0.0002852472 -0.00147588 -0.002148302 -0.0004669545 -0.001198529 5 -0.0005719754 0.001903491 0.0001743872 -0.001443894 -0.0002852472 -0.00147588 -0.002148302 -0.0004669545 -0.001198529 6 -0.0005719754 0.001903491 0.0001743872 -0.001443894 -0.0002852472 -0.00147588 -0.002148302 -0.0004669545 -0.001198529 PC37 PC38 PC39 PC40 PC41 PC42 PC43 PC44 PC45 1 -0.002202629 0.001641412 0.001385291 -0.0006346985 -0.0006805273 0.0007669444 -0.003660098 -0.0004472639 -0.0006396953 2 -0.002202629 0.001641412 0.001385291 -0.0006346985 -0.0006805273 0.0007669444 -0.003660098 -0.0004472639 -0.0006396953 3 -0.002202629 0.001641412 0.001385291 -0.0006346985 -0.0006805273 0.0007669444 -0.003660098 -0.0004472639 -0.0006396953 4 -0.002202629 0.001641412 0.001385291 -0.0006346985 -0.0006805273 0.0007669444 -0.003660098 -0.0004472639 -0.0006396953 5 -0.002202629 0.001641412 0.001385291 -0.0006346985 -0.0006805273 0.0007669444 -0.003660098 -0.0004472639 -0.0006396953 6 -0.002202629 0.001641412 0.001385291 -0.0006346985 -0.0006805273 0.0007669444 -0.003660098 -0.0004472639 -0.0006396953 PC46 PC47 PC48 PC49 PC50 PC51 PC52 PC53 PC54 1 -0.0002316659 -0.001496334 -0.001678697 0.001604079 -5.506554e-05 -0.002389476 0.001461016 -0.0009120602 -0.0009106807 2 -0.0002316659 -0.001496334 -0.001678697 0.001604079 -5.506554e-05 -0.002389476 0.001461016 -0.0009120602 -0.0009106807 3 -0.0002316659 -0.001496334 -0.001678697 0.001604079 -5.506554e-05 -0.002389476 0.001461016 -0.0009120602 -0.0009106807 4 -0.0002316659 -0.001496334 -0.001678697 0.001604079 -5.506554e-05 -0.002389476 0.001461016 -0.0009120602 -0.0009106807 5 -0.0002316659 -0.001496334 -0.001678697 0.001604079 -5.506554e-05 -0.002389476 0.001461016 -0.0009120602 -0.0009106807 6 -0.0002316659 -0.001496334 -0.001678697 0.001604079 -5.506554e-05 -0.002389476 0.001461016 -0.0009120602 -0.0009106807 PC55 PC56 PC57 PC58 PC59 PC60 PC61 PC62 PC63 1 -0.00153743 0.0007363891 0.001999625 0.002177865 -0.002292433 0.003403386 -0.001181503 5.05191e-05 0.00147613 2 -0.00153743 0.0007363891 0.001999625 0.002177865 -0.002292433 0.003403386 -0.001181503 5.05191e-05 0.00147613 3 -0.00153743 0.0007363891 0.001999625 0.002177865 -0.002292433 0.003403386 -0.001181503 5.05191e-05 0.00147613 4 -0.00153743 0.0007363891 0.001999625 0.002177865 -0.002292433 0.003403386 -0.001181503 5.05191e-05 0.00147613 5 -0.00153743 0.0007363891 0.001999625 0.002177865 -0.002292433 0.003403386 -0.001181503 5.05191e-05 0.00147613 6 -0.00153743 0.0007363891 0.001999625 0.002177865 -0.002292433 0.003403386 -0.001181503 5.05191e-05 0.00147613 PC64 PC65 PC66 PC67 PC68 PC69 PC70 PC71 PC72 1 -0.0008828989 0.0004442235 0.003283536 0.0001249199 -0.0004132665 0.002572613 0.001327565 0.001791235 0.0003839878 2 -0.0008828989 0.0004442235 0.003283536 0.0001249199 -0.0004132665 0.002572613 0.001327565 0.001791235 0.0003839878 3 -0.0008828989 0.0004442235 0.003283536 0.0001249199 -0.0004132665 0.002572613 0.001327565 0.001791235 0.0003839878 4 -0.0008828989 0.0004442235 0.003283536 0.0001249199 -0.0004132665 0.002572613 0.001327565 0.001791235 0.0003839878 5 -0.0008828989 0.0004442235 0.003283536 0.0001249199 -0.0004132665 0.002572613 0.001327565 0.001791235 0.0003839878 6 -0.0008828989 0.0004442235 0.003283536 0.0001249199 -0.0004132665 0.002572613 0.001327565 0.001791235 0.0003839878 PC73 PC74 PC75 PC76 PC77 PC78 PC79 PC80 PC81 1 -0.001050797 0.0008920328 0.0009844757 -0.00161418 -0.001416298 -0.00276859 0.001776861 -0.0002906129 0.002162745 2 -0.001050797 0.0008920328 0.0009844757 -0.00161418 -0.001416298 -0.00276859 0.001776861 -0.0002906129 0.002162745 3 -0.001050797 0.0008920328 0.0009844757 -0.00161418 -0.001416298 -0.00276859 0.001776861 -0.0002906129 0.002162745 4 -0.001050797 0.0008920328 0.0009844757 -0.00161418 -0.001416298 -0.00276859 0.001776861 -0.0002906129 0.002162745 5 -0.001050797 0.0008920328 0.0009844757 -0.00161418 -0.001416298 -0.00276859 0.001776861 -0.0002906129 0.002162745 6 -0.001050797 0.0008920328 0.0009844757 -0.00161418 -0.001416298 -0.00276859 0.001776861 -0.0002906129 0.002162745 PC82 PC83 PC84 PC85 PC86 PC87 PC88 PC89 PC90 1 0.001960269 -0.0005624031 -0.0003303478 0.001465212 0.001264419 0.0008391462 -0.0004377041 0.001767447 8.081168e-05 2 0.001960269 -0.0005624031 -0.0003303478 0.001465212 0.001264419 0.0008391462 -0.0004377041 0.001767447 8.081168e-05 3 0.001960269 -0.0005624031 -0.0003303478 0.001465212 0.001264419 0.0008391462 -0.0004377041 0.001767447 8.081168e-05 4 0.001960269 -0.0005624031 -0.0003303478 0.001465212 0.001264419 0.0008391462 -0.0004377041 0.001767447 8.081168e-05 5 0.001960269 -0.0005624031 -0.0003303478 0.001465212 0.001264419 0.0008391462 -0.0004377041 0.001767447 8.081168e-05 6 0.001960269 -0.0005624031 -0.0003303478 0.001465212 0.001264419 0.0008391462 -0.0004377041 0.001767447 8.081168e-05 PC91 PC92 PC93 1 -0.003479609 0.0005672297 -0.060196326 2 -0.003479609 0.0005672297 -0.028827514 3 -0.003479609 0.0005672297 -0.015508586 4 -0.003479609 0.0005672297 -0.007955012 5 -0.003479609 0.0005672297 0.005988844 6 -0.003479609 0.0005672297 0.005988844 top_kos &lt;- head(top_loadings)%&gt;%pull(KEGG) ko_pathways &lt;- lapply(top_kos, function(k) { info &lt;- keggGet(paste0(&quot;ko:&quot;, k))[[1]] pathways &lt;- info$PATHWAY if(is.null(pathways)) pathways &lt;- NA return(pathways) }) names(ko_pathways) &lt;- top_kos ko_pathways $K00318 map00330 map01100 map01110 &quot;Arginine and proline metabolism&quot; &quot;Metabolic pathways&quot; &quot;Biosynthesis of secondary metabolites&quot; $K00603 map00340 map00670 map01100 &quot;Histidine metabolism&quot; &quot;One carbon pool by folate&quot; &quot;Metabolic pathways&quot; $K00602 map00230 map00670 map01100 &quot;Purine metabolism&quot; &quot;One carbon pool by folate&quot; &quot;Metabolic pathways&quot; map01110 map01523 &quot;Biosynthesis of secondary metabolites&quot; &quot;Antifolate resistance&quot; $K00241 map00020 map00190 &quot;Citrate cycle (TCA cycle)&quot; &quot;Oxidative phosphorylation&quot; map00650 map00720 &quot;Butanoate metabolism&quot; &quot;Other carbon fixation pathways&quot; map01100 map01110 &quot;Metabolic pathways&quot; &quot;Biosynthesis of secondary metabolites&quot; map01120 map01200 &quot;Microbial metabolism in diverse environments&quot; &quot;Carbon metabolism&quot; $K00760 map00230 map00983 map01100 &quot;Purine metabolism&quot; &quot;Drug metabolism - other enzymes&quot; &quot;Metabolic pathways&quot; map01110 map01232 &quot;Biosynthesis of secondary metabolites&quot; &quot;Nucleotide metabolism&quot; $K00761 map00240 map01100 map01232 &quot;Pyrimidine metabolism&quot; &quot;Metabolic pathways&quot; &quot;Nucleotide metabolism&quot; 9.2.3 KEGG heatmap # Relative abundance heatmap pheatmap(kegg_rel_nz, color = viridis(100, option = &quot;viridis&quot;), cluster_rows = TRUE, cluster_cols = TRUE, fontsize = 9, border_color = NA ) # For scaled heatmap -&gt; remove zero variance columns col_vars &lt;- apply(kegg_rel_nz, 2, var, na.rm = TRUE) matrix_filtered &lt;- kegg_rel_nz[, col_vars &gt; 0 &amp; !is.na(col_vars)] # Scale the filtered matrix scaled &lt;- scale(matrix_filtered, center = TRUE, scale = TRUE) # Check for any remaining Inf/NaN values if(any(!is.finite(scaled))) { scaled[!is.finite(scaled)] &lt;- 0 # Replace Inf/NaN with 0 } # Scaled heatmap pheatmap(scaled, color = viridis(100, option = &quot;viridis&quot;), cluster_rows = TRUE, cluster_cols = TRUE, fontsize = 5, border_color = NA ) 9.2.4 Testing the differences in KEGG annotations with PERMANOVA # Distance matrix from normalized data kegg_dist &lt;- vegdist(kegg_rel_nz, method = &quot;bray&quot;) # Add metadata kegg_rel_nz_meta &lt;- kegg_rel_nz %&gt;% rownames_to_column(&quot;ID&quot;) %&gt;% left_join(genome_metadata, by = &quot;ID&quot;) #Beta dispersion test dispersion &lt;- betadisper(kegg_dist, kegg_rel_nz_meta$source) anova(dispersion) Analysis of Variance Table Response: Distances Df Sum Sq Mean Sq F value Pr(&gt;F) Groups 1 0.005554 0.0055536 9.9304 0.002201 ** Residuals 91 0.050891 0.0005592 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # PERMANOVA test permanova_result &lt;- adonis2(kegg_dist ~ genome_size + source, data = kegg_rel_nz_meta, permutations = 999) print(permanova_result) Permutation test for adonis under reduced model Permutation: free Number of permutations: 999 adonis2(formula = kegg_dist ~ genome_size + source, data = kegg_rel_nz_meta, permutations = 999) Df SumOfSqs R2 F Pr(&gt;F) Model 2 0.20587 0.2843 17.876 0.001 *** Residual 90 0.51825 0.7157 Total 92 0.72412 1.0000 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 adonis2( kegg_dist ~ genome_size + source, data = kegg_rel_nz_meta, permutations = 999, by = &quot;margin&quot; ) Permutation test for adonis under reduced model Marginal effects of terms Permutation: free Number of permutations: 999 adonis2(formula = kegg_dist ~ genome_size + source, data = kegg_rel_nz_meta, permutations = 999, by = &quot;margin&quot;) Df SumOfSqs R2 F Pr(&gt;F) genome_size 1 0.14688 0.20284 25.5069 0.001 *** source 1 0.01024 0.01415 1.7789 0.066 . Residual 90 0.51825 0.71570 Total 92 0.72412 1.00000 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 kegg_counts_mat &lt;- kegg_counts %&gt;% column_to_rownames(&quot;mag_id&quot;) kegg_pa &lt;- (kegg_counts_mat &gt; 0) * 1 # remove zero-variance KOs kegg_pa_nz &lt;- kegg_pa[, colSums(kegg_pa) &gt; 0 &amp; colSums(kegg_pa) &lt; nrow(kegg_pa)] meta &lt;- genome_metadata %&gt;% filter(ID %in% rownames(kegg_pa_nz)) %&gt;% column_to_rownames(&quot;ID&quot;) # VERY IMPORTANT: enforce same order meta &lt;- meta[rownames(kegg_pa_nz), ] stopifnot(identical(rownames(meta), rownames(kegg_pa_nz))) kegg_dist_pa &lt;- vegdist(kegg_pa_nz, method = &quot;jaccard&quot;, binary = TRUE) # dispersion check disp_pa &lt;- betadisper(kegg_dist_pa, meta$source) anova(disp_pa) Analysis of Variance Table Response: Distances Df Sum Sq Mean Sq F value Pr(&gt;F) Groups 1 0.027469 0.0274695 17.117 7.827e-05 *** Residuals 91 0.146036 0.0016048 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # PERMANOVA adonis2( kegg_dist_pa ~ genome_size +completeness+ source, data = meta, permutations = 999 ) Permutation test for adonis under reduced model Permutation: free Number of permutations: 999 adonis2(formula = kegg_dist_pa ~ genome_size + completeness + source, data = meta, permutations = 999) Df SumOfSqs R2 F Pr(&gt;F) Model 3 0.24057 0.12036 4.0593 0.001 *** Residual 89 1.75813 0.87964 Total 92 1.99870 1.00000 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 pcoa_pa &lt;- cmdscale(kegg_dist_pa, eig = TRUE, k = 2) pcoa_df &lt;- data.frame( ID = rownames(kegg_pa_nz), PC1 = pcoa_pa$points[,1], PC2 = pcoa_pa$points[,2], source = meta$source ) %&gt;% left_join(genome_metadata, by = &quot;ID&quot;) ggplot(pcoa_df, aes(PC1, PC2, color = source.x)) + geom_point(size = 3, alpha = 0.8) + theme_classic() ggplot(pcoa_df, aes(PC1, PC2, color = completeness)) + geom_point(size = 3, alpha = 0.8) + theme_classic() ggplot(pcoa_df, aes(PC1, PC2, color = continent)) + geom_point(size = 3, alpha = 0.8) + theme_classic() 9.2.5 Principal Coordinate Analysis - KEGG pcoa_res &lt;- cmdscale(kegg_dist, k = 2, eig = TRUE) # Calculate variance explained variance_explained &lt;- pcoa_res$eig / sum(pcoa_res$eig) pcoa_df &lt;- data.frame( PC1 = pcoa_res$points[,1], PC2 = pcoa_res$points[,2], ID = rownames(kegg_rel_nz) ) %&gt;% left_join(genome_metadata, by = &quot;ID&quot;) ggplot(pcoa_df, aes(PC1, PC2, color = source)) + scale_color_manual(values = source_colors)+ geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of KEGG annotations across MAGs&quot;, x = paste0(&quot;PC1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = genome_size)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of KEGG annotations across MAGs&quot;, x = paste0(&quot;PC1 (&quot;,round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = host_species)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of KEGG annotations across MAGs (colored by host species)&quot;, x = paste0(&quot;PC1 (&quot;,round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = country)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of KEGG annotations across MAGs (colored by country)&quot;, x = paste0(&quot;PC1 (&quot;,round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = continent)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of KEGG annotations across MAGs (colored by continent)&quot;, x = paste0(&quot;PC1 (&quot;,round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PC2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) 9.2.6 Differential abundance Differential expression analysis- trying to find which KEGG orthologs are significantly different between EHI vs GTDB DESeq2 library(DESeq2) # Prepare the count matrix (KOs as rows, MAGs as columns) # Ensure only integer columns are kept counts_mtx &lt;- kegg_counts %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% t() # Prepare metadata (Must match column names of counts_mtx) metadata &lt;- genome_metadata %&gt;% filter(ID %in% colnames(counts_mtx)) %&gt;% column_to_rownames(&quot;ID&quot;) # Ensure order matches exactly metadata &lt;- metadata[colnames(counts_mtx), , drop = FALSE] #Create DESeq2 object dds &lt;- DESeqDataSetFromMatrix(countData = counts_mtx, colData = metadata, design = ~ source) Warning in DESeqDataSet(se, design = design, ignoreRank): some variables in design formula are characters, converting to factors # Run the differential analysis dds &lt;- DESeq(dds) estimating size factors estimating dispersions gene-wise dispersion estimates mean-dispersion relationship -- note: fitType=&#39;parametric&#39;, but the dispersion trend was not well captured by the function: y = a/x + b, and a local regression fit was automatically substituted. specify fitType=&#39;local&#39; or &#39;mean&#39; to avoid this message next time. final dispersion estimates fitting model and testing # save results (Wildlife vs Human) res &lt;- results(dds, contrast=c(&quot;source&quot;, &quot;EHI&quot;, &quot;GTDB&quot;), alpha=0.05) summary(res) out of 2312 with nonzero total read count adjusted p-value &lt; 0.05 LFC &gt; 0 (up) : 0, 0% LFC &lt; 0 (down) : 10, 0.43% outliers [1] : 0, 0% low counts [2] : 82, 3.5% (mean count &lt; 0) [1] see &#39;cooksCutoff&#39; argument of ?results [2] see &#39;independentFiltering&#39; argument of ?results res_df &lt;-res %&gt;% as.data.frame %&gt;% rownames_to_column(&quot;KO&quot;) %&gt;% as_tibble ggplot(res_df,aes(x=baseMean, y=log2FoldChange)) + geom_point(alpha=0.8) + geom_smooth() + scale_x_log10() + geom_hline(yintercept = 0, alpha = 0.75, color=&quot;red&quot;)+ theme_bw()+ coord_cartesian(ylim=c(-10, 10)) `geom_smooth()` using method = &#39;gam&#39; and formula = &#39;y ~ s(x, bs = &quot;cs&quot;)&#39; res_df_2&lt;- res_df%&gt;% mutate(label2= ifelse (abs(log2FoldChange) &gt; 0.58 ,KO, &quot;&quot;)) ggplot(res_df_2, aes(x=baseMean, y=log2FoldChange, col=padj&lt;0.05, label=label2)) + geom_point(alpha=0.5) + scale_x_log10() + geom_hline(yintercept = 0, alpha = 0.75, color=&quot;red&quot;)+ geom_text_repel()+ theme_bw()+ coord_cartesian(ylim=c(-10, 10)) Warning: ggrepel: 113 unlabeled data points (too many overlaps). Consider increasing max.overlaps ggplot(res_df_2, aes(x=log2FoldChange, y=-log10(pvalue), color=padj &lt; 0.05, label=label2)) + geom_point(alpha=0.5) + geom_vline(xintercept = 1, alpha = 0.75, linetype=&quot;dashed&quot;)+ geom_vline(xintercept = -1, alpha = 0.75, linetype=&quot;dashed&quot;)+ geom_text_repel() + theme_bw() Warning: ggrepel: 89 unlabeled data points (too many overlaps). Consider increasing max.overlaps 9.2.7 Wilcoxon #Transform to long format and run test for every KO wilcox_results &lt;- kegg_rel_nz_meta %&gt;% pivot_longer(cols = starts_with(&quot;K&quot;), names_to = &quot;KO&quot;, values_to = &quot;rel_abundance&quot;) %&gt;% group_by(KO) %&gt;% do(tidy(wilcox.test(rel_abundance ~ source, data = .))) %&gt;% ungroup() # Adjust p-values wilcox_results &lt;- wilcox_results %&gt;% mutate(p.adj = p.adjust(p.value, method = &quot;fdr&quot;)) %&gt;% filter(p.adj &lt; 0.05) %&gt;% arrange(p.adj) head(wilcox_results) # A tibble: 6 × 6 KO statistic p.value method alternative p.adj &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; 1 K08138 1483 0.0000000422 Wilcoxon rank sum test with continuity correction two.sided 0.0000976 2 K00013 1331 0.0000313 Wilcoxon rank sum test with continuity correction two.sided 0.000189 3 K00024 1339 0.0000230 Wilcoxon rank sum test with continuity correction two.sided 0.000189 4 K00033 1325 0.0000392 Wilcoxon rank sum test with continuity correction two.sided 0.000189 5 K00052 1329 0.0000337 Wilcoxon rank sum test with continuity correction two.sided 0.000189 6 K00053 1344. 0.0000186 Wilcoxon rank sum test with continuity correction two.sided 0.000189 res_df &lt;- as.data.frame(res) %&gt;% rownames_to_column(&quot;KO&quot;) %&gt;% filter(padj &lt; 0.05) %&gt;% arrange(padj) # Find KOs that are significant in BOTH tests common_KOs &lt;- intersect(res_df$KO, wilcox_results$KO) # Boxplot of the top hit top_ko &lt;- common_KOs[1] ggplot(kegg_rel_nz_meta, aes(x = source, y = .data[[top_ko]], fill = source)) + geom_boxplot(outlier.shape = NA) + geom_jitter(width = 0.2, alpha = 0.5) + theme_minimal() + labs(title = paste(&quot;Distribution of&quot;, top_ko), y = &quot;Relative Abundance&quot;) # Filter data to only include the common KOs plot_data &lt;- kegg_rel_nz_meta %&gt;% dplyr::select(ID, source, all_of(common_KOs)) %&gt;% pivot_longer(cols = all_of(common_KOs), names_to = &quot;KO&quot;, values_to = &quot;Relative_Abundance&quot;) ggplot(plot_data, aes(x = source, y = Relative_Abundance, fill = source)) + geom_boxplot(outlier.shape = NA) + geom_jitter(width = 0.2, alpha = 0.4, size = 1) + facet_wrap(~KO, scales = &quot;free_y&quot;, ncol = 5) + # &#39;free_y&#39; is important as abundance scales vary scale_fill_manual(values = source_colors) + theme_minimal() + theme(strip.text = element_text(face = &quot;bold&quot;), legend.position = &quot;bottom&quot;) + labs(title = &quot;Relative Abundance of Consensus Significant KOs&quot;, x = &quot;Host Source&quot;, y = &quot;Relative Abundance&quot;) Check alignment with DESeq: # Calculate medians for each group to see direction direction_check &lt;- kegg_rel_nz_meta %&gt;% dplyr::select(source, all_of(common_KOs)) %&gt;% pivot_longer(-source, names_to = &quot;KO&quot;, values_to = &quot;val&quot;) %&gt;% group_by(KO, source) %&gt;% summarize(median_val = median(val), .groups = &#39;drop&#39;) %&gt;% pivot_wider(names_from = source, values_from = median_val) %&gt;% mutate(Enriched_In = ifelse(GTDB &gt; EHI, &quot;GTDB&quot;, &quot;EHI&quot;)) # Merge with your DESeq2 results to see if they align final_comparison &lt;- res_df %&gt;% filter(KO %in% common_KOs) %&gt;% dplyr::select(KO, log2FoldChange, padj) %&gt;% left_join(direction_check, by = &quot;KO&quot;) print(final_comparison) KO log2FoldChange padj EHI GTDB Enriched_In 1 K00754 -0.7479886 7.909738e-05 0.0031446541 0.0056385200 GTDB 2 K12063 -2.8303552 2.317878e-04 0.0000000000 0.0007237285 GTDB 3 K03496 -1.5234980 8.727123e-04 0.0004004806 0.0007883328 GTDB 4 K04763 -0.5721473 8.727123e-04 0.0072086504 0.0113583996 GTDB 5 K03205 -2.7791700 8.727123e-04 0.0000000000 0.0003911803 GTDB 6 K02316 -0.8913735 1.094241e-02 0.0008285004 0.0015585457 GTDB 7 K01185 -2.0946452 4.321013e-02 0.0000000000 0.0003613384 GTDB 8 K16695 -0.8284503 4.811695e-02 0.0008009612 0.0014506351 GTDB 9 K14059 -1.0656248 4.916919e-02 0.0003895598 0.0010485845 GTDB 10 K00986 -1.7702579 4.916919e-02 0.0000000000 0.0003677157 GTDB target_kos &lt;- common_KOs ko_info_list &lt;- lapply(target_kos, get_kegg_info) ko_summary &lt;- as.data.frame(do.call(rbind, ko_info_list)) print(ko_summary) KO Name Definition Pathways 1 K00754 L-malate glycosyltransferase [EC:2.4.1.-] N/A No pathway assigned 2 K12063 conjugal transfer ATP-binding protein TraC N/A No pathway assigned 3 K03496 chromosome partitioning protein N/A No pathway assigned 4 K04763 integrase/recombinase XerD N/A No pathway assigned 5 K03205 type IV secretion system protein VirD4 [EC:7.4.2.8] N/A map03070: Bacterial secretion system 6 K02316 DNA primase [EC:2.7.7.101] N/A map03030: DNA replication 7 K01185 lysozyme [EC:3.2.1.17] N/A No pathway assigned 8 K16695 lipopolysaccharide exporter N/A No pathway assigned 9 K14059 integrase N/A No pathway assigned 10 K00986 RNA-directed DNA polymerase [EC:2.7.7.49] N/A No pathway assigned #Prepare the matrix (KOs as rows, MAGs as columns) heatmap_mat &lt;- kegg_rel_nz_meta %&gt;% column_to_rownames(&quot;ID&quot;) %&gt;% dplyr::select(all_of(common_KOs)) %&gt;% as.matrix() %&gt;% t() # Prepare the annotation data frame annotation_col &lt;- data.frame(Source = kegg_rel_nz_meta$source) rownames(annotation_col) &lt;- kegg_rel_nz_meta$ID # Check if they match all(colnames(heatmap_mat) == rownames(annotation_col)) [1] TRUE #colors ann_colors &lt;- list( Source = source_colors ) # Plot pheatmap(heatmap_mat, annotation_col = annotation_col, annotation_colors = ann_colors, scale = &quot;row&quot;, show_colnames = TRUE, cluster_cols = TRUE, main = &quot;Consensus KOs: Human vs Wildlife&quot;) #Prepare the matrix (KOs as rows, MAGs as columns) heatmap_mat &lt;- kegg_rel_nz_meta %&gt;% column_to_rownames(&quot;ID&quot;) %&gt;% dplyr::select(all_of(wilcox_results$KO)) %&gt;% as.matrix() %&gt;% t() # Prepare the annotation data frame annotation_col &lt;- data.frame(Source = kegg_rel_nz_meta$source) rownames(annotation_col) &lt;- kegg_rel_nz_meta$ID # Check if they match all(colnames(heatmap_mat) == rownames(annotation_col)) [1] TRUE #colors ann_colors &lt;- list( Source = source_colors ) # Plot pheatmap(heatmap_mat, annotation_col = annotation_col, annotation_colors = ann_colors, scale = &quot;row&quot;, show_colnames = TRUE, cluster_cols = TRUE, main = &quot;Consensus KOs: Human vs Wildlife&quot;) 9.2.8 ALDEX2 library(ALDEx2) kegg_raw_mat &lt;- kegg_counts %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% as.matrix() kegg_raw_mat[is.na(kegg_raw_mat)] &lt;- 0 conds &lt;- kegg_rel_nz_meta %&gt;% filter(ID %in% rownames(kegg_raw_mat)) %&gt;% arrange(match(ID, rownames(kegg_raw_mat))) %&gt;% pull(source) table(conds) conds EHI GTDB 25 68 aldex_clr &lt;- aldex.clr( reads = t(kegg_raw_mat), conds = conds, mc.samples = 128, # number of Monte Carlo instances denom = &quot;all&quot;, verbose = TRUE ) # Welch&#39;s t-test and Wilcoxon test aldex_test &lt;- aldex.ttest(aldex_clr) aldex_effect &lt;- aldex.effect(aldex_clr) # Combine results aldex_res &lt;- cbind(aldex_test, aldex_effect) sig_kegg &lt;- aldex_res %&gt;% as.data.frame() %&gt;% rownames_to_column(&quot;KEGG&quot;) %&gt;% filter(we.eBH &lt; 0.05) %&gt;% # FDR-corrected arrange(we.eBH) # Add direction of enrichment sig_kegg &lt;- sig_kegg %&gt;% mutate(enriched_in = ifelse(effect &gt; 0, &quot;GTDB&quot;, &quot;EHI&quot;)) sig_kegg [1] KEGG we.ep we.eBH wi.ep wi.eBH rab.all rab.win.EHI rab.win.GTDB diff.btw [10] diff.win effect overlap enriched_in &lt;0 rows&gt; (o 0- extensión row.names) No significant results… GENOME SIZE is significantly larger in GTDB MAGs –&gt; correct for genome size Which functions are enriched per unit genome by source? genome_sizes &lt;- genome_metadata %&gt;% dplyr::select(ID, genome_size) kegg_counts_gs &lt;- kegg_counts %&gt;% left_join(genome_sizes, by = c(&quot;mag_id&quot; = &quot;ID&quot;)) %&gt;% column_to_rownames(&quot;mag_id&quot;) # Divide by genome size (in Mb) kegg_per_mb &lt;- kegg_counts_gs[, -ncol(kegg_counts_gs)] / (kegg_counts_gs$genome_size / 1e6) kegg_mat &lt;- as.matrix(kegg_per_mb) # Replace any NA kegg_mat[is.na(kegg_mat)] &lt;- 0 #Filter rare keggs keep_kegg &lt;- colSums(kegg_mat &gt; 0) &gt;= 0.1 * nrow(kegg_mat) kegg_mat &lt;- kegg_mat[, keep_kegg] #add a pseudocount kegg_mat &lt;- kegg_mat + 1e-6 conds &lt;- kegg_rel_nz_meta %&gt;% filter(ID %in% rownames(kegg_mat)) %&gt;% arrange(match(ID, rownames(kegg_mat))) %&gt;% pull(source) table(conds) conds EHI GTDB 25 68 scale_factor &lt;- 1e4 kegg_pseudo &lt;- round(kegg_per_mb * scale_factor) # Replace zeros (ALDEx2 hates structural zeros) kegg_pseudo[kegg_pseudo == 0] &lt;- 1 aldex_clr &lt;- aldex.clr( reads = t(kegg_pseudo), conds = conds, mc.samples = 128, denom = &quot;all&quot;, verbose = TRUE ) aldex_test &lt;- aldex.ttest(aldex_clr) aldex_effect &lt;- aldex.effect(aldex_clr) aldex_res &lt;- cbind(aldex_test, aldex_effect) head(aldex_res) we.ep we.eBH wi.ep wi.eBH rab.all rab.win.EHI rab.win.GTDB diff.btw diff.win K00010 0.0001068262 0.002508831 2.622847e-05 0.0001482259 7.223538 7.495403 7.089908 -0.3935560 0.4612544 K00012 0.6462122342 1.000000000 7.395456e-01 0.9188178040 5.250534 5.181629 5.319965 -0.0567229 0.8828699 K00013 0.0003184541 0.002724410 2.339849e-05 0.0001493415 3.176761 3.484654 3.094023 -0.3596835 0.5186840 K00014 0.1788051439 1.000000000 7.880495e-03 0.0148669726 3.148881 3.416345 3.095650 -0.2572306 0.5801246 K00015 0.6935473516 0.997574603 2.282439e-04 0.0006127937 3.157886 3.438747 3.088475 -0.3197615 0.5284072 K00018 0.1819854892 1.000000000 1.144754e-02 0.0211146127 3.147514 3.388532 3.094652 -0.2411314 0.5841693 effect overlap K00010 -0.77281428 0.2079950 K00012 -0.02678337 0.4706250 K00013 -0.63202826 0.2023735 K00014 -0.16106899 0.3143750 K00015 -0.45441490 0.2573392 K00018 -0.11656309 0.3218750 sig_kegg &lt;- aldex_res %&gt;% as.data.frame() %&gt;% rownames_to_column(&quot;KEGG&quot;) %&gt;% filter( we.eBH &lt; 0.05, abs(effect) &gt; 1 ) %&gt;% arrange(desc(abs(effect))) sig_kegg KEGG we.ep we.eBH wi.ep wi.eBH rab.all rab.win.EHI rab.win.GTDB diff.btw diff.win 1 K08138 1.28284e-05 0.002508831 2.029733e-08 4.692743e-05 3.230578 4.112062 3.112651 -0.8714615 0.819527 effect overlap 1 -1.007419 0.1155528 library(compositions) clr_mat &lt;- clr(kegg_per_mb + 1e-6) res &lt;- apply(clr_mat, 2, function(x) { wilcox.test(x ~ conds)$p.value }) res_adj &lt;- p.adjust(res, method = &quot;BH&quot;) clr_res &lt;- data.frame( KEGG = names(res), p_value = res, p_adj = res_adj ) %&gt;% arrange(p_adj) head(clr_res) KEGG p_value p_adj K08138 K08138 2.581324e-08 5.968022e-05 K00010 K00010 2.051803e-05 1.062537e-04 K00013 K00013 2.394559e-05 1.062537e-04 K00024 K00024 2.216885e-05 1.062537e-04 K00033 K00033 2.899917e-05 1.062537e-04 K00052 K00052 2.394559e-05 1.062537e-04 sum(clr_res$p_adj &lt; 0.05) [1] 2011 res_lm &lt;- apply(clr_mat, 2, function(x) { model &lt;- lm(x ~ conds + kegg_counts_gs$genome_size) summary(model)$coefficients[&quot;condsGTDB&quot;,&quot;Pr(&gt;|t|)&quot;] }) res_lm_adj &lt;- p.adjust(res_lm, method = &quot;BH&quot;) sum(res_lm_adj &lt; 0.05) [1] 3 clr_res_lm &lt;- data.frame( KEGG = colnames(clr_mat), p_value = res_lm, p_adj = res_lm_adj ) sig_kegg &lt;- clr_res_lm %&gt;% filter(p_adj &lt; 0.05) %&gt;% arrange(p_adj) sig_kegg$effect &lt;- sapply(sig_kegg$KEGG, function(k) { median(clr_mat[, k][conds == &quot;GTDB&quot;]) - median(clr_mat[, k][conds == &quot;EHI&quot;]) }) sig_kegg &lt;- sig_kegg %&gt;% arrange(desc(abs(effect))) sig_kegg KEGG p_value p_adj effect K00856 K00856 1.904299e-05 1.467579e-02 -0.436244787 K13530 K13530 1.886011e-05 1.467579e-02 -0.436244787 K13525 K13525 3.445901e-09 7.966923e-06 0.008659409 9.3 GIFTs PCoA with Euclidean distances: # Convert the GIFTs into a matrix of functional elements per genome (row) gift_pcoa &lt;- genome_gifts %&gt;% to.elements(., GIFT_db) %&gt;% as.data.frame() %&gt;% vegdist(method=&quot;euclidean&quot;) %&gt;% pcoa() #principal component analysis #Extract eigenvalues (variance explained by first 10 axes) gift_pcoa_rel_eigen &lt;- gift_pcoa$values$Relative_eig[1:10] # Get genome positions gift_pcoa_vectors &lt;- gift_pcoa$vectors %&gt;% #extract vectors as.data.frame() %&gt;% dplyr::select(Axis.1,Axis.2) # keep the first 2 axes gift_pcoa_eigenvalues &lt;- gift_pcoa$values$Eigenvalues[c(1,2)] #For the black arrows: Functional group loadings # covariance between each functional trait and pcoa axis scores #scale with the eigenvectors gift_pcoa_gifts &lt;- cov(genome_gifts, scale(gift_pcoa_vectors)) %*% diag((gift_pcoa_eigenvalues/(nrow(genome_gifts)-1))^(-0.5)) %&gt;% as.data.frame() %&gt;% dplyr::rename(Axis.1=1,Axis.2=2) %&gt;% rownames_to_column(var=&quot;label&quot;) %&gt;% #get function summary vectors mutate(func=substr(label,1,3)) %&gt;% group_by(func) %&gt;% #grouping by function summarise(Axis.1=mean(Axis.1), Axis.2=mean(Axis.2)) %&gt;% dplyr::rename(label=func) %&gt;% filter(!label %in% c(&quot;S01&quot;,&quot;S02&quot;,&quot;S03&quot;)) set.seed(101) scale &lt;- 20 # scale for vector loadings (to make arrows visible) gift_pcoa_vectors %&gt;% rownames_to_column(var=&quot;ID&quot;) %&gt;% left_join(genome_metadata, by=&quot;ID&quot;) %&gt;% ggplot() + #genome positions scale_color_manual(values=source_colors)+ geom_point(aes(x=Axis.1,y=Axis.2, color = source), alpha=0.9, shape=16) + scale_size_continuous(range = c(0.1,5)) + #loading positions geom_segment(data=gift_pcoa_gifts, aes(x=0, y=0, xend=Axis.1 * scale, yend=Axis.2 * scale), arrow = arrow(length = unit(0.3, &quot;cm&quot;), type = &quot;open&quot;, angle = 25), linewidth = 0.5, color = &quot;black&quot;) + #Primary and secondary scale adjustments scale_x_continuous(name = paste0(&quot;PCoA1 (&quot;,round(gift_pcoa_rel_eigen[1]*100, digits = 2), &quot; %)&quot;), sec.axis = sec_axis(~ . / scale, name = &quot;Loadings on PCoA1&quot;) ) + scale_y_continuous(name = paste0(&quot;PCoA2 (&quot;,round(gift_pcoa_rel_eigen[2]*100, digits = 2), &quot; %)&quot;), sec.axis = sec_axis(~ . / scale, name = &quot;Loadings on PCoA2&quot;) ) + geom_label_repel(data = gift_pcoa_gifts, aes(label = label, x = Axis.1 * scale, y = Axis.2 * scale), segment.color = &#39;transparent&#39;) + xlim(-0.8,1) + ylim(-1,1.5) + theme_minimal() + labs( x = paste0(&quot;PCoA1 (&quot;, round(gift_pcoa_rel_eigen[1]*100, 2), &quot; %)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(gift_pcoa_rel_eigen[2]*100, 2), &quot; %)&quot;) ) Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_segment()`). Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_label_repel()`). Warning: ggrepel: 12 unlabeled data points (too many overlaps). Consider increasing max.overlaps gift_pcoa_vectors %&gt;% rownames_to_column(var=&quot;ID&quot;) %&gt;% left_join(genome_metadata, by=&quot;ID&quot;) %&gt;% ggplot() + #genome positions geom_point(aes(x=Axis.1,y=Axis.2, color = completeness), alpha=0.9, shape=16) + scale_size_continuous(range = c(0.1,5)) + #loading positions geom_segment(data=gift_pcoa_gifts, aes(x=0, y=0, xend=Axis.1 * scale, yend=Axis.2 * scale), arrow = arrow(length = unit(0.3, &quot;cm&quot;), type = &quot;open&quot;, angle = 25), linewidth = 0.5, color = &quot;black&quot;) + #Primary and secondary scale adjustments scale_x_continuous(name = paste0(&quot;PCoA1 (&quot;,round(gift_pcoa_rel_eigen[1]*100, digits = 2), &quot; %)&quot;), sec.axis = sec_axis(~ . / scale, name = &quot;Loadings on PCoA1&quot;) ) + scale_y_continuous(name = paste0(&quot;PCoA2 (&quot;,round(gift_pcoa_rel_eigen[2]*100, digits = 2), &quot; %)&quot;), sec.axis = sec_axis(~ . / scale, name = &quot;Loadings on PCoA2&quot;) ) + geom_label_repel(data = gift_pcoa_gifts, aes(label = label, x = Axis.1 * scale, y = Axis.2 * scale), segment.color = &#39;transparent&#39;) + xlim(-0.8,1) + ylim(-1,1.5) + theme_minimal() + labs( x = paste0(&quot;PCoA1 (&quot;, round(gift_pcoa_rel_eigen[1]*100, 2), &quot; %)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(gift_pcoa_rel_eigen[2]*100, 2), &quot; %)&quot;) ) Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_segment()`). Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_label_repel()`). Warning: ggrepel: 12 unlabeled data points (too many overlaps). Consider increasing max.overlaps gift_pcoa_vectors %&gt;% rownames_to_column(var=&quot;ID&quot;) %&gt;% left_join(genome_metadata, by=&quot;ID&quot;) %&gt;% ggplot() + #genome positions geom_point(aes(x=Axis.1,y=Axis.2, color = continent), alpha=0.9, shape=16) + scale_size_continuous(range = c(0.1,5)) + #loading positions geom_segment(data=gift_pcoa_gifts, aes(x=0, y=0, xend=Axis.1 * scale, yend=Axis.2 * scale), arrow = arrow(length = unit(0.3, &quot;cm&quot;), type = &quot;open&quot;, angle = 25), linewidth = 0.5, color = &quot;black&quot;) + #Primary and secondary scale adjustments scale_x_continuous(name = paste0(&quot;PCoA1 (&quot;,round(gift_pcoa_rel_eigen[1]*100, digits = 2), &quot; %)&quot;), sec.axis = sec_axis(~ . / scale, name = &quot;Loadings on PCoA1&quot;) ) + scale_y_continuous(name = paste0(&quot;PCoA2 (&quot;,round(gift_pcoa_rel_eigen[2]*100, digits = 2), &quot; %)&quot;), sec.axis = sec_axis(~ . / scale, name = &quot;Loadings on PCoA2&quot;) ) + geom_label_repel(data = gift_pcoa_gifts, aes(label = label, x = Axis.1 * scale, y = Axis.2 * scale), segment.color = &#39;transparent&#39;) + xlim(-0.8,1) + ylim(-1,1.5) + theme_minimal() + labs( x = paste0(&quot;PCoA1 (&quot;, round(gift_pcoa_rel_eigen[1]*100, 2), &quot; %)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(gift_pcoa_rel_eigen[2]*100, 2), &quot; %)&quot;) ) Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_segment()`). Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_label_repel()`). Warning: ggrepel: 12 unlabeled data points (too many overlaps). Consider increasing max.overlaps Using k-means to cluster the groups and check which MAGs cluster together: coords &lt;- gift_pcoa_vectors %&gt;% rownames_to_column(&quot;MAG&quot;) %&gt;% as_tibble() set.seed(123) km &lt;- kmeans(coords[, c(&quot;Axis.1&quot;, &quot;Axis.2&quot;)], centers = 4) coords &lt;- coords %&gt;% mutate(cluster = factor(km$cluster)) # centroids as a tibble for plotting centroids &lt;- as_tibble(km$centers) %&gt;% mutate(cluster = factor(1:nrow(km$centers))) ggplot(coords, aes(x = Axis.1, y = Axis.2, color = cluster)) + geom_point(size = 2, alpha = 0.8) + geom_point(data = centroids, aes(x = Axis.1, y = Axis.2, color = cluster), shape = 4, size = 5, stroke = 1.25) + # X marks centroids theme_minimal() + labs(title = paste0(&quot;PCoA colored by kmeans (k=4)&quot;), color = &quot;cluster&quot;) mags_by_cluster &lt;- split(coords$MAG, km$cluster) mags_by_cluster $`1` [1] &quot;EHM072417&quot; &quot;EHM029564&quot; &quot;GCF_019733675.1&quot; &quot;EHM049533&quot; &quot;GCF_018784125.1&quot; &quot;GCF_022835355.1&quot; [7] &quot;GCF_003475725.1&quot; &quot;EHM028668&quot; &quot;GCF_018587995.1&quot; &quot;GCA_959026225.1&quot; &quot;GCF_022835335.1&quot; &quot;EHM048790&quot; [13] &quot;EHM023781&quot; &quot;GCF_003464475.1&quot; &quot;GCF_018289335.1&quot; &quot;EHM016318&quot; &quot;GCF_003439415.1&quot; $`2` [1] &quot;GCA_022784765.1&quot; &quot;EHM049769&quot; &quot;GCF_003459965.1&quot; &quot;EHM069263&quot; &quot;EHM016228&quot; &quot;GCA_958416885.1&quot; [7] &quot;GCA_008680675.1&quot; &quot;GCA_958404515.1&quot; &quot;GCA_030843875.1&quot; &quot;EHM020917&quot; &quot;GCA_022776965.1&quot; &quot;GCA_959028115.1&quot; [13] &quot;GCA_009774835.1&quot; &quot;GCA_958413795.1&quot; &quot;GCA_959023275.1&quot; &quot;GCF_003474765.1&quot; &quot;GCF_029369685.1&quot; &quot;GCA_008679655.1&quot; $`3` [1] &quot;GCA_958435695.1&quot; &quot;EHM070114&quot; &quot;EHM049446&quot; &quot;GCF_001405935.1&quot; &quot;GCA_030844705.1&quot; &quot;EHM016582&quot; [7] &quot;GCA_030839725.1&quot; &quot;EHM075512&quot; &quot;EHM048917&quot; &quot;GCF_001406015.1&quot; &quot;GCA_958447325.1&quot; &quot;GCA_015060925.1&quot; [13] &quot;GCA_958416015.1&quot; &quot;GCA_030839525.1&quot; &quot;EHM039583&quot; $`4` [1] &quot;GCA_020809955.1&quot; &quot;GCA_014870645.1&quot; &quot;GCA_030842705.1&quot; &quot;GCA_959606485.1&quot; &quot;EHM027637&quot; &quot;GCF_012843465.1&quot; [7] &quot;GCF_003469715.1&quot; &quot;GCF_003471825.1&quot; &quot;EHM046460&quot; &quot;GCF_003469775.1&quot; &quot;GCA_958422645.1&quot; &quot;GCA_022774455.1&quot; [13] &quot;GCA_030842445.1&quot; &quot;GCA_958440685.1&quot; &quot;EHM016991&quot; &quot;GCF_018784195.1&quot; &quot;EHM067538&quot; &quot;GCF_001405775.1&quot; [19] &quot;GCA_030844325.1&quot; &quot;GCA_025757725.1&quot; &quot;GCA_959600655.1&quot; &quot;GCA_958432605.1&quot; &quot;GCF_003437495.1&quot; &quot;GCF_003472045.1&quot; [25] &quot;EHM064868&quot; &quot;GCF_020687325.1&quot; &quot;GCF_003468915.1&quot; &quot;GCF_003467575.1&quot; &quot;GCF_018292145.1&quot; &quot;GCF_003469235.1&quot; [31] &quot;GCA_008679285.1&quot; &quot;GCA_958427815.1&quot; &quot;EHM047216&quot; &quot;GCA_958445425.1&quot; &quot;EHM023585&quot; &quot;GCF_002206325.1&quot; [37] &quot;GCF_003468605.1&quot; &quot;GCA_958371025.1&quot; &quot;GCF_018288975.1&quot; &quot;EHM031743&quot; &quot;GCA_030841945.1&quot; &quot;GCA_959026965.1&quot; [43] &quot;GCA_022771305.1&quot; &quot;GCA_003464145.1&quot; 9.3.1 Checking each cluster at once cluster1_MAGs &lt;- mags_by_cluster[[1]] genome_metadata %&gt;% filter(ID %in% cluster1_MAGs) # A tibble: 17 × 25 ID species completeness contamination genome_size GC N50 contigs host_species host_order host_class &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016318 s__Par… 93.6 1.81 4085923 45.3 7.43e3 685 Strix aluco Strigifor… Aves 2 EHM023781 s__Par… 93.5 1.92 4159834 45.6 1.68e4 369 Podarcis ga… Squamata Reptilia 3 EHM028668 s__Par… 100.0 0.87 4684324 45 7.38e4 107 Timon lepid… Squamata Reptilia 4 EHM029564 s__Par… 95.9 1.5 4476906 45 4.19e4 152 Timon lepid… Squamata Reptilia 5 EHM048790 s__Par… 100.0 2.23 4479865 45 5.73e4 130 Lepus europ… Lagomorpha Mammalia 6 EHM049533 s__Par… 100.0 0.65 5203783 45 1.24e5 64 Podarcis fi… Squamata Reptilia 7 EHM072417 s__Par… 93.8 0.7 4365524 45 4.85e4 145 Timon lepid… Squamata Reptilia 8 GCA_959026225.1 Paraba… 99.4 0.54 4672770 45.1 9.15e4 77 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 9 GCF_018587995.1 Paraba… 99.4 0.27 5066235 45.0 3.04e5 80 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 10 GCF_018784125.1 Paraba… 99.4 1.84 4988964 45.1 1.72e5 112 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 11 GCF_018289335.1 Paraba… 99.4 0.71 5311305 45.2 5.20e6 3 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 12 GCF_022835335.1 Paraba… 93.6 1.43 4806077 45.0 2.76e6 26 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 13 GCF_022835355.1 Paraba… 93.6 1.46 4803375 45.0 2.76e6 29 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 14 GCF_003439415.1 Paraba… 99.4 1.02 5294086 45.1 2.14e5 81 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 15 GCF_019733675.1 Paraba… 99.4 1.49 5285880 45.2 3.21e5 33 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 16 GCF_003475725.1 Paraba… 99.4 1.84 5176159 45.0 1.12e5 111 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 17 GCF_003464475.1 Paraba… 99.4 1.9 5187286 44.9 2.09e5 72 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; # ℹ 14 more variables: assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, mag_name &lt;chr&gt;, eha_number &lt;chr&gt;, locality &lt;chr&gt;, # country &lt;chr&gt;, extra_locality &lt;chr&gt;, source &lt;chr&gt;, gtdb_taxonomy &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, # mimag_medium_quality &lt;lgl&gt;, gtdb_representative &lt;lgl&gt;, ncbi_date &lt;date&gt;, continent &lt;chr&gt; cluster2_MAGs &lt;- mags_by_cluster[[2]] genome_metadata %&gt;% filter(ID %in% cluster2_MAGs) # A tibble: 18 × 25 ID species completeness contamination genome_size GC N50 contigs host_species host_order host_class &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016228 s__Par… 97.3 0.92 4815605 45 3.27e4 224 Strix aluco Strigifor… Aves 2 EHM020917 s__Par… 90.3 1.73 3472909 45.6 1.19e4 414 Strix aluco Strigifor… Aves 3 EHM049769 s__Par… 95.2 1.01 4794833 45 6.88e4 107 Podarcis ga… Squamata Reptilia 4 EHM069263 s__Par… 100 0.74 5112462 45 1.46e5 97 Rattus ratt… Rodentia Mammalia 5 GCA_008680675.1 Paraba… 99.4 0.69 4962458 45.2 1.06e6 6 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 6 GCA_022776965.1 Paraba… 97.3 0.26 4589485 45.3 1.64e5 44 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 7 GCA_958413795.1 Paraba… 99.4 0.77 4948642 45.1 1.93e5 48 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 8 GCA_959028115.1 Paraba… 99.4 0.51 4709637 45.1 1.35e5 54 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 9 GCA_958416885.1 Paraba… 99.4 1.32 4704055 45.0 1.19e5 58 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 10 GCA_958404515.1 Paraba… 99.4 0.93 5100500 44.9 1.25e5 61 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 11 GCA_030843875.1 Paraba… 96.0 2.28 4410710 45.2 1.27e4 475 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 12 GCA_009774835.1 Paraba… 99.2 0.89 4866783 45.1 9.64e4 71 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 13 GCA_022784765.1 Paraba… 99.4 1.14 4816138 45.1 1.29e5 55 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 14 GCA_959023275.1 Paraba… 99.4 0.73 4832844 45.0 1.39e5 54 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 15 GCA_008679655.1 Paraba… 97.8 0.52 5036842 45.0 7.93e5 11 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 16 GCF_003474765.1 Paraba… 99.4 1.07 5043355 45.1 1.75e5 83 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 17 GCF_003459965.1 Paraba… 99.4 0.83 5151392 44.9 2.28e5 59 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 18 GCF_029369685.1 Paraba… 99.4 1.46 5493583 45.1 5.39e6 2 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; # ℹ 14 more variables: assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, mag_name &lt;chr&gt;, eha_number &lt;chr&gt;, locality &lt;chr&gt;, # country &lt;chr&gt;, extra_locality &lt;chr&gt;, source &lt;chr&gt;, gtdb_taxonomy &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, # mimag_medium_quality &lt;lgl&gt;, gtdb_representative &lt;lgl&gt;, ncbi_date &lt;date&gt;, continent &lt;chr&gt; cluster3_MAGs &lt;- mags_by_cluster[[3]] genome_metadata %&gt;% filter(ID %in% cluster3_MAGs) # A tibble: 15 × 25 ID species completeness contamination genome_size GC N50 contigs host_species host_order host_class &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016582 s__Par… 92.2 1.17 3706610 45.7 7507 618 Strix aluco Strigifor… Aves 2 EHM039583 s__Par… 98.5 1.78 4472794 45 29681 243 Sciurus vul… Rodentia Mammalia 3 EHM048917 s__Par… 94.6 1.35 3837800 46 12164 428 Lepus europ… Lagomorpha Mammalia 4 EHM049446 s__Par… 90.1 0.6 3591722 46 12732 405 Lepus europ… Lagomorpha Mammalia 5 EHM070114 s__Par… 100.0 2.39 4728690 45 63727 110 Rattus ratt… Rodentia Mammalia 6 EHM075512 s__Par… 100.0 2.34 4690486 45 64909 112 Rattus ratt… Rodentia Mammalia 7 GCA_958416015.1 Paraba… 92.4 0.18 3902302 46.4 9412 497 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 8 GCA_958447325.1 Paraba… 99.4 0.61 4709435 45.0 118754 66 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 9 GCA_030844705.1 Paraba… 97.7 0.85 4586771 45.3 134207 49 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 10 GCA_030839525.1 Paraba… 97.9 1.68 4512812 45.1 15103 417 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 11 GCA_015060925.1 Paraba… 92.9 0 2539824 39.1 102430 41 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 12 GCA_030839725.1 Paraba… 92.7 1.74 4293293 44.8 29168 238 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 13 GCA_958435695.1 Paraba… 99.4 1.06 4635291 45.0 106588 71 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 14 GCF_001405935.1 Paraba… 99.4 1.5 5099398 45.0 277147 45 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 15 GCF_001406015.1 Paraba… 99.4 0.62 5073478 NA NA NA &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; # ℹ 14 more variables: assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, mag_name &lt;chr&gt;, eha_number &lt;chr&gt;, locality &lt;chr&gt;, # country &lt;chr&gt;, extra_locality &lt;chr&gt;, source &lt;chr&gt;, gtdb_taxonomy &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, # mimag_medium_quality &lt;lgl&gt;, gtdb_representative &lt;lgl&gt;, ncbi_date &lt;date&gt;, continent &lt;chr&gt; cluster4_MAGs &lt;- mags_by_cluster[[4]] genome_metadata %&gt;% filter(ID %in% cluster4_MAGs) # A tibble: 44 × 25 ID species completeness contamination genome_size GC N50 contigs host_species host_order host_class &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016991 s__Par… 99.0 0.38 4748219 44.9 1.17e5 76 Podarcis pi… Squamata Reptilia 2 EHM023585 s__Par… 92.8 2.18 3889519 45.6 8.65e3 607 Sciurus vul… Rodentia Mammalia 3 EHM027637 s__Par… 93.5 2.05 4160022 45.3 1.28e4 526 Cathartes a… Accipitri… Aves 4 EHM031743 s__Par… 93.5 1.99 4260825 45 2.13e4 296 Canis famil… Carnivora Mammalia 5 EHM046460 s__Par… 99.5 1.66 4335884 45 3.87e4 181 Cathartes a… Accipitri… Aves 6 EHM047216 s__Par… 99.9 1.04 4517903 45 6.39e4 124 Lepus europ… Lagomorpha Mammalia 7 EHM064868 s__Par… 93.9 0.57 4141119 45 1.32e4 435 Lepus europ… Lagomorpha Mammalia 8 EHM067538 s__Par… 93.1 1.71 4147480 46 1.27e4 485 Lepus europ… Lagomorpha Mammalia 9 GCA_025757725.1 Paraba… 99.4 0.99 4848511 45.1 4.85e6 1 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 10 GCA_008679285.1 Paraba… 95.8 1.54 4711604 45.1 3.08e5 21 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; # ℹ 34 more rows # ℹ 14 more variables: assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, mag_name &lt;chr&gt;, eha_number &lt;chr&gt;, locality &lt;chr&gt;, # country &lt;chr&gt;, extra_locality &lt;chr&gt;, source &lt;chr&gt;, gtdb_taxonomy &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, # mimag_medium_quality &lt;lgl&gt;, gtdb_representative &lt;lgl&gt;, ncbi_date &lt;date&gt;, continent &lt;chr&gt; metadata_with_cluster &lt;- genome_metadata %&gt;% left_join(coords %&gt;% dplyr::select(MAG, cluster), by = c(&quot;ID&quot; = &quot;MAG&quot;)) metadata_with_cluster %&gt;% group_by(cluster, source) %&gt;% summarise(n = n(), .groups = &quot;drop&quot;) %&gt;% arrange(cluster, desc(n)) # A tibble: 8 × 3 cluster source n &lt;fct&gt; &lt;chr&gt; &lt;int&gt; 1 1 GTDB 10 2 1 EHI 7 3 2 GTDB 14 4 2 EHI 4 5 3 GTDB 9 6 3 EHI 6 7 4 GTDB 36 8 4 EHI 8 # Group summaries metadata_with_cluster %&gt;% group_by(cluster) %&gt;% summarise(mean_genome_size = mean(genome_size, na.rm = TRUE), median_contamination = median(contamination, na.rm = TRUE), .groups = &quot;drop&quot;) # A tibble: 4 × 3 cluster mean_genome_size median_contamination &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; 1 1 4826370. 1.46 2 2 4825680. 0.905 3 3 4292047. 1.17 4 4 4708235. 1.04 save(ehi_mags, phylum_colors, genome_annotations, genome_gifts, contig_to_genome, gtdb_metadata, ehi_metadata, master_index, genome_metadata, source_colors, getphylo_tree, metadata_with_cluster, file = &quot;data/data.Rdata&quot;) Is the genome size different between clusters? kruskal.test(genome_size ~ cluster, data = metadata_with_cluster) Kruskal-Wallis rank sum test data: genome_size by cluster Kruskal-Wallis chi-squared = 9.5898, df = 3, p-value = 0.02239 pairwise.wilcox.test( x = metadata_with_cluster$genome_size, g = metadata_with_cluster$cluster, p.adjust.method = &quot;BH&quot; # FDR correction ) Pairwise comparisons using Wilcoxon rank sum exact test data: metadata_with_cluster$genome_size and metadata_with_cluster$cluster 1 2 3 2 1.000 - - 3 0.042 0.016 - 4 0.382 0.288 0.080 P value adjustment method: BH Plots ggplot(metadata_with_cluster, aes(x = genome_size, y = GC, col = cluster))+ geom_point()+ theme_bw() Warning: Removed 2 rows containing missing values or values outside the scale range (`geom_point()`). ggplot(metadata_with_cluster, aes(x = assembly_type, y = source, col = cluster))+ geom_point()+ theme_bw() ggplot(metadata_with_cluster, aes(x = cluster, y = genome_size, col = cluster))+ geom_point()+ theme_bw() #Aggregate bundle-level GIFTs into the compound level GIFTs_elements &lt;- to.elements(genome_gifts,GIFT_db) #Aggregate element-level GIFTs into the function level GIFTs_functions &lt;- to.functions(GIFTs_elements,GIFT_db) #Aggregate function-level GIFTs into overall Biosynthesis, Degradation and Structural GIFTs GIFTs_domains &lt;- to.domains(GIFTs_functions,GIFT_db) GIFTs_elements %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;MAG&quot;)%&gt;% pivot_longer(!MAG,names_to=&quot;trait&quot;,values_to=&quot;gift&quot;) %&gt;% left_join(metadata_with_cluster, by = join_by(MAG == ID)) %&gt;% mutate(functionid = substr(trait, 1, 3)) %&gt;% mutate(trait = case_when( trait %in% GIFT_db$Code_element ~ GIFT_db$Element[match(trait, GIFT_db$Code_element)], TRUE ~ trait )) %&gt;% mutate(functionid = case_when( functionid %in% GIFT_db$Code_function ~ GIFT_db$Function[match(functionid, GIFT_db$Code_function)], TRUE ~ functionid )) %&gt;% mutate(trait=factor(trait,levels=unique(GIFT_db$Element))) %&gt;% mutate(functionid=factor(functionid,levels=unique(GIFT_db$Function))) %&gt;% ggplot(aes(x=MAG,y=trait,fill=gift)) + geom_tile(colour=&quot;white&quot;, linewidth=0.2)+ scale_fill_gradientn(colours=rev(c(&quot;#d53e4f&quot;, &quot;#f46d43&quot;, &quot;#fdae61&quot;, &quot;#fee08b&quot;, &quot;#e6f598&quot;, &quot;#abdda4&quot;, &quot;#ddf1da&quot;)))+ facet_grid(functionid ~ cluster, scales=&quot;free&quot;,space=&quot;free&quot;) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.text.y = element_text(size=6), strip.text.y = element_text(angle = 0) ) + labs(y=&quot;Traits&quot;,x=&quot;Samples&quot;,fill=&quot;GIFT&quot;) GIFTs_elements %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;MAG&quot;)%&gt;% pivot_longer(!MAG,names_to=&quot;trait&quot;,values_to=&quot;gift&quot;) %&gt;% left_join(metadata_with_cluster, by = join_by(MAG == ID)) %&gt;% mutate(functionid = substr(trait, 1, 3)) %&gt;% mutate(trait = case_when( trait %in% GIFT_db$Code_element ~ GIFT_db$Element[match(trait, GIFT_db$Code_element)], TRUE ~ trait )) %&gt;% mutate(functionid = case_when( functionid %in% GIFT_db$Code_function ~ GIFT_db$Function[match(functionid, GIFT_db$Code_function)], TRUE ~ functionid )) %&gt;% mutate(trait=factor(trait,levels=unique(GIFT_db$Element))) %&gt;% mutate(functionid=factor(functionid,levels=unique(GIFT_db$Function))) %&gt;% ggplot(aes(x=MAG,y=trait,fill=gift)) + geom_tile(colour=&quot;white&quot;, linewidth=0.2)+ scale_fill_gradientn(colours=rev(c(&quot;#d53e4f&quot;, &quot;#f46d43&quot;, &quot;#fdae61&quot;, &quot;#fee08b&quot;, &quot;#e6f598&quot;, &quot;#abdda4&quot;, &quot;#ddf1da&quot;)))+ facet_grid(functionid ~ source, scales=&quot;free&quot;,space=&quot;free&quot;) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.text.y = element_text(size=6), strip.text.y = element_text(angle = 0) ) + labs(y=&quot;Traits&quot;,x=&quot;Samples&quot;,fill=&quot;GIFT&quot;) library(RColorBrewer) library(reshape2) GIFTs_elements %&gt;% reshape2::melt() %&gt;% dplyr::rename(Genome = Var1, Code_element = Var2, GIFT = value) %&gt;% inner_join(GIFT_db,by=&quot;Code_element&quot;) %&gt;% ggplot(., aes(x=Code_element, y=Genome, fill=GIFT, group=Code_function))+ geom_tile()+ scale_y_discrete(guide = guide_axis(check.overlap = TRUE))+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+ scale_fill_gradientn(limits = c(0,1), colours=brewer.pal(7, &quot;YlGnBu&quot;))+ facet_grid(. ~ Code_function, scales = &quot;free&quot;, space = &quot;free&quot;)+ theme_grey(base_size=8)+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),strip.text.x = element_text(angle = 90)) Warning in inner_join(., GIFT_db, by = &quot;Code_element&quot;): Detected an unexpected many-to-many relationship between `x` and `y`. ℹ Row 753 of `x` matches multiple rows in `y`. ℹ Row 1 of `y` matches multiple rows in `x`. ℹ If a many-to-many relationship is expected, set `relationship = &quot;many-to-many&quot;` to silence this warning. head(GIFT_db) Code_bundle Code_element Code_function Domain Function Element 1 B010101 B0101 B01 Biosynthesis Nucleic acid biosynthesis Inosinic acid (IMP) 2 B010201 B0102 B01 Biosynthesis Nucleic acid biosynthesis Uridylic acid (UMP) 3 B010301 B0103 B01 Biosynthesis Nucleic acid biosynthesis UDP/UTP 4 B010401 B0104 B01 Biosynthesis Nucleic acid biosynthesis CDP/CTP 5 B010501 B0105 B01 Biosynthesis Nucleic acid biosynthesis ADP/ATP 6 B010601 B0106 B01 Biosynthesis Nucleic acid biosynthesis GDP/GTP Definition 1 K00764 (K01945,K11787,K11788,K13713) (K00601,K11175,K08289,K11787,K01492) (K01952,(K23269+K23264+K23265),(K23270+K23265)) (K01933,K11787,(K11788 (K01587,K11808,(K01589 K01588)))) (K01923,K01587,K13713) K01756 (K00602,(K01492,(K06863 K11176))) 2 (K11540,((K11541 K01465),((K01954,(K01955+K01956)) ((K00609+K00610),K00608) K01465))) (K00226,K00254,K17828) (K13421,(K00762 K01591)) 3 (K13800,K13809,K09903) 4 (K00940,K18533) K01937 5 K01939 K01756 (K00939,K18532,K18533,K00944) K00940 6 K00088 K01951 K00942 (K00940,K18533) GIFT_db%&gt;% filter(Code_function == &quot;D09&quot;) Code_bundle Code_element Code_function Domain Function Element 1 D090101 D0901 D09 Degradation Antibiotic degradation Penicillin 2 D090201 D0902 D09 Degradation Antibiotic degradation Carbapenem 3 D090301 D0903 D09 Degradation Antibiotic degradation Cephalosporin 4 D090401 D0904 D09 Degradation Antibiotic degradation Oxacillin 5 D090501 D0905 D09 Degradation Antibiotic degradation Streptogramin 6 D090601 D0906 D09 Degradation Antibiotic degradation Fosfomycin 7 D090701 D0907 D09 Degradation Antibiotic degradation Tetracycline 8 D090801 D0908 D09 Degradation Antibiotic degradation Macrolide 9 D091001 D0910 D09 Degradation Antibiotic degradation Chloramphenicol 10 D091101 D0911 D09 Degradation Antibiotic degradation Lincosamide 11 D091201 D0912 D09 Degradation Antibiotic degradation Streptothricin Definition 1 K18698,K18699,K18796,K18767,K18797,K19097,K19317,K18768,K18970,K19316,K22346,K18795,K19218,K19217,K17836,K18766 2 K17837,K18782,K18781,K18780,K19099,K19216 3 K19095,K19096,K19100,K19101,K19214,K19215,K20319,K20320,K01467 4 K17838,K18790,K18791,K19098,K18792,K19213,K21276,K18793,K18971,K22352,K19209,K18976,K18973,K18794,K18972,K21277,K19210,K19211,K19212,K22335,K19319,K22331,K22351,K19320,K19318,K19321,K19322,K21266,K22334,K22333,K22332 5 K19349,K19350 6 K21252 7 K08151,K08168,K18214,K18218,K18220,K18221 8 K06979,K08217,K18230,K18231,K21251 9 K00638,K08160,K18552,K18553,K18554,K19271 10 K18236,K19349,K19350,K19545 11 K19273,K20816 library(reshape2) library(RColorBrewer) GIFTs_elements %&gt;% melt() %&gt;% dplyr::rename(Genome = Var1, Code_element = Var2, GIFT = value) %&gt;% inner_join(GIFT_db, by = &quot;Code_element&quot;) %&gt;% # Map Code_element -&gt; Element &amp; Function filter(str_starts(Code_element, &quot;D09&quot;)) %&gt;% # Only antibiotic degradation left_join(metadata_with_cluster, by = join_by(Genome == ID)) %&gt;% mutate(cluster = factor(cluster)) %&gt;% droplevels() %&gt;% arrange(cluster, Genome) %&gt;% # Map Code_element IDs to trait names mutate(trait = case_when( Code_element %in% GIFT_db$Code_element ~ GIFT_db$Element[match(Code_element, GIFT_db$Code_element)], TRUE ~ Code_element )) %&gt;% # Map function IDs for faceting if desired mutate(functionid = case_when( substr(Code_element,1,3) %in% GIFT_db$Code_function ~ GIFT_db$Function[match(substr(Code_element,1,3), GIFT_db$Code_function)], TRUE ~ substr(Code_element,1,3) )) %&gt;% mutate(trait = factor(trait, levels = unique(GIFT_db$Element))) %&gt;% ggplot(aes(x = trait, y = Genome, fill = GIFT)) + geom_tile(colour = &quot;white&quot;, linewidth = 0.2) + scale_y_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_fill_gradientn(limits = c(0,1), colours = brewer.pal(7, &quot;YlGnBu&quot;)) + facet_wrap(~ cluster, scales = &quot;free_y&quot;, ncol = 1) + theme_grey(base_size = 8) + theme( axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), strip.text.x = element_text(angle = 0) ) + labs(x = &quot;Trait&quot;, fill = &quot;GIFT&quot;) Warning in inner_join(., GIFT_db, by = &quot;Code_element&quot;): Detected an unexpected many-to-many relationship between `x` and `y`. ℹ Row 753 of `x` matches multiple rows in `y`. ℹ Row 1 of `y` matches multiple rows in `x`. ℹ If a many-to-many relationship is expected, set `relationship = &quot;many-to-many&quot;` to silence this warning. 9.3.2 Checking difference in GIFTs 9.3.2.1 Cluster-wise Element GIFTs different between clusters of pcoa # Get only the GIFT columns gift_cols &lt;- colnames(GIFTs_elements)[!(colnames(GIFTs_elements) %in% c(&quot;MAG_ID&quot;,&quot;cluster&quot;,&quot;source&quot;))] gift_dataframe &lt;- GIFTs_elements %&gt;% as.data.frame() %&gt;% rownames_to_column(var = &quot;ID&quot;) gift_df_meta &lt;- gift_dataframe %&gt;% left_join(metadata_with_cluster, by = &quot;ID&quot;) # Kruskal-Wallis for 4 groups kruskal_results &lt;- sapply(gift_cols, function(g) { kruskal.test(as.formula(paste(g, &quot;~ cluster&quot;)), data = gift_df_meta)$p.value }) # Adjust for multiple testing kruskal_results_adj &lt;- p.adjust(kruskal_results, method = &quot;BH&quot;) # Combine into a table kruskal_table &lt;- data.frame( GIFT = gift_cols, p_value = kruskal_results, p_adj = kruskal_results_adj ) kruskal_table %&gt;% filter(p_adj&lt;0.05) GIFT p_value p_adj B0105 B0105 1.059704e-03 9.236991e-03 B0216 B0216 2.315874e-04 3.242224e-03 B0705 B0705 1.599349e-05 2.985451e-04 B0706 B0706 1.060333e-03 9.236991e-03 D0601 D0601 1.154624e-03 9.236991e-03 D0901 D0901 4.966894e-20 1.390730e-18 D0908 D0908 4.966894e-20 1.390730e-18 pairwise_results &lt;- lapply(gift_cols, function(g) { pairwise.wilcox.test( x = gift_df_meta[[g]], g = gift_df_meta$cluster, p.adjust.method = &quot;BH&quot; ) }) names(pairwise_results) &lt;- gift_cols pairwise_sig_table &lt;- lapply(names(pairwise_results), function(g) { # Extract p-value matrix pmat &lt;- pairwise_results[[g]]$p.value # Convert to long format pmat_long &lt;- as.data.frame(as.table(pmat)) %&gt;% filter(!is.na(Freq)) %&gt;% # remove NA (diagonal / upper triangle) dplyr::rename(group1 = Var1, group2 = Var2, p_adj = Freq) %&gt;% filter(p_adj &lt; 0.05) %&gt;% # keep only significant comparisons mutate(GIFT = g) return(pmat_long) }) # Combine all GIFTs into one table pairwise_sig_table &lt;- bind_rows(pairwise_sig_table) %&gt;% dplyr::select(GIFT, group1, group2, p_adj) pairwise_sig_table GIFT group1 group2 p_adj 1 B0104 4 3 4.713956e-02 2 B0105 4 3 8.227678e-03 3 B0214 4 3 4.718606e-02 4 B0216 2 1 3.161198e-04 5 B0216 4 2 1.740565e-03 6 B0307 3 1 3.955850e-02 7 B0309 4 3 4.713956e-02 8 B0705 2 1 9.897753e-03 9 B0705 4 2 2.247836e-05 10 B0705 4 3 1.899845e-03 11 B0706 4 3 8.235827e-03 12 D0509 4 3 4.718606e-02 13 D0512 4 3 4.718606e-02 14 D0601 3 1 4.605396e-02 15 D0601 3 2 4.605396e-02 16 D0601 4 3 2.201166e-02 17 D0901 3 1 2.923958e-08 18 D0901 4 1 2.058151e-14 19 D0901 3 2 2.321913e-08 20 D0901 4 2 2.058151e-14 21 D0908 2 1 8.235871e-09 22 D0908 3 1 2.923958e-08 23 D0908 4 2 2.468680e-14 24 D0908 4 3 5.731923e-14 library(reshape2) library(RColorBrewer) GIFTs_elements %&gt;% melt() %&gt;% dplyr::rename(Genome = Var1, Code_element = Var2, GIFT = value) %&gt;% inner_join(GIFT_db, by = &quot;Code_element&quot;) %&gt;% # Only keep significant traits filter(Code_element %in% pairwise_sig_table$GIFT) %&gt;% left_join(metadata_with_cluster, by = join_by(Genome == ID)) %&gt;% distinct(Genome, Code_element, .keep_all = TRUE) %&gt;% mutate(cluster = factor(cluster)) %&gt;% droplevels() %&gt;% arrange(cluster, Genome) %&gt;% mutate(trait = Element) %&gt;% # human-readable trait ggplot(aes(x = trait, y = Genome, fill = GIFT)) + geom_tile(colour = &quot;white&quot;, linewidth = 0.2) + scale_y_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_fill_gradientn(limits = c(0,1), colours = RColorBrewer::brewer.pal(7, &quot;YlGnBu&quot;)) + facet_wrap(~ cluster, scales = &quot;free_y&quot;, ncol = 1) + theme_grey(base_size = 8) + theme( axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), strip.text.x = element_text(angle = 0) ) + labs(x = &quot;Trait&quot;, fill = &quot;GIFT&quot;) 9.3.2.2 Source-wise GIFTs that are different between EHI and GTDB wilcox_results &lt;- sapply(gift_cols, function(g) { wilcox.test(as.formula(paste(g, &quot;~ source&quot;)), data = gift_df_meta)$p.value }) wilcox_results_adj &lt;- p.adjust(wilcox_results, method = &quot;BH&quot;) data.frame( GIFT = gift_cols, p_value = wilcox_results, p_adj = wilcox_results_adj ) GIFT p_value p_adj B0101 B0101 0.018213624 0.15218196 B0102 B0102 0.401607923 0.56263194 B0103 B0103 NaN NaN B0104 B0104 0.401607923 0.56263194 B0105 B0105 0.811205473 0.81120547 B0106 B0106 0.172296564 0.38594430 B0204 B0204 0.563363980 0.60669967 B0205 B0205 0.401607923 0.56263194 B0206 B0206 0.101578744 0.30391265 B0207 B0207 0.287025390 0.53903113 B0208 B0208 NaN NaN B0209 B0209 0.800305311 0.81120547 B0210 B0210 0.101578744 0.30391265 B0211 B0211 0.461701145 0.56263194 B0212 B0212 0.019022745 0.15218196 B0213 B0213 NaN NaN B0214 B0214 0.401635140 0.56263194 B0215 B0215 0.000766161 0.04290502 B0216 B0216 0.523528615 0.58635205 B0217 B0217 0.101578744 0.30391265 B0218 B0218 NaN NaN B0219 B0219 0.059866231 0.30391265 B0220 B0220 0.103113221 0.30391265 B0221 B0221 0.294227342 0.53903113 B0302 B0302 NaN NaN B0303 B0303 0.101578744 0.30391265 B0307 B0307 0.004460384 0.11867498 B0309 B0309 0.461701145 0.56263194 B0310 B0310 NaN NaN B0401 B0401 NaN NaN B0402 B0402 NaN NaN B0403 B0403 NaN NaN B0601 B0601 0.101578744 0.30391265 B0602 B0602 0.101578744 0.30391265 B0603 B0603 0.298392235 0.53903113 B0604 B0604 NaN NaN B0605 B0605 NaN NaN B0701 B0701 NaN NaN B0702 B0702 0.337380104 0.56263194 B0703 B0703 NaN NaN B0704 B0704 0.401607923 0.56263194 B0705 B0705 0.295390306 0.53903113 B0706 B0706 0.122206797 0.31715538 B0707 B0707 0.118833558 0.31715538 B0708 B0708 0.733058029 0.77455188 B0709 B0709 0.461701145 0.56263194 B0710 B0710 0.053966437 0.30221205 B0711 B0711 0.022271688 0.15590182 B0712 B0712 0.472208950 0.56263194 B0801 B0801 NaN NaN B0802 B0802 NaN NaN B0803 B0803 NaN NaN B0804 B0804 NaN NaN B0805 B0805 NaN NaN B0901 B0901 NaN NaN B0902 B0902 NaN NaN B0903 B0903 NaN NaN B1004 B1004 NaN NaN B1006 B1006 NaN NaN B1008 B1008 NaN NaN B1011 B1011 NaN NaN B1012 B1012 NaN NaN B1014 B1014 NaN NaN B1021 B1021 NaN NaN B1022 B1022 NaN NaN B1024 B1024 NaN NaN B1026 B1026 0.047359370 0.29468052 B1028 B1028 NaN NaN B1029 B1029 NaN NaN B1041 B1041 NaN NaN B1042 B1042 NaN NaN D0101 D0101 0.019022745 0.15218196 D0102 D0102 NaN NaN D0103 D0103 NaN NaN D0104 D0104 NaN NaN D0201 D0201 NaN NaN D0202 D0202 NaN NaN D0203 D0203 NaN NaN D0204 D0204 NaN NaN D0205 D0205 NaN NaN D0206 D0206 NaN NaN D0207 D0207 NaN NaN D0208 D0208 NaN NaN D0209 D0209 NaN NaN D0210 D0210 NaN NaN D0211 D0211 NaN NaN D0212 D0212 NaN NaN D0213 D0213 NaN NaN D0301 D0301 NaN NaN D0302 D0302 NaN NaN D0303 D0303 NaN NaN D0304 D0304 NaN NaN D0305 D0305 NaN NaN D0306 D0306 NaN NaN D0307 D0307 NaN NaN D0308 D0308 NaN NaN D0309 D0309 NaN NaN D0310 D0310 NaN NaN D0401 D0401 NaN NaN D0402 D0402 NaN NaN D0403 D0403 NaN NaN D0404 D0404 NaN NaN D0405 D0405 NaN NaN D0406 D0406 NaN NaN D0407 D0407 NaN NaN D0408 D0408 NaN NaN D0501 D0501 NaN NaN D0502 D0502 NaN NaN D0503 D0503 NaN NaN D0504 D0504 NaN NaN D0505 D0505 NaN NaN D0506 D0506 NaN NaN D0507 D0507 0.130260244 0.31715538 D0508 D0508 NaN NaN D0509 D0509 0.472208950 0.56263194 D0510 D0510 NaN NaN D0511 D0511 NaN NaN D0512 D0512 0.401635140 0.56263194 D0513 D0513 0.494966597 0.57746103 D0516 D0516 NaN NaN D0517 D0517 NaN NaN D0518 D0518 NaN NaN D0601 D0601 0.006357588 0.11867498 D0602 D0602 NaN NaN D0603 D0603 NaN NaN D0604 D0604 NaN NaN D0606 D0606 NaN NaN D0607 D0607 NaN NaN D0608 D0608 NaN NaN D0609 D0609 NaN NaN D0610 D0610 NaN NaN D0611 D0611 NaN NaN D0612 D0612 NaN NaN D0613 D0613 NaN NaN D0701 D0701 NaN NaN D0702 D0702 NaN NaN D0704 D0704 NaN NaN D0705 D0705 NaN NaN D0706 D0706 NaN NaN D0708 D0708 NaN NaN D0709 D0709 NaN NaN D0801 D0801 NaN NaN D0802 D0802 NaN NaN D0804 D0804 NaN NaN D0805 D0805 NaN NaN D0806 D0806 NaN NaN D0807 D0807 0.800305311 0.81120547 D0808 D0808 NaN NaN D0809 D0809 NaN NaN D0810 D0810 NaN NaN D0811 D0811 NaN NaN D0812 D0812 NaN NaN D0813 D0813 NaN NaN D0814 D0814 NaN NaN D0815 D0815 NaN NaN D0816 D0816 NaN NaN D0817 D0817 NaN NaN D0818 D0818 NaN NaN D0819 D0819 NaN NaN D0901 D0901 0.419483994 0.56263194 D0902 D0902 0.461701145 0.56263194 D0903 D0903 NaN NaN D0904 D0904 0.401607923 0.56263194 D0905 D0905 NaN NaN D0906 D0906 NaN NaN D0907 D0907 0.461701145 0.56263194 D0908 D0908 0.555210799 0.60669967 D0910 D0910 0.019022745 0.15218196 D0911 D0911 0.298379973 0.53903113 D0912 D0912 0.101578744 0.30391265 S0101 S0101 NaN NaN S0103 S0103 NaN NaN S0104 S0104 NaN NaN S0105 S0105 0.225695874 0.48611419 S0201 S0201 0.160349897 0.37414976 S0202 S0202 0.508701592 0.58137325 S0301 S0301 0.125346865 0.31715538 effect_size &lt;- sapply(gift_cols, function(g) { median(gift_df_meta[[g]][gift_df_meta$source==&quot;GTDB&quot;]) - median(gift_df_meta[[g]][gift_df_meta$source==&quot;EHI&quot;]) }) wilcox_res_source &lt;- data.frame( GIFT = gift_cols, p_value = wilcox_results, p_adj = wilcox_results_adj, effect = effect_size ) wilcox_res_source %&gt;% filter(p_adj&lt;0.05) GIFT p_value p_adj effect B0215 B0215 0.000766161 0.04290502 0 GIFT_db%&gt;% filter(Code_element == &quot;B0215&quot;) Code_bundle Code_element Code_function Domain Function Element 1 B021501 B0215 B02 Biosynthesis Amino acid biosynthesis Histidine Definition 1 K00765 ((K01523 K01496),K11755,K14152) (K01814,K24017) ((K02501+K02500),K01663) ((K01693 K00817 (K04486,K05602,K18649)),(K01089 K00817)) (K00013,K14152) "],["functional-analysis-human.html", "Chapter 10 Functional Analysis (HUMAN) 10.1 Functional overview 10.2 Functional ordination", " Chapter 10 Functional Analysis (HUMAN) 10.1 Functional overview n_genes &lt;- genome_annotations %&gt;% group_by(genome_filename) %&gt;% summarize(n_genes = n()) n_genes # A tibble: 72 × 2 genome_filename n_genes &lt;chr&gt; &lt;int&gt; 1 EHM016228 4139 2 EHM016318 3839 3 EHM016582 3426 4 EHM016991 3950 5 EHM020917 3139 6 EHM023585 3569 7 EHM023781 3572 8 EHM027637 3731 9 EHM028668 3922 10 EHM029564 3752 # ℹ 62 more rows 10.1.0.1 Predicted genes pred_genes &lt;- genome_annotations %&gt;% nrow() cat(pred_genes) 275206 10.1.0.2 Number of annotated genes and percentages #How many genes have at least 1 annotation genome_annota &lt;- genome_annotations %&gt;% filter(if_any(c(kegg, pfam, cazy), ~ !is.na(.))) %&gt;% nrow() cat(genome_annota) 233243 #Percentage of predicted genes with at least 1 annotation genome_annota*100/pred_genes [1] 84.75215 10.1.0.3 Number of KEGG annotatated genes and percentages # KEGG annotation kegg_annota &lt;- genome_annotations %&gt;% filter(!is.na(kegg)) %&gt;% nrow() cat(kegg_annota) 184602 # KEGG annotation percentage kegg_annota*100/genome_annota [1] 79.14578 10.2 Functional ordination PCoA with Euclidean distances: # Convert the GIFTs into a matrix of functional elements per genome (row) gift_pcoa &lt;- genome_gifts %&gt;% to.elements(., GIFT_db) %&gt;% as.data.frame() %&gt;% vegdist(method=&quot;euclidean&quot;) %&gt;% pcoa() #principal component analysis #Extract eigenvalues (variance explained by first 10 axes) gift_pcoa_rel_eigen &lt;- gift_pcoa$values$Relative_eig[1:10] # Get genome positions gift_pcoa_vectors &lt;- gift_pcoa$vectors %&gt;% #extract vectors as.data.frame() %&gt;% dplyr::select(Axis.1,Axis.2) # keep the first 2 axes gift_pcoa_eigenvalues &lt;- gift_pcoa$values$Eigenvalues[c(1,2)] #For the black arrows: Functional group loadings # covariance between each functional trait and pcoa axis scores #scale with the eigenvectors gift_pcoa_gifts &lt;- cov(genome_gifts, scale(gift_pcoa_vectors)) %*% diag((gift_pcoa_eigenvalues/(nrow(genome_gifts)-1))^(-0.5)) %&gt;% as.data.frame() %&gt;% dplyr::rename(Axis.1=1,Axis.2=2) %&gt;% rownames_to_column(var=&quot;label&quot;) %&gt;% #get function summary vectors mutate(func=substr(label,1,3)) %&gt;% group_by(func) %&gt;% #grouping by function summarise(Axis.1=mean(Axis.1), Axis.2=mean(Axis.2)) %&gt;% dplyr::rename(label=func) %&gt;% dplyr::filter(!label %in% c(&quot;S01&quot;,&quot;S02&quot;,&quot;S03&quot;)) set.seed(101) scale &lt;- 20 # scale for vector loadings (to make arrows visible) gift_pcoa_vectors %&gt;% rownames_to_column(var=&quot;ID&quot;) %&gt;% left_join(genome_metadata, by=&quot;ID&quot;) %&gt;% ggplot() + #genome positions scale_color_manual(values=source_colors)+ geom_point(aes(x=Axis.1,y=Axis.2, color = source), alpha=0.9, shape=16) + scale_size_continuous(range = c(0.1,5)) + #loading positions geom_segment(data=gift_pcoa_gifts, aes(x=0, y=0, xend=Axis.1 * scale, yend=Axis.2 * scale), arrow = arrow(length = unit(0.3, &quot;cm&quot;), type = &quot;open&quot;, angle = 25), linewidth = 0.5, color = &quot;black&quot;) + #Primary and secondary scale adjustments scale_x_continuous(name = paste0(&quot;PCoA1 (&quot;,round(gift_pcoa_rel_eigen[1]*100, digits = 2), &quot; %)&quot;), sec.axis = sec_axis(~ . / scale, name = &quot;Loadings on PCoA1&quot;) ) + scale_y_continuous(name = paste0(&quot;PCoA2 (&quot;,round(gift_pcoa_rel_eigen[2]*100, digits = 2), &quot; %)&quot;), sec.axis = sec_axis(~ . / scale, name = &quot;Loadings on PCoA2&quot;) ) + geom_label_repel(data = gift_pcoa_gifts, aes(label = label, x = Axis.1 * scale, y = Axis.2 * scale), segment.color = &#39;transparent&#39;) + xlim(-0.8,1) + ylim(-1,1.5) + theme_minimal() + labs( x = paste0(&quot;PCoA1 (&quot;, round(gift_pcoa_rel_eigen[1]*100, 2), &quot; %)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(gift_pcoa_rel_eigen[2]*100, 2), &quot; %)&quot;) ) Warning: Removed 16 rows containing missing values or values outside the scale range (`geom_point()`). Warning: Removed 1 row containing missing values or values outside the scale range (`geom_segment()`). Warning: Removed 1 row containing missing values or values outside the scale range (`geom_label_repel()`). Warning: ggrepel: 13 unlabeled data points (too many overlaps). Consider increasing max.overlaps Using k-means to cluster the groups and check which MAGs cluster together: coords &lt;- gift_pcoa_vectors %&gt;% rownames_to_column(&quot;MAG&quot;) %&gt;% as_tibble() set.seed(123) km &lt;- kmeans(coords[, c(&quot;Axis.1&quot;, &quot;Axis.2&quot;)], centers = 4) coords &lt;- coords %&gt;% mutate(cluster = factor(km$cluster)) # centroids as a tibble for plotting centroids &lt;- as_tibble(km$centers) %&gt;% mutate(cluster = factor(1:nrow(km$centers))) ggplot(coords, aes(x = Axis.1, y = Axis.2, color = cluster)) + geom_point(size = 2, alpha = 0.8) + geom_point(data = centroids, aes(x = Axis.1, y = Axis.2, color = cluster), shape = 4, size = 5, stroke = 1.25) + # X marks centroids theme_minimal() + labs(title = paste0(&quot;PCoA colored by kmeans (k=3)&quot;), color = &quot;cluster&quot;) mags_by_cluster &lt;- split(coords$MAG, km$cluster) mags_by_cluster $`1` [1] &quot;GCA_938033965.1&quot; &quot;GCA_008679655.1&quot; &quot;GCF_934699105.1&quot; &quot;EHM020917&quot; &quot;GCA_959023275.1&quot; &quot;GCA_003526535.1&quot; [7] &quot;GCA_958404515.1&quot; &quot;EHM049769&quot; &quot;GCA_008680675.1&quot; &quot;EHM069263&quot; &quot;GCF_934725235.1&quot; &quot;GCA_958416885.1&quot; [13] &quot;GCA_958413795.1&quot; &quot;GCA_959028115.1&quot; &quot;EHM016228&quot; &quot;GCA_003503335.1&quot; $`2` [1] &quot;EHM049533&quot; &quot;EHM072417&quot; &quot;EHM023781&quot; &quot;GCA_959026225.1&quot; &quot;EHM029564&quot; &quot;GCF_022137425.1&quot; [7] &quot;EHM016318&quot; &quot;EHM048790&quot; &quot;EHM028668&quot; $`3` [1] &quot;GCA_003534485.1&quot; &quot;EHM049446&quot; &quot;EHM075512&quot; &quot;GCA_905196755.1&quot; &quot;GCA_958435695.1&quot; &quot;EHM070114&quot; [7] &quot;EHM048917&quot; &quot;GCA_003539615.1&quot; &quot;EHM016582&quot; &quot;GCF_934668585.1&quot; &quot;GCA_958447325.1&quot; &quot;EHM039583&quot; $`4` [1] &quot;EHM031743&quot; &quot;GCA_934834945.1&quot; &quot;GCA_934837735.1&quot; &quot;EHM027637&quot; &quot;GCA_934839725.1&quot; &quot;GCA_958440685.1&quot; [7] &quot;EHM046460&quot; &quot;GCA_934876615.1&quot; &quot;GCA_958427815.1&quot; &quot;GCA_934838245.1&quot; &quot;EHM023585&quot; &quot;GCF_934725195.1&quot; [13] &quot;GCF_000436315.1&quot; &quot;EHM067538&quot; &quot;GCA_934883325.1&quot; &quot;GCA_959600655.1&quot; &quot;EHM064868&quot; &quot;GCA_928721495.1&quot; [19] &quot;GCA_959606485.1&quot; &quot;GCF_902387045.1&quot; &quot;GCA_934826265.1&quot; &quot;GCA_934835845.1&quot; &quot;GCA_958371025.1&quot; &quot;GCA_934871785.1&quot; [25] &quot;GCA_008679285.1&quot; &quot;GCA_943912415.1&quot; &quot;GCA_934838425.1&quot; &quot;GCA_958432605.1&quot; &quot;GCA_934828805.1&quot; &quot;GCA_934834725.1&quot; [31] &quot;GCA_934836305.1&quot; &quot;EHM016991&quot; &quot;GCA_958445425.1&quot; &quot;GCF_013267615.1&quot; &quot;EHM047216&quot; 10.2.1 Checking each cluster at once cluster1_MAGs &lt;- mags_by_cluster[[1]] genome_metadata %&gt;% filter(ID %in% cluster1_MAGs) # A tibble: 16 × 21 ID species completeness contamination genome_size GC N50 contigs host_species host_order host_class &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016228 s__Par… 97.3 0.92 4815605 45 3.27e4 224 Strix aluco Strigifor… Aves 2 EHM020917 s__Par… 90.3 1.73 3472909 45.6 1.19e4 414 Strix aluco Strigifor… Aves 3 EHM049769 s__Par… 95.2 1.01 4794833 45 6.88e4 107 Podarcis ga… Squamata Reptilia 4 EHM069263 s__Par… 100 0.74 5112462 45 1.46e5 97 Rattus ratt… Rodentia Mammalia 5 GCA_008680675.1 &lt;NA&gt; 100.0 0.69 4962458 45.2 1.06e6 6 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 6 GCA_958413795.1 &lt;NA&gt; 100 0.77 4948642 45.1 1.93e5 48 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 7 GCA_959028115.1 &lt;NA&gt; 100.0 0.51 4709637 45.1 1.35e5 54 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 8 GCA_958416885.1 &lt;NA&gt; 100.0 1.32 4704055 45.0 1.19e5 58 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 9 GCA_938033965.1 &lt;NA&gt; 99.9 1.35 4879227 45.0 2.33e5 42 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 10 GCA_958404515.1 &lt;NA&gt; 100.0 0.93 5100500 44.9 1.25e5 61 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 11 GCA_003526535.1 &lt;NA&gt; 99.6 0.59 4620423 45.0 8.72e4 92 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 12 GCA_003503335.1 &lt;NA&gt; 100.0 0.97 4762984 45.0 9.28e4 80 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 13 GCA_959023275.1 &lt;NA&gt; 100.0 0.73 4832844 45.0 1.39e5 54 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 14 GCA_008679655.1 &lt;NA&gt; 97.2 0.52 5036842 45.0 7.93e5 11 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 15 GCF_934725235.1 &lt;NA&gt; 94.8 1.41 4547066 45.0 1.06e5 57 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 16 GCF_934699105.1 &lt;NA&gt; 97.8 0.97 4451331 45.3 1.39e5 46 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; # ℹ 10 more variables: assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, mag_name &lt;chr&gt;, eha_number &lt;chr&gt;, source &lt;chr&gt;, # gtdb_taxonomy &lt;chr&gt;, ncbi_country &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, mimag_medium_quality &lt;lgl&gt;, # gtdb_representative &lt;lgl&gt; cluster2_MAGs &lt;- mags_by_cluster[[2]] genome_metadata %&gt;% filter(ID %in% cluster2_MAGs) # A tibble: 9 × 21 ID species completeness contamination genome_size GC N50 contigs host_species host_order host_class &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016318 s__Para… 93.6 1.81 4085923 45.3 7435 685 Strix aluco Strigifor… Aves 2 EHM023781 s__Para… 93.5 1.92 4159834 45.6 16836 369 Podarcis ga… Squamata Reptilia 3 EHM028668 s__Para… 100.0 0.87 4684324 45 73796 107 Timon lepid… Squamata Reptilia 4 EHM029564 s__Para… 95.9 1.5 4476906 45 41913 152 Timon lepid… Squamata Reptilia 5 EHM048790 s__Para… 100.0 2.23 4479865 45 57286 130 Lepus europ… Lagomorpha Mammalia 6 EHM049533 s__Para… 100.0 0.65 5203783 45 123694 64 Podarcis fi… Squamata Reptilia 7 EHM072417 s__Para… 93.8 0.7 4365524 45 48534 145 Timon lepid… Squamata Reptilia 8 GCA_959026225.1 &lt;NA&gt; 100.0 0.54 4672770 45.1 91526 77 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 9 GCF_022137425.1 &lt;NA&gt; 100 1.21 5309865 44.8 118376 190 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; # ℹ 10 more variables: assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, mag_name &lt;chr&gt;, eha_number &lt;chr&gt;, source &lt;chr&gt;, # gtdb_taxonomy &lt;chr&gt;, ncbi_country &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, mimag_medium_quality &lt;lgl&gt;, # gtdb_representative &lt;lgl&gt; cluster3_MAGs &lt;- mags_by_cluster[[3]] genome_metadata %&gt;% filter(ID %in% cluster3_MAGs) # A tibble: 12 × 21 ID species completeness contamination genome_size GC N50 contigs host_species host_order host_class &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016582 s__Par… 92.2 1.17 3706610 45.7 7507 618 Strix aluco Strigifor… Aves 2 EHM039583 s__Par… 98.5 1.78 4472794 45 29681 243 Sciurus vul… Rodentia Mammalia 3 EHM048917 s__Par… 94.6 1.35 3837800 46 12164 428 Lepus europ… Lagomorpha Mammalia 4 EHM049446 s__Par… 90.1 0.6 3591722 46 12732 405 Lepus europ… Lagomorpha Mammalia 5 EHM070114 s__Par… 100.0 2.39 4728690 45 63727 110 Rattus ratt… Rodentia Mammalia 6 EHM075512 s__Par… 100.0 2.34 4690486 45 64909 112 Rattus ratt… Rodentia Mammalia 7 GCA_958447325.1 &lt;NA&gt; 100.0 0.61 4709435 45.0 118754 66 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 8 GCA_905196755.1 &lt;NA&gt; 100.0 1.05 4834487 44.9 124733 52 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 9 GCA_003539615.1 &lt;NA&gt; 99.9 0.5 4638787 45.3 82439 90 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 10 GCA_003534485.1 &lt;NA&gt; 100.0 2.3 4583939 45.1 102137 86 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 11 GCA_958435695.1 &lt;NA&gt; 100.0 1.06 4635291 45.0 106588 71 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 12 GCF_934668585.1 &lt;NA&gt; 99.0 0 4156980 45.5 26161 251 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; # ℹ 10 more variables: assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, mag_name &lt;chr&gt;, eha_number &lt;chr&gt;, source &lt;chr&gt;, # gtdb_taxonomy &lt;chr&gt;, ncbi_country &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, mimag_medium_quality &lt;lgl&gt;, # gtdb_representative &lt;lgl&gt; cluster4_MAGs &lt;- mags_by_cluster[[4]] genome_metadata %&gt;% filter(ID %in% cluster4_MAGs) # A tibble: 35 × 21 ID species completeness contamination genome_size GC N50 contigs host_species host_order host_class &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; 1 EHM016991 s__Par… 99.0 0.38 4748219 44.9 117248 76 Podarcis pi… Squamata Reptilia 2 EHM023585 s__Par… 92.8 2.18 3889519 45.6 8649 607 Sciurus vul… Rodentia Mammalia 3 EHM027637 s__Par… 93.5 2.05 4160022 45.3 12792 526 Cathartes a… Accipitri… Aves 4 EHM031743 s__Par… 93.5 1.99 4260825 45 21325 296 Canis famil… Carnivora Mammalia 5 EHM046460 s__Par… 99.5 1.66 4335884 45 38719 181 Cathartes a… Accipitri… Aves 6 EHM047216 s__Par… 99.9 1.04 4517903 45 63927 124 Lepus europ… Lagomorpha Mammalia 7 EHM064868 s__Par… 93.9 0.57 4141119 45 13237 435 Lepus europ… Lagomorpha Mammalia 8 EHM067538 s__Par… 93.1 1.71 4147480 46 12692 485 Lepus europ… Lagomorpha Mammalia 9 GCA_008679285.1 &lt;NA&gt; 96.0 1.54 4711604 45.1 307675 21 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; 10 GCA_934828805.1 &lt;NA&gt; 97.1 0.54 4665583 45.0 106519 67 &lt;NA&gt; &lt;NA&gt; &lt;NA&gt; # ℹ 25 more rows # ℹ 10 more variables: assembly_type &lt;chr&gt;, isolation_source &lt;chr&gt;, mag_name &lt;chr&gt;, eha_number &lt;chr&gt;, source &lt;chr&gt;, # gtdb_taxonomy &lt;chr&gt;, ncbi_country &lt;chr&gt;, mimag_high_quality &lt;lgl&gt;, mimag_medium_quality &lt;lgl&gt;, # gtdb_representative &lt;lgl&gt; metadata_with_cluster &lt;- genome_metadata %&gt;% left_join(coords %&gt;% dplyr::select(MAG, cluster), by = c(&quot;ID&quot; = &quot;MAG&quot;)) metadata_with_cluster %&gt;% group_by(cluster, source) %&gt;% summarise(n = n(), .groups = &quot;drop&quot;) %&gt;% arrange(cluster, desc(n)) # A tibble: 8 × 3 cluster source n &lt;fct&gt; &lt;chr&gt; &lt;int&gt; 1 1 GTDB 12 2 1 EHI 4 3 2 EHI 7 4 2 GTDB 2 5 3 EHI 6 6 3 GTDB 6 7 4 GTDB 27 8 4 EHI 8 # Group summaries metadata_with_cluster %&gt;% group_by(cluster) %&gt;% summarise(mean_genome_size = mean(genome_size, na.rm = TRUE), median_contamination = median(contamination, na.rm = TRUE), .groups = &quot;drop&quot;) # A tibble: 4 × 3 cluster mean_genome_size median_contamination &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; 1 1 4734489. 0.925 2 2 4604310. 1.21 3 3 4382252. 1.12 4 4 4505106. 0.65 Plots ggplot(metadata_with_cluster, aes(x = genome_size, y = GC, col = cluster))+ geom_point()+ theme_bw() ggplot(metadata_with_cluster, aes(x = assembly_type, y = source, col = cluster))+ geom_point()+ theme_bw() ggplot(metadata_with_cluster, aes(x = cluster, y = genome_size, col = cluster))+ geom_point()+ theme_bw() #Aggregate bundle-level GIFTs into the compound level GIFTs_elements &lt;- to.elements(genome_gifts,GIFT_db) #Aggregate element-level GIFTs into the function level GIFTs_functions &lt;- to.functions(GIFTs_elements,GIFT_db) #Aggregate function-level GIFTs into overall Biosynthesis, Degradation and Structural GIFTs GIFTs_domains &lt;- to.domains(GIFTs_functions,GIFT_db) GIFTs_elements %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;MAG&quot;)%&gt;% pivot_longer(!MAG,names_to=&quot;trait&quot;,values_to=&quot;gift&quot;) %&gt;% left_join(metadata_with_cluster, by = join_by(MAG == ID)) %&gt;% mutate(functionid = substr(trait, 1, 3)) %&gt;% mutate(trait = case_when( trait %in% GIFT_db$Code_element ~ GIFT_db$Element[match(trait, GIFT_db$Code_element)], TRUE ~ trait )) %&gt;% mutate(functionid = case_when( functionid %in% GIFT_db$Code_function ~ GIFT_db$Function[match(functionid, GIFT_db$Code_function)], TRUE ~ functionid )) %&gt;% mutate(trait=factor(trait,levels=unique(GIFT_db$Element))) %&gt;% mutate(functionid=factor(functionid,levels=unique(GIFT_db$Function))) %&gt;% ggplot(aes(x=MAG,y=trait,fill=gift)) + geom_tile(colour=&quot;white&quot;, linewidth=0.2)+ scale_fill_gradientn(colours=rev(c(&quot;#d53e4f&quot;, &quot;#f46d43&quot;, &quot;#fdae61&quot;, &quot;#fee08b&quot;, &quot;#e6f598&quot;, &quot;#abdda4&quot;, &quot;#ddf1da&quot;)))+ facet_grid(functionid ~ cluster, scales=&quot;free&quot;,space=&quot;free&quot;) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), axis.text.y = element_text(size=6), strip.text.y = element_text(angle = 0) ) + labs(y=&quot;Traits&quot;,x=&quot;Samples&quot;,fill=&quot;GIFT&quot;) library(RColorBrewer) library(reshape2) GIFTs_elements %&gt;% reshape2::melt() %&gt;% dplyr::rename(Genome = Var1, Code_element = Var2, GIFT = value) %&gt;% inner_join(GIFT_db,by=&quot;Code_element&quot;) %&gt;% ggplot(., aes(x=Code_element, y=Genome, fill=GIFT, group=Code_function))+ geom_tile()+ scale_y_discrete(guide = guide_axis(check.overlap = TRUE))+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+ scale_fill_gradientn(limits = c(0,1), colours=brewer.pal(7, &quot;YlGnBu&quot;))+ facet_grid(. ~ Code_function, scales = &quot;free&quot;, space = &quot;free&quot;)+ theme_grey(base_size=8)+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),strip.text.x = element_text(angle = 90)) Warning in inner_join(., GIFT_db, by = &quot;Code_element&quot;): Detected an unexpected many-to-many relationship between `x` and `y`. ℹ Row 577 of `x` matches multiple rows in `y`. ℹ Row 1 of `y` matches multiple rows in `x`. ℹ If a many-to-many relationship is expected, set `relationship = &quot;many-to-many&quot;` to silence this warning. head(GIFT_db) Code_bundle Code_element Code_function Domain Function Element 1 B010101 B0101 B01 Biosynthesis Nucleic acid biosynthesis Inosinic acid (IMP) 2 B010201 B0102 B01 Biosynthesis Nucleic acid biosynthesis Uridylic acid (UMP) 3 B010301 B0103 B01 Biosynthesis Nucleic acid biosynthesis UDP/UTP 4 B010401 B0104 B01 Biosynthesis Nucleic acid biosynthesis CDP/CTP 5 B010501 B0105 B01 Biosynthesis Nucleic acid biosynthesis ADP/ATP 6 B010601 B0106 B01 Biosynthesis Nucleic acid biosynthesis GDP/GTP Definition 1 K00764 (K01945,K11787,K11788,K13713) (K00601,K11175,K08289,K11787,K01492) (K01952,(K23269+K23264+K23265),(K23270+K23265)) (K01933,K11787,(K11788 (K01587,K11808,(K01589 K01588)))) (K01923,K01587,K13713) K01756 (K00602,(K01492,(K06863 K11176))) 2 (K11540,((K11541 K01465),((K01954,(K01955+K01956)) ((K00609+K00610),K00608) K01465))) (K00226,K00254,K17828) (K13421,(K00762 K01591)) 3 (K13800,K13809,K09903) 4 (K00940,K18533) K01937 5 K01939 K01756 (K00939,K18532,K18533,K00944) K00940 6 K00088 K01951 K00942 (K00940,K18533) GIFT_db%&gt;% filter(Code_function == &quot;D09&quot;) Code_bundle Code_element Code_function Domain Function Element 1 D090101 D0901 D09 Degradation Antibiotic degradation Penicillin 2 D090201 D0902 D09 Degradation Antibiotic degradation Carbapenem 3 D090301 D0903 D09 Degradation Antibiotic degradation Cephalosporin 4 D090401 D0904 D09 Degradation Antibiotic degradation Oxacillin 5 D090501 D0905 D09 Degradation Antibiotic degradation Streptogramin 6 D090601 D0906 D09 Degradation Antibiotic degradation Fosfomycin 7 D090701 D0907 D09 Degradation Antibiotic degradation Tetracycline 8 D090801 D0908 D09 Degradation Antibiotic degradation Macrolide 9 D091001 D0910 D09 Degradation Antibiotic degradation Chloramphenicol 10 D091101 D0911 D09 Degradation Antibiotic degradation Lincosamide 11 D091201 D0912 D09 Degradation Antibiotic degradation Streptothricin Definition 1 K18698,K18699,K18796,K18767,K18797,K19097,K19317,K18768,K18970,K19316,K22346,K18795,K19218,K19217,K17836,K18766 2 K17837,K18782,K18781,K18780,K19099,K19216 3 K19095,K19096,K19100,K19101,K19214,K19215,K20319,K20320,K01467 4 K17838,K18790,K18791,K19098,K18792,K19213,K21276,K18793,K18971,K22352,K19209,K18976,K18973,K18794,K18972,K21277,K19210,K19211,K19212,K22335,K19319,K22331,K22351,K19320,K19318,K19321,K19322,K21266,K22334,K22333,K22332 5 K19349,K19350 6 K21252 7 K08151,K08168,K18214,K18218,K18220,K18221 8 K06979,K08217,K18230,K18231,K21251 9 K00638,K08160,K18552,K18553,K18554,K19271 10 K18236,K19349,K19350,K19545 11 K19273,K20816 GIFTs_elements %&gt;% melt() %&gt;% dplyr::rename(Genome = Var1, Code_element = Var2, GIFT = value) %&gt;% inner_join(GIFT_db, by = &quot;Code_element&quot;) %&gt;% filter(str_starts(Code_element, &quot;D09&quot;)) %&gt;% # only antibiotic degradation left_join(metadata_with_cluster, by = join_by(Genome == ID)) %&gt;% mutate(cluster = factor(cluster)) %&gt;% droplevels() %&gt;% # Order genomes by cluster arrange(cluster, Genome) %&gt;% ggplot(aes(x = Code_element, y = Genome, fill = GIFT)) + geom_tile() + scale_y_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_fill_gradientn(limits = c(0,1), colours = brewer.pal(7, &quot;YlGnBu&quot;)) + facet_wrap(~ cluster, scales = &quot;free_y&quot;, ncol = 1) + theme_grey(base_size = 8) + theme( axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), strip.text.x = element_text(angle = 0) ) Warning in inner_join(., GIFT_db, by = &quot;Code_element&quot;): Detected an unexpected many-to-many relationship between `x` and `y`. ℹ Row 577 of `x` matches multiple rows in `y`. ℹ Row 1 of `y` matches multiple rows in `x`. ℹ If a many-to-many relationship is expected, set `relationship = &quot;many-to-many&quot;` to silence this warning. "],["antibiotic-resistance-analysis.html", "Chapter 11 Antibiotic resistance analysis 11.1 Building an AMR abundance table 11.2 PERMANOVA 11.3 PCoA 11.4 DESEq2 11.5 Wilcoxon", " Chapter 11 Antibiotic resistance analysis 11.0.1 Nº of MAGs with AMRs # AMR presence/absence amr_presence &lt;- genome_annotations %&gt;% filter(mag_id != &quot;GCA_015060925.1&quot;) %&gt;% # remove weird MAG filter(resistance_type == &quot;AMR&quot;) %&gt;% dplyr::select(mag_id, resistance_target) %&gt;% distinct() #Add the source info amr_with_source &lt;- amr_presence %&gt;% left_join( genome_metadata %&gt;% dplyr::select(ID, source), by = c(&quot;mag_id&quot; = &quot;ID&quot;) ) # Count how many MAGs in each AMR amr_mag_counts &lt;- amr_with_source %&gt;% group_by(source, resistance_target) %&gt;% summarise( n_mags = n(), .groups = &quot;drop&quot; ) #Count total MAGs per source (except the outlier) total_mags_per_source &lt;- genome_metadata %&gt;% filter(ID != &quot;GCA_015060925.1&quot;) %&gt;% group_by(source) %&gt;% summarise( total_mags = n_distinct(ID), .groups = &quot;drop&quot; ) #Calculate proportions of MAGs from each source in each AMR amr_mag_proportions &lt;- amr_mag_counts %&gt;% left_join(total_mags_per_source, by = &quot;source&quot;) %&gt;% mutate( proportion = n_mags / total_mags, absent = total_mags - n_mags ) 11.0.1.1 Statistical testing of MAG proportions fisher_results &lt;- amr_mag_proportions %&gt;% dplyr::select(resistance_target, source, n_mags, absent) %&gt;% pivot_wider( names_from = source, values_from = c(n_mags, absent), values_fill = 0 ) %&gt;% rowwise() %&gt;% mutate( p_value = fisher.test( matrix( c(n_mags_EHI, absent_EHI, n_mags_GTDB, absent_GTDB), nrow = 2, byrow = TRUE ) )$p.value ) %&gt;% ungroup() %&gt;% mutate(p_adj = p.adjust(p_value, method = &quot;BH&quot;)) fisher_results &lt;- fisher_results %&gt;% mutate( prop_EHI = n_mags_EHI / (n_mags_EHI + absent_EHI), prop_GTDB = n_mags_GTDB / (n_mags_GTDB + absent_GTDB), diff_prop = prop_GTDB - prop_EHI ) fisher_results%&gt;% filter(p_adj &lt; 0.05) # A tibble: 0 × 10 # ℹ 10 variables: resistance_target &lt;chr&gt;, n_mags_EHI &lt;int&gt;, n_mags_GTDB &lt;int&gt;, absent_EHI &lt;int&gt;, absent_GTDB &lt;int&gt;, # p_value &lt;dbl&gt;, p_adj &lt;dbl&gt;, prop_EHI &lt;dbl&gt;, prop_GTDB &lt;dbl&gt;, diff_prop &lt;dbl&gt; 11.1 Building an AMR abundance table # select the AMR annotations amr_abundance &lt;- genome_annotations %&gt;% filter(resistance_type == &quot;AMR&quot;) %&gt;% group_by(mag_id, resistance_target) %&gt;% summarise(count = n(), .groups=&quot;drop&quot;) %&gt;% tidyr::pivot_wider( names_from = resistance_target, values_from = count, values_fill = 0 ) amr_cluster &lt;- amr_abundance %&gt;% dplyr::full_join(metadata_with_cluster, by= join_by(mag_id == ID)) amr_cluster %&gt;% dplyr::select(&quot;BETA-LACTAM&quot;, &quot;MACROLIDE&quot;, mag_id, cluster) %&gt;% group_by( cluster) %&gt;% summarise(mean_beta_lactam = mean(`BETA-LACTAM`, na.rm = TRUE), mean_macrolide = mean(MACROLIDE, na.rm = TRUE)) # A tibble: 4 × 3 cluster mean_beta_lactam mean_macrolide &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; 1 1 10.4 14.4 2 2 10.6 16.1 3 3 9.27 14.6 4 4 9.5 14.9 amr_matrix &lt;- amr_abundance %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% as.matrix() # Abundance heatmap min_val &lt;- min(amr_matrix, na.rm = TRUE) max_val &lt;- max(amr_matrix, na.rm = TRUE) colors &lt;- viridis(100, option = &quot;viridis&quot;) breaks &lt;- seq(min_val, max_val, length.out = 101) pheatmap( amr_matrix, color = colors, cluster_rows = FALSE, cluster_cols = TRUE, fontsize = 9, border_color = NA ) #Scaled abundance heatmap amr_scaled &lt;- scale(amr_matrix, center = TRUE, scale = TRUE) min_val &lt;- min(amr_scaled, na.rm = TRUE) max_val &lt;- max(amr_scaled, na.rm = TRUE) colors &lt;- viridis(100, option = &quot;viridis&quot;) breaks &lt;- seq(min_val, max_val, length.out = 101) pheatmap( amr_scaled, color = colors, cluster_rows = FALSE, cluster_cols = TRUE, fontsize = 9, border_color = NA ) amr_presence &lt;- amr_abundance %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% mutate(across(everything(), ~ ifelse(. &gt; 0, 1, 0)))%&gt;% as.matrix() pheatmap( amr_presence, cluster_rows = TRUE, cluster_cols = TRUE, color = c(&quot;white&quot;, &quot;darkblue&quot;), # white = absent, black = present legend_breaks = c(0,1), legend_labels = c(&quot;Absent&quot;, &quot;Present&quot;), border_color = NA ) pheatmap( amr_presence, cluster_rows = FALSE, cluster_cols = TRUE, color = c(&quot;white&quot;, &quot;darkblue&quot;), # white = absent, black = present legend_breaks = c(0,1), legend_labels = c(&quot;Absent&quot;, &quot;Present&quot;), border_color = NA ) 11.2 PERMANOVA amr_counts &lt;- genome_annotations %&gt;% filter(mag_id != &quot;GCA_015060925.1&quot;) %&gt;% filter(resistance_type == &quot;AMR&quot;) %&gt;% dplyr::count(mag_id, resistance_target) %&gt;% pivot_wider(names_from = resistance_target, values_from = n, values_fill = 0) %&gt;% filter(rowSums(dplyr::select(., -mag_id)) &gt; 0) # Removes MAGs with no AMR genes found # Fixed normalization amr_rel &lt;- amr_counts %&gt;% column_to_rownames(&quot;mag_id&quot;) amr_rel &lt;- amr_rel / rowSums(amr_rel) # Each row sums to 1 # Remove zero variance amr_rel_nz &lt;- amr_rel[, apply(amr_rel, 2, sd) &gt; 0] # Distance matrix from normalized data amr_dist &lt;- vegdist(amr_rel_nz, method = &quot;bray&quot;) # or euclidean # Add metadata amr_rel_nz_meta &lt;- amr_rel_nz %&gt;% rownames_to_column(&quot;ID&quot;) %&gt;% left_join(genome_metadata, by = &quot;ID&quot;) #Beta dispersion test dispersion &lt;- betadisper(amr_dist, amr_rel_nz_meta$source) anova(dispersion) Analysis of Variance Table Response: Distances Df Sum Sq Mean Sq F value Pr(&gt;F) Groups 1 0.001863 0.00186304 13.53 0.0003971 *** Residuals 91 0.012530 0.00013769 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # PERMANOVA test permanova_result &lt;- adonis2(amr_dist ~ source, data = amr_rel_nz_meta, permutations = 999) print(permanova_result) Permutation test for adonis under reduced model Permutation: free Number of permutations: 999 adonis2(formula = amr_dist ~ source, data = amr_rel_nz_meta, permutations = 999) Df SumOfSqs R2 F Pr(&gt;F) Model 1 0.010991 0.07336 7.2039 0.001 *** Residual 91 0.138842 0.92664 Total 92 0.149834 1.00000 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # PERMANOVA test accounting for genome size adonis2( amr_dist ~ genome_size + source, data = amr_rel_nz_meta, permutations = 999, by = &quot;margin&quot; ) Permutation test for adonis under reduced model Marginal effects of terms Permutation: free Number of permutations: 999 adonis2(formula = amr_dist ~ genome_size + source, data = amr_rel_nz_meta, permutations = 999, by = &quot;margin&quot;) Df SumOfSqs R2 F Pr(&gt;F) genome_size 1 0.022563 0.15058 17.4633 0.001 *** source 1 0.002794 0.01865 2.1629 0.041 * Residual 90 0.116280 0.77606 Total 92 0.149834 1.00000 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # remove zero-variance KOs amr_pa_nz &lt;- amr_presence[, colSums(amr_presence) &gt; 0 &amp; colSums(amr_presence) &lt; nrow(amr_presence)] meta &lt;- genome_metadata %&gt;% filter(ID %in% rownames(amr_pa_nz)) %&gt;% column_to_rownames(&quot;ID&quot;) # VERY IMPORTANT: enforce same order meta &lt;- meta[rownames(amr_pa_nz), ] stopifnot(identical(rownames(meta), rownames(amr_pa_nz))) amr_dist_pa &lt;- vegdist(amr_pa_nz, method = &quot;jaccard&quot;, binary = TRUE) # dispersion check disp_pa &lt;- betadisper(amr_dist_pa, meta$source) Warning in betadisper(amr_dist_pa, meta$source): some squared distances are negative and changed to zero anova(disp_pa) Analysis of Variance Table Response: Distances Df Sum Sq Mean Sq F value Pr(&gt;F) Groups 1 0.00578 0.0057817 0.664 0.4173 Residuals 92 0.80109 0.0087075 # PERMANOVA adonis2( amr_dist_pa ~ genome_size +completeness+ source, data = meta, permutations = 999 ) Permutation test for adonis under reduced model Permutation: free Number of permutations: 999 adonis2(formula = amr_dist_pa ~ genome_size + completeness + source, data = meta, permutations = 999) Df SumOfSqs R2 F Pr(&gt;F) Model 3 0.3142 0.09695 3.2207 0.001 *** Residual 90 2.9271 0.90305 Total 93 3.2413 1.00000 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 11.3 PCoA pcoa_pa &lt;- cmdscale(amr_dist_pa, eig = TRUE, k = 2) pcoa_df &lt;- data.frame( ID = rownames(amr_pa_nz), PC1 = pcoa_pa$points[,1], PC2 = pcoa_pa$points[,2], source = meta$source ) %&gt;% left_join(genome_metadata, by = &quot;ID&quot;) ggplot(pcoa_df, aes(PC1, PC2, color = source.x, label = ID)) + geom_point(size = 2) + scale_color_manual(values = source_colors) + theme_minimal() + labs( title = &quot;PCoA of AMR annotations across MAGs&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) )+ geom_text() ggplot(pcoa_df, aes(PC1, PC2, color = completeness)) + geom_point(size = 3, alpha = 0.8) + theme_classic() ggplot(pcoa_df, aes(PC1, PC2, color = continent)) + geom_point(size = 3, alpha = 0.8) + theme_classic() pcoa_res &lt;- cmdscale(amr_dist, k = 2, eig = TRUE) # Calculate variance explained from PCoA eigenvalues variance_explained &lt;- pcoa_res$eig / sum(pcoa_res$eig) pcoa_df &lt;- data.frame( PC1 = pcoa_res$points[,1], PC2 = pcoa_res$points[,2], ID = rownames(amr_rel_nz) ) %&gt;% left_join(metadata_with_cluster, by = &quot;ID&quot;) ggplot(pcoa_df, aes(PC1, PC2, color = source)) + geom_point(size = 2) + scale_color_manual(values = source_colors) + theme_minimal() + labs( title = &quot;PCoA of AMR annotations across MAGs&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = cluster)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of AMR annotations across MAGs colored by GIFT clustering&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = genome_size)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of AMR annotations across MAGs&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = completeness)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of AMR annotations across MAGs&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = continent)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of AMR annotations across MAGs&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) cat(&quot;MAGs with AMR genes:&quot;, nrow(amr_rel_nz), &quot;\\n&quot;) MAGs with AMR genes: 93 cat(&quot;Total AMR genes detected:&quot;, ncol(amr_rel_nz), &quot;\\n&quot;) Total AMR genes detected: 47 11.4 DESEq2 library(DESeq2) # Prepare the count matrix (AMR_Targets as rows, MAGs as columns) # Ensure only integer columns are kept counts_mtx &lt;- amr_counts %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% t() # Prepare metadata (Must match column names of counts_mtx) metadata &lt;- genome_metadata %&gt;% filter(ID %in% colnames(counts_mtx)) %&gt;% column_to_rownames(&quot;ID&quot;) # Ensure order matches exactly metadata &lt;- metadata[colnames(counts_mtx), , drop = FALSE] #Create DESeq2 object dds &lt;- DESeqDataSetFromMatrix(countData = counts_mtx, colData = metadata, design = ~ source) Warning in DESeqDataSet(se, design = design, ignoreRank): some variables in design formula are characters, converting to factors #Run initial steps manually instead of using DESeq() dds &lt;- estimateSizeFactors(dds) dds &lt;- estimateDispersionsGeneEst(dds) dispersions(dds) &lt;- mcols(dds)$dispGeneEst # Force the use of gene-wise estimates # Run the Wald test dds &lt;- nbinomWaldTest(dds) # save results (Wildlife vs Human) res &lt;- results(dds, contrast=c(&quot;source&quot;, &quot;EHI&quot;, &quot;GTDB&quot;), alpha=0.05) summary(res) out of 47 with nonzero total read count adjusted p-value &lt; 0.05 LFC &gt; 0 (up) : 0, 0% LFC &lt; 0 (down) : 1, 2.1% outliers [1] : 0, 0% low counts [2] : 0, 0% (mean count &lt; 0) [1] see &#39;cooksCutoff&#39; argument of ?results [2] see &#39;independentFiltering&#39; argument of ?results res_df &lt;-res %&gt;% as.data.frame %&gt;% rownames_to_column(&quot;AMR_Target&quot;) %&gt;% as_tibble res_df &lt;- filter(res_df, padj&lt;0.05) 11.5 Wilcoxon wilcox_amr &lt;- amr_rel_nz_meta %&gt;% pivot_longer( cols = where(is.numeric), names_to = &quot;AMR_Target&quot;, values_to = &quot;rel_abundance&quot; ) %&gt;% group_by(AMR_Target) %&gt;% do(broom::tidy(wilcox.test(rel_abundance ~ source, data = .))) %&gt;% ungroup() # Adjust p-values wilcox_amr_results &lt;- wilcox_amr %&gt;% mutate(p.adj = p.adjust(p.value, method = &quot;fdr&quot;)) %&gt;% filter(p.adj &lt; 0.05) %&gt;% arrange(p.adj) wilcox_amr_results # A tibble: 19 × 6 AMR_Target statistic p.value method alternative p.adj &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; 1 N50 225 0.0000000981 Wilcox… two.sided 5.20e-6 2 contigs 1386 0.000000624 Wilcox… two.sided 1.65e-5 3 genome_size 348 0.0000139 Wilcox… two.sided 2.45e-4 4 LINCOSAMIDE 1318. 0.0000515 Wilcox… two.sided 5.46e-4 5 STREPTOGRAMIN 380. 0.0000482 Wilcox… two.sided 5.46e-4 6 COLISTIN 1265 0.000326 Wilcox… two.sided 2.02e-3 7 LINCOSAMIDE/MACROLIDE/STREPTOGRAMIN 1272 0.000258 Wilcox… two.sided 2.02e-3 8 METHICILLIN 1265 0.000327 Wilcox… two.sided 2.02e-3 9 SULFONAMIDE 1264. 0.000342 Wilcox… two.sided 2.02e-3 10 TRIMETHOPRIM 1248. 0.000577 Wilcox… two.sided 3.06e-3 11 AVILAMYCIN 1241 0.000710 Wilcox… two.sided 3.41e-3 12 NITROIMIDAZOLE 1236. 0.000819 Wilcox… two.sided 3.41e-3 13 OLEANDOMYCIN 986 0.000837 Wilcox… two.sided 3.41e-3 14 CHLORAMPHENICOL 486 0.00163 Wilcox… two.sided 6.17e-3 15 FLORFENICOL/OXAZOLIDINONE 1179 0.00440 Wilcox… two.sided 1.50e-2 16 TIGECYCLINE 1178 0.00453 Wilcox… two.sided 1.50e-2 17 RIFAMYCIN 1166 0.00624 Wilcox… two.sided 1.95e-2 18 THIOSTREPTON 1154. 0.00839 Wilcox… two.sided 2.47e-2 19 AZITHROMYCIN/CLINDAMYCIN/ERYTHROMYCIN/STREPTOGRAMIN B/VIRGINIAMYCIN 1050. 0.0159 Wilcox… two.sided 4.43e-2 #amr frequency amr_frequency &lt;- amr_rel_nz_meta %&gt;% dplyr::select(source, all_of(wilcox_amr_results$AMR_Target)) %&gt;% pivot_longer(-source, names_to = &quot;AMR_Target&quot;, values_to = &quot;val&quot;) %&gt;% group_by(AMR_Target, source) %&gt;% summarise(percent_presence = mean(val &gt; 0) * 100, .groups = &#39;drop&#39;) ggplot(amr_frequency, aes(x = AMR_Target, y = percent_presence, fill = source)) + geom_bar(stat = &quot;identity&quot;, position = &quot;dodge&quot;) + coord_flip() scale_fill_manual(values = source_colors) + theme_minimal() + labs(title = &quot;Prevalence of AMR Genes: Human vs Wildlife&quot;, y = &quot;% of MAGs carrying the gene&quot;, x = &quot;&quot;) # Filter data to only include the common KOs common_AMR_Target &lt;- (wilcox_amr_results$AMR_Target) plot_data &lt;- amr_rel_nz_meta %&gt;% dplyr::select(ID, source, all_of(common_AMR_Target)) %&gt;% pivot_longer(cols = all_of(common_AMR_Target), names_to = &quot;AMR_Target&quot;, values_to = &quot;Relative_Abundance&quot;) ggplot(plot_data, aes(x = source, y = Relative_Abundance, fill = source)) + geom_boxplot(outlier.shape = NA) + geom_jitter(width = 0.2, alpha = 0.4, size = 1) + facet_wrap(~AMR_Target, scales = &quot;free_y&quot;, ncol = 5) + # &#39;free_y&#39; is important as abundance scales vary scale_fill_manual(values = source_colors) + theme_minimal() + theme(strip.text = element_text(face = &quot;bold&quot;), legend.position = &quot;bottom&quot;) + labs(title = &quot;Relative Abundance of Consensus Significant AMR Targets&quot;, x = &quot;Host Source&quot;, y = &quot;Relative Abundance&quot;) Warning: Removed 4 rows containing non-finite outside the scale range (`stat_boxplot()`). Warning: Removed 4 rows containing missing values or values outside the scale range (`geom_point()`). amr_binary &lt;- amr_counts %&gt;% left_join(genome_metadata %&gt;% dplyr::select(ID, source), by = c(&quot;mag_id&quot; = &quot;ID&quot;)) %&gt;% # Convert all numeric columns to 0 or 1 mutate(across(where(is.numeric), ~ ifelse(.x &gt; 0, 1, 0))) #Function to run Fischer test for each gene run_fisher &lt;- function(gene_name, df) { tab &lt;- table(df$source, df[[gene_name]]) # Only run if the table is actually 2x2 if(ncol(tab) == 2) { test &lt;- fisher.test(tab) return(tidy(test) %&gt;% mutate(AMR_Target = gene_name)) } else { return(NULL) } } # Apply the function to all AMR columns amr_names &lt;- colnames(amr_counts)[-1] # everything except mag_id fisher_results &lt;- map_df(amr_names, ~ run_fisher(.x, amr_binary)) # Adjust for multiple testing (FDR) fisher_results &lt;- fisher_results %&gt;% mutate(p.adj = p.adjust(p.value, method = &quot;fdr&quot;)) %&gt;% #filter(p.adj &lt; 0.05) %&gt;% arrange(p.adj) print(fisher_results) # A tibble: 25 × 8 estimate p.value conf.low conf.high method alternative AMR_Target p.adj &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; 1 0 0.00433 0 0.516 Fisher&#39;s Exact Test for Count Data two.sided OLEANDOMYCIN 0.108 2 6.13 0.0428 0.814 72.5 Fisher&#39;s Exact Test for Count Data two.sided AMINOGLYCOSIDE 0.309 3 0.348 0.0495 0.108 1.13 Fisher&#39;s Exact Test for Count Data two.sided AZITHROMYCIN/CLINDAMYCIN/ERY… 0.309 4 7.88 0.0350 1.10 347. Fisher&#39;s Exact Test for Count Data two.sided CLINDAMYCIN/MACROLIDE/STREPT… 0.309 5 0.425 0.104 0.137 1.34 Fisher&#39;s Exact Test for Count Data two.sided CEPHALOSPORIN 0.522 6 5.69 0.175 0.284 348. Fisher&#39;s Exact Test for Count Data two.sided BLEOMYCIN 0.632 7 Inf 0.269 0.0697 Inf Fisher&#39;s Exact Test for Count Data two.sided TRIMETHOPRIM 0.632 8 0.555 0.278 0.178 1.80 Fisher&#39;s Exact Test for Count Data two.sided AMIKACIN/KANAMYCIN/TOBRAMYCIN 0.632 9 3.62 0.278 0.457 167. Fisher&#39;s Exact Test for Count Data two.sided CLARITHROMYCIN 0.632 10 3.62 0.278 0.457 167. Fisher&#39;s Exact Test for Count Data two.sided STREPTOMYCIN 0.632 # ℹ 15 more rows library(ALDEx2) # Prepare count matrix for ALDEx2 (raw counts, not normalized) amr_counts_aldex &lt;- amr_counts %&gt;% column_to_rownames(&quot;mag_id&quot;) # Transpose for ALDEx2 (features as rows, samples as columns) amr_counts_t &lt;- t(amr_counts_aldex) # Remove features with zero counts across all samples amr_counts_t &lt;- amr_counts_t[rowSums(amr_counts_t) &gt; 0, ] # Create conditions vector matching column order conditions &lt;- genome_metadata %&gt;% filter(ID %in% colnames(amr_counts_t)) %&gt;% arrange(match(ID, colnames(amr_counts_t))) %&gt;% pull(source) # Run ALDEx2 set.seed(123) aldex_amr &lt;- aldex.clr(amr_counts_t, conditions, mc.samples = 128, denom = &quot;all&quot;) conditions vector supplied operating in serial mode computing center with all features aldex_amr_test &lt;- aldex.ttest(aldex_amr, paired.test = FALSE) aldex_amr_effect &lt;- aldex.effect(aldex_amr, CI = TRUE) operating in serial mode sanity check complete rab.all complete rab.win complete rab of samples complete within sample difference calculated between group difference calculated group summaries calculated unpaired effect size calculated summarizing output # Combine results aldex_amr_results &lt;- data.frame(aldex_amr_test, aldex_amr_effect) %&gt;% rownames_to_column(&quot;AMR_gene&quot;) %&gt;% arrange(wi.eBH) # Significant AMR genes (FDR &lt; 0.05) significant_amr &lt;- aldex_amr_results %&gt;% filter(wi.eBH &lt; 0.05) %&gt;% mutate(enriched_in = ifelse(effect &gt; 0, levels(factor(conditions))[2], levels(factor(conditions))[1])) cat(&quot;\\nSignificant AMR genes:&quot;, nrow(significant_amr), &quot;\\n&quot;) Significant AMR genes: 0 print(significant_amr) [1] AMR_gene we.ep we.eBH wi.ep wi.eBH rab.all rab.win.EHI rab.win.GTDB diff.btw [10] diff.win effect effect.low effect.high overlap enriched_in &lt;0 rows&gt; (o 0- extensión row.names) # Visualization ggplot(aldex_amr_results, aes(x = effect, y = -log10(wi.eBH))) + geom_point(aes(color = wi.eBH &lt; 0.05), alpha = 0.6) + scale_color_manual(values = c(&quot;grey&quot;, &quot;red&quot;)) + geom_hline(yintercept = -log10(0.05), linetype = &quot;dashed&quot;) + theme_minimal() + labs( title = &quot;ALDEx2 results for AMR genes&quot;, x = &quot;Effect size&quot;, y = &quot;-log10(BH-adjusted p-value)&quot;, color = &quot;Significant&quot; ) "],["virulence-factors-analysis.html", "Chapter 12 Virulence factors analysis 12.1 Building an virulence factor abundance table", " Chapter 12 Virulence factors analysis 12.0.1 Nº of MAGs with VFs # AMR presence/absence vf_presence &lt;- genome_annotations %&gt;% filter(mag_id != &quot;GCA_015060925.1&quot;) %&gt;% # remove weird MAG filter(!is.na(vf)) %&gt;% dplyr::select(mag_id, vf) %&gt;% distinct() #Add the source info vf_with_source &lt;- vf_presence %&gt;% left_join( genome_metadata %&gt;% dplyr::select(ID, source), by = c(&quot;mag_id&quot; = &quot;ID&quot;) ) # Count how many MAGs in each vf vf_mag_counts &lt;- vf_with_source %&gt;% group_by(source, vf) %&gt;% summarise( n_mags = n(), .groups = &quot;drop&quot; ) #Count total MAGs per source (except the outlier) total_mags_per_source &lt;- genome_metadata %&gt;% filter(ID != &quot;GCA_015060925.1&quot;) %&gt;% group_by(source) %&gt;% summarise( total_mags = n_distinct(ID), .groups = &quot;drop&quot; ) #Calculate proportions of MAGs from each source in each vf vf_mag_proportions &lt;- vf_mag_counts %&gt;% left_join(total_mags_per_source, by = &quot;source&quot;) %&gt;% mutate( proportion = n_mags / total_mags, absent = total_mags - n_mags ) 12.0.1.1 Statistical testing of MAG proportions fisher_results &lt;- vf_mag_proportions %&gt;% dplyr::select(vf, source, n_mags, absent) %&gt;% pivot_wider( names_from = source, values_from = c(n_mags, absent), values_fill = 0 ) %&gt;% rowwise() %&gt;% mutate( p_value = fisher.test( matrix( c(n_mags_EHI, absent_EHI, n_mags_GTDB, absent_GTDB), nrow = 2, byrow = TRUE ) )$p.value ) %&gt;% ungroup() %&gt;% mutate(p_adj = p.adjust(p_value, method = &quot;BH&quot;)) fisher_results &lt;- fisher_results %&gt;% mutate( prop_EHI = n_mags_EHI / (n_mags_EHI + absent_EHI), prop_GTDB = n_mags_GTDB / (n_mags_GTDB + absent_GTDB), diff_prop = prop_GTDB - prop_EHI ) fisher_results%&gt;% filter(p_adj &lt; 0.05) # A tibble: 1 × 10 vf n_mags_EHI n_mags_GTDB absent_EHI absent_GTDB p_value p_adj prop_EHI prop_GTDB diff_prop &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; 1 VF0369 2 39 23 29 0.0000128 0.00443 0.08 0.574 0.494 12.1 Building an virulence factor abundance table vf_data &lt;- genome_annotations %&gt;% dplyr::select(mag_id, vf, vf_type) vf_abundance &lt;- genome_annotations %&gt;% dplyr::select(mag_id, vf) %&gt;% group_by(mag_id, vf) %&gt;% summarise(count = n(), .groups=&quot;drop&quot;) %&gt;% tidyr::pivot_wider( names_from = vf, values_from = count, values_fill = 0 ) dim(vf_abundance) [1] 94 355 vf_cluster &lt;- vf_abundance %&gt;% dplyr::full_join(genome_metadata, by= join_by(mag_id == ID)) # make into a matrix vf_matrix &lt;- vf_abundance %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% as.matrix() # Unscaled abundance heatmap pheatmap(vf_matrix, color = viridis(100, option = &quot;viridis&quot;), cluster_rows = FALSE, cluster_cols = TRUE, fontsize = 9, border_color = NA ) # For scaled heatmap -&gt; remove zero variance columns col_vars &lt;- apply(vf_matrix, 2, var, na.rm = TRUE) vf_matrix_filtered &lt;- vf_matrix[, col_vars &gt; 0 &amp; !is.na(col_vars)] # Scale the filtered matrix vf_scaled &lt;- scale(vf_matrix_filtered, center = TRUE, scale = TRUE) # Check for any remaining Inf/NaN values if(any(!is.finite(vf_scaled))) { vf_scaled[!is.finite(vf_scaled)] &lt;- 0 # Replace Inf/NaN with 0 } # Scaled heatmap pheatmap(vf_scaled, color = viridis(100, option = &quot;viridis&quot;), cluster_rows = FALSE, cluster_cols = TRUE, fontsize = 5, border_color = NA ) ## Virulence presence/absence heatmap vf_presence &lt;- vf_abundance %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% mutate(across(everything(), ~ ifelse(. &gt; 0, 1, 0)))%&gt;% as.matrix() pheatmap( vf_presence, cluster_rows = FALSE, cluster_cols = TRUE, color = c(&quot;white&quot;, &quot;darkblue&quot;), legend_breaks = c(0,1), legend_labels = c(&quot;Absent&quot;, &quot;Present&quot;), border_color = NA ) vf_counts &lt;- genome_annotations %&gt;% filter(mag_id != &quot;GCA_015060925.1&quot;) %&gt;% filter(!is.na(vf)) %&gt;% dplyr::count(mag_id, vf) %&gt;% pivot_wider(names_from = vf, values_from = n, values_fill = 0) %&gt;% filter(rowSums(dplyr::select(., -mag_id)) &gt; 0) # Removes MAGs with no vf genes found # Fixed normalization vf_rel &lt;- vf_counts %&gt;% column_to_rownames(&quot;mag_id&quot;) vf_rel &lt;- vf_rel / rowSums(vf_rel) # Each row sums to 1 # Remove zero variance vf_rel_nz &lt;- vf_rel[, apply(vf_rel, 2, sd) &gt; 0] # Distance matrix from normalized data vf_dist &lt;- vegdist(vf_rel_nz, method = &quot;bray&quot;) # or euclidean # Add metadata vf_rel_nz_meta &lt;- vf_rel_nz %&gt;% rownames_to_column(&quot;ID&quot;) %&gt;% left_join(genome_metadata, by = &quot;ID&quot;) #Beta dispersion test dispersion &lt;- betadisper(vf_dist, vf_rel_nz_meta$source) anova(dispersion) Analysis of Variance Table Response: Distances Df Sum Sq Mean Sq F value Pr(&gt;F) Groups 1 0.007148 0.0071483 16.317 0.0001117 *** Residuals 91 0.039866 0.0004381 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # PERMANOVA test permanova_result &lt;- adonis2(vf_dist ~ source, data = vf_rel_nz_meta, permutations = 999) print(permanova_result) Permutation test for adonis under reduced model Permutation: free Number of permutations: 999 adonis2(formula = vf_dist ~ source, data = vf_rel_nz_meta, permutations = 999) Df SumOfSqs R2 F Pr(&gt;F) Model 1 0.05742 0.08119 8.0412 0.001 *** Residual 91 0.64983 0.91881 Total 92 0.70725 1.00000 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # PERMANOVA test accounting for genome size adonis2( vf_dist ~ genome_size + source, data = vf_rel_nz_meta, permutations = 999, by = &quot;margin&quot; ) Permutation test for adonis under reduced model Marginal effects of terms Permutation: free Number of permutations: 999 adonis2(formula = vf_dist ~ genome_size + source, data = vf_rel_nz_meta, permutations = 999, by = &quot;margin&quot;) Df SumOfSqs R2 F Pr(&gt;F) genome_size 1 0.10339 0.14619 17.0294 0.001 *** source 1 0.00984 0.01392 1.6211 0.085 . Residual 90 0.54644 0.77262 Total 92 0.70725 1.00000 --- Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 pcoa_res &lt;- cmdscale(vf_dist, k = 2, eig = TRUE) # Calculate variance explained from PCoA eigenvalues variance_explained &lt;- pcoa_res$eig / sum(pcoa_res$eig) pcoa_df &lt;- data.frame( PC1 = pcoa_res$points[,1], PC2 = pcoa_res$points[,2], ID = rownames(vf_rel_nz) ) %&gt;% left_join(metadata_with_cluster, by = &quot;ID&quot;) ggplot(pcoa_df, aes(PC1, PC2, color = source)) + scale_color_manual(values = source_colors) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of VF annotations across MAGs&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = genome_size)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of VF annotations across MAGs&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = cluster)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of VF annotations across MAGs colored by GIFT cluster&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = completeness)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of VF annotations across MAGs colored by GIFT cluster&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = country)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of VF annotations across MAGs colored by GIFT country&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) ggplot(pcoa_df, aes(PC1, PC2, color = continent)) + geom_point(size = 2) + theme_minimal() + labs( title = &quot;PCoA of VF annotations across MAGs colored by GIFT continent&quot;, x = paste0(&quot;PCoA1 (&quot;, round(variance_explained[1] * 100, 1), &quot;%)&quot;), y = paste0(&quot;PCoA2 (&quot;, round(variance_explained[2] * 100, 1), &quot;%)&quot;) ) # Prepare count matrix for ALDEx2 (raw counts, not normalized) vf_counts_aldex &lt;- vf_counts %&gt;% column_to_rownames(&quot;mag_id&quot;) # Transpose for ALDEx2 (features as rows, samples as columns) vf_counts_t &lt;- t(vf_counts_aldex) # Remove features with zero counts across all samples vf_counts_t &lt;- vf_counts_t[rowSums(vf_counts_t) &gt; 0, ] # Create conditions vector matching column order conditions &lt;- genome_metadata %&gt;% filter(ID %in% colnames(vf_counts_t)) %&gt;% arrange(match(ID, colnames(vf_counts_t))) %&gt;% pull(source) # Run ALDEx2 set.seed(123) aldex_vf &lt;- aldex.clr(vf_counts_t, conditions, mc.samples = 128, denom = &quot;all&quot;) conditions vector supplied operating in serial mode computing center with all features aldex_vf_test &lt;- aldex.ttest(aldex_vf, paired.test = FALSE) aldex_vf_effect &lt;- aldex.effect(aldex_vf, CI = TRUE) operating in serial mode sanity check complete rab.all complete rab.win complete rab of samples complete within sample difference calculated between group difference calculated group summaries calculated unpaired effect size calculated summarizing output # Combine results aldex_vf_results &lt;- data.frame(aldex_vf_test, aldex_vf_effect) %&gt;% rownames_to_column(&quot;vf_gene&quot;) %&gt;% arrange(wi.eBH) # Significant vf genes (FDR &lt; 0.05) significant_vf &lt;- aldex_vf_results %&gt;% filter(wi.eBH &lt; 0.05) %&gt;% mutate(enriched_in = ifelse(effect &gt; 0, levels(factor(conditions))[2], levels(factor(conditions))[1])) cat(&quot;\\nSignificant vf genes:&quot;, nrow(significant_vf), &quot;\\n&quot;) Significant vf genes: 0 print(significant_vf) [1] vf_gene we.ep we.eBH wi.ep wi.eBH rab.all rab.win.EHI rab.win.GTDB diff.btw [10] diff.win effect effect.low effect.high overlap enriched_in &lt;0 rows&gt; (o 0- extensión row.names) # Visualization ggplot(aldex_vf_results, aes(x = effect, y = -log10(wi.eBH))) + geom_point(aes(color = wi.eBH &lt; 0.05), alpha = 0.6) + scale_color_manual(values = c(&quot;grey&quot;, &quot;red&quot;)) + geom_hline(yintercept = -log10(0.05), linetype = &quot;dashed&quot;) + theme_minimal() + labs( title = &quot;ALDEx2 results for vf genes&quot;, x = &quot;Effect size&quot;, y = &quot;-log10(BH-adjusted p-value)&quot;, color = &quot;Significant&quot; ) # CAZY cazy_genes &lt;- genome_annotations %&gt;% filter(!is.na(cazy)) %&gt;% nrow() cazy_genes [1] 31321 cazy_abundance &lt;- genome_annotations %&gt;% filter(!is.na(cazy)) %&gt;% group_by(mag_id, cazy) %&gt;% summarise(count = n(), .groups=&quot;drop&quot;) %&gt;% tidyr::pivot_wider( names_from = cazy, values_from = count, values_fill = 0 ) cazy_matrix &lt;- cazy_abundance %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% as.matrix() # Abundance heatmap min_val &lt;- min(cazy_matrix, na.rm = TRUE) max_val &lt;- max(cazy_matrix, na.rm = TRUE) colors &lt;- viridis(100, option = &quot;viridis&quot;) breaks &lt;- seq(min_val, max_val, length.out = 101) pheatmap( cazy_matrix, color = colors, cluster_rows = FALSE, cluster_cols = TRUE, fontsize = 9, border_color = NA ) #Scaled abundance heatmap cazy_scaled &lt;- scale(cazy_matrix, center = TRUE, scale = TRUE) min_val &lt;- min(cazy_scaled, na.rm = TRUE) max_val &lt;- max(cazy_scaled, na.rm = TRUE) colors &lt;- viridis(100, option = &quot;viridis&quot;) breaks &lt;- seq(min_val, max_val, length.out = 101) "],["antibiotic-resistance-analysis-human.html", "Chapter 13 Antibiotic resistance analysis (HUMAN) 13.1 Building an AMR abundance table", " Chapter 13 Antibiotic resistance analysis (HUMAN) 13.1 Building an AMR abundance table amr_abundance &lt;- genome_annotations %&gt;% filter(resistance_type == &quot;AMR&quot;) %&gt;% group_by(mag_id, resistance_target) %&gt;% summarise(count = n(), .groups=&quot;drop&quot;) %&gt;% tidyr::pivot_wider( names_from = resistance_target, values_from = count, values_fill = 0 ) amr_cluster &lt;- amr_abundance %&gt;% dplyr::full_join(metadata_with_cluster, by= join_by(mag_id == ID)) amr_matrix &lt;- amr_abundance %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% as.matrix() min_val &lt;- 0 max_val &lt;- max(amr_matrix, na.rm = TRUE) library(viridis) colors &lt;- viridis(100, option = &quot;viridis&quot;) breaks &lt;- seq(min_val, max_val, length.out = 101) pheatmap( amr_matrix, color = colors, cluster_rows = TRUE, cluster_cols = TRUE, fontsize = 9, border_color = NA ) amr_scaled &lt;- scale(amr_matrix, center = TRUE, scale = TRUE) min_val &lt;- 0 max_val &lt;- max(amr_scaled, na.rm = TRUE) library(viridis) colors &lt;- viridis(100, option = &quot;viridis&quot;) breaks &lt;- seq(min_val, max_val, length.out = 101) pheatmap( amr_scaled, color = colors, cluster_rows = TRUE, cluster_cols = TRUE, fontsize = 9, border_color = NA ) amr_presence &lt;- amr_abundance %&gt;% column_to_rownames(&quot;mag_id&quot;) %&gt;% mutate(across(everything(), ~ ifelse(. &gt; 0, 1, 0)))%&gt;% as.matrix() pheatmap( amr_presence, cluster_rows = TRUE, cluster_cols = TRUE, color = c(&quot;white&quot;, &quot;black&quot;), # white = absent, black = present legend_breaks = c(0,1), legend_labels = c(&quot;Absent&quot;, &quot;Present&quot;), border_color = NA ) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
