# EHI MAGs exploration

### EHI MAGs
```{r load data preparation}
load("data/data.Rdata")
```


```{r load ehi mags}
library(tidyverse)
ehi_mags <- read_csv("data/ehi_metadata_location.csv")
colnames(ehi_mags)
```
Check contamination and completeness
```{r contamination and completeness}
genome_biplot <- ehi_mags %>%
  dplyr::select(c(phylum,completeness,contamination,size)) %>%
  ggplot(aes(x=completeness,y=contamination,size=size,color=phylum)) +
              geom_point(alpha=0.7) +
                    xlim(c(70,100)) +
                    ylim(c(10,0)) +
                    scale_color_manual(values=phylum_colors) +
                    labs(y= "Contamination", x = "Completeness") +
                    theme_classic() +
                    theme(legend.position = "none")

#Generate contamination boxplot
genome_contamination <- ehi_mags %>%
            ggplot(aes(y=contamination)) +
                    ylim(c(10,0)) +
                    geom_boxplot(colour = "#999999", fill="#cccccc") +
                    theme_classic() +
                    theme(legend.position = "none",
                    axis.line = element_blank(),
                    axis.title = element_blank(),
                    axis.text=element_blank(),
                    axis.ticks=element_blank(),
                        plot.margin = unit(c(0, 0, 0.40, 0),"inches")) #add bottom-margin (top, right, bottom, left)

genome_completeness <- ehi_mags %>%
        ggplot(aes(x=completeness)) +
                xlim(c(70,100)) +
                geom_boxplot(colour = "#999999", fill="#cccccc") +
                theme_classic() +
                theme(legend.position = "none",
                    axis.line = element_blank(),
                    axis.title = element_blank(),
                    axis.text=element_blank(),
                    axis.ticks=element_blank(),
                    plot.margin = unit(c(0, 0, 0, 0.50),"inches")) #add left-margin (top, right, bottom, left)

#Render composite figure
#pdf("figures/completeness_contamination.pdf",width=10, height=5)
grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination),
        layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3),
                              c(2,2,2,2,2,2,2,2,2,2,2,3)))
```

Filter by completeness and contamination
```{r filtering}
ehi_mags_filtered <- ehi_mags %>%
  filter(completeness > 90, contamination < 2.5)
```



### Host classes
```{r count number of species in more than 2 host classes}
species_hostclass_counts <- ehi_mags_filtered %>%
  filter(!is.na(species), species != "") %>% 
  filter(!is.na(host_class), host_class != "") %>% 
  group_by(species) %>%
  summarise(
    n_mags = n(),
    n_host_classes = n_distinct(host_class),
    n_host_species = n_distinct(host_species),
    host_classes = paste(sort(unique(host_class)), collapse = ", "),
    host_species = paste(sort(unique(host_species)), collapse = ", "),
    phylum = paste(unique(phylum), collapse = ", ")
  ) %>%
  arrange(desc(n_host_classes))


species_selection_3 <- species_hostclass_counts %>%
  filter(n_host_classes >= 3)

species_selection_2 <- species_hostclass_counts %>%
  filter(n_host_classes >= 2)

species_selection_3 %>% arrange(-n_mags)
species_selection_2 %>% arrange(-n_mags)
```
```{r check the phylums}
species_selection_2 %>% group_by(phylum)%>%
  summarize(n_species = n())

species_selection_3 %>% group_by(phylum)%>%
  summarize(n_species = n())
```
### Host classes- after filtering
```{r count number of species in more than 2 host classes after filtering}
species_selection_f <- species_selection_2 %>%
  dplyr::filter(n_mags > 10) %>%
  arrange(desc(n_mags))

species_selection_f


species_selection_list<- species_selection_f %>% pull(species)
```

```{r phylum after filtering}
species_selection_f %>% group_by(phylum)%>%
  summarize(n_species = n())
```

### Count host classes per species
```{r count host classes per species}
counts_species_per_class<- species_selection_f %>% 
  group_by(n_host_classes)%>%
  summarize(n_species = n())

ggplot(counts_species_per_class, aes(x = n_host_classes, y = n_species)) +
  geom_col() +
  geom_text(
    aes(label = n_species),
    vjust = -0.3,            
    size = 4
  ) +
  labs(
    title = "Number of Species per Number of Host Classes",
    x = "Number of Host Classes",
    y = "Number of Species"
  ) +
  theme_bw()

```
```{r add the count data to the ehi mags}
mags_with_counts <- ehi_mags_filtered %>%
  left_join(species_hostclass_counts, by = "species")


#filter for mags with >1 host class
mags_host2 <- mags_with_counts %>%
  dplyr::filter(n_host_classes >= 2)

n_mags <- mags_host2 %>% 
  group_by(species) %>%
  summarise(n_mags = n(), .groups = "drop")

```





We have several MAGs per species, so here we select the "best MAG" (highest completeness and lowest contamination), to have statistics based on the best of each.
```{r best mags per species}
best_mag_per_species <- mags_host2 %>%
  filter(species %in% species_selection_list) %>%
  group_by(species) %>%
  arrange(desc(completeness), contamination) %>%
  slice_head(n = 1) %>%
  ungroup() %>%
  transmute(
    species,
    best_mag_name = mag_name,
    best_MAG_link = link_to_assembly,
    best_genome_size = size,
    best_completeness = completeness,
    best_contamination = contamination,
    best_N50 = N50,
    best_host_classes = host_class,  
    best_assembly_type = assembly_type, 
    best_phylum =str_remove_all(phylum.x, "p__")) 
  
```


```{r check genome size}
ggplot(best_mag_per_species, aes(x= species, y = best_genome_size, fill = best_phylum))+
  scale_color_manual(values=phylum_colors) +
  scale_fill_manual(values=phylum_colors) +
  geom_col()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90))
```



Filtering for Parabacteroides distasonis (make into a loop for all the relevant species later)
```{r pdist, eval = FALSE}
p_dist <- ehi_mags %>%
  filter(completeness >90,
         contamination < 2.5,
         species == "s__Parabacteroides distasonis")

write_tsv(p_dist, "data/mags_metadata/parabacteroides_distasonis_metadata.tsv")

p_dist_index <- p_dist %>%
  dplyr::select(ID, MAG_url)

write_tsv(p_dist_index, "data/mags_metadata/parabacteroides_distasonis_index.tsv")
```




```{r loop for all species, eval = FALSE}
species_selection_f <- c(
  "lactococcus_lactis",
  "hafnia_paralvei",
  "enterococcus_faecalis",
  "enterococcus_hirae",
  "bacteroides_uniformis",
  "phocaeicola_vulgatus",
  "parabacteroides_goldsteinii",
  "akkermansia_muciniphila",
  "bacteroides_fragilis",
  "providencia_rettgeri",
  "citrobacter_braakii"
)


ehi_mags_clean <- ehi_mags %>%
  mutate(
    species_clean = species %>% 
      str_replace("^s__", "") %>% 
      str_to_lower() %>% 
      str_replace_all(" ", "_")
  )


for (current_species in species_selection_f) {

  message("Processing ", current_species)

  species_data <- ehi_mags_clean %>%
    filter(
      completeness > 90,
      contamination < 2.5,
      species_clean == current_species
    )

  species_index <- species_data %>%
    dplyr::select(ID, MAG_url)

  filename <- current_species %>%
    str_replace("s__", "") %>%
    str_replace_all(" ", "_") %>%
    tolower()

  write_tsv(
    species_data,
    paste0("data/mags_metadata/", filename, "_metadata.tsv")
  )

  write_tsv(
    species_index,
    paste0("data/mags_metadata/", filename, "_index.tsv")
  )
}
```

```{r enterococcus hirae, eval = FALSE}
# Fix species name normalization (handles Enterococcus_B properly)
ehi_mags_clean <- ehi_mags %>%
  mutate(
    species_clean = species %>%
      str_remove("^s__") %>%
      str_to_lower() %>%
      str_replace_all("[^a-z0-9]+", "_") # replace spaces, punctuation, underscores
  )

# Show unique species so you can inspect normalization
unique(ehi_mags_clean$species_clean)

# Target species
target <- "enterococcus_b_hirae"

# Filter again using the improved cleaning
species_data <- ehi_mags_clean %>%
  filter(
    completeness > 90,
    contamination < 2.5,
    species_clean == target
  )

# Quick sanity check
print(nrow(species_data))
print(table(species_data$species_clean))

# Write EHI metadata for this species
write_tsv(species_data,
          "data/mags_metadata/enterococcus_hirae_metadata.tsv")


```


